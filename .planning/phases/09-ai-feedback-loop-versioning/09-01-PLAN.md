---
phase: 09-ai-feedback-loop-versioning
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/0043_meal_plan_versioning.sql
autonomous: true
requirements:
  - FEEDBACK-VERSIONING-01
must_haves:
  truths:
    - "meal_plans table has parent_plan_id FK column linking version children to their parent"
    - "meal_plan_feedback table has ai_draft_food_item_id and ai_draft_qty_g columns for storing the AI-suggested swap"
    - "meal_plan_feedback table has ai_draft_reasoning text column"
    - "Migration applies cleanly to Supabase with no FK errors"
  artifacts:
    - path: "supabase/migrations/0043_meal_plan_versioning.sql"
      provides: "parent_plan_id FK on meal_plans, ai draft columns on meal_plan_feedback"
      contains: "ALTER TABLE public.meal_plans ADD COLUMN IF NOT EXISTS parent_plan_id"
  key_links:
    - from: "meal_plans.parent_plan_id"
      to: "meal_plans.id"
      via: "self-referential FK ON DELETE SET NULL"
      pattern: "REFERENCES public.meal_plans\\(id\\)"
---

<objective>
Add versioning columns to the existing `meal_plans` table and AI draft storage columns to `meal_plan_feedback`.

Purpose: Phases 02-04 need `meal_plans.parent_plan_id` to build the version chain and `meal_plan_feedback.ai_draft_*` columns to store the Claude-suggested food swap so the coach review UI can display it.

Output: Migration file `0043_meal_plan_versioning.sql` applied to Supabase.
</objective>

<execution_context>
@C:/Users/Troy Morgan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Troy Morgan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-client-portal-nutrition-view/08-01-SUMMARY.md

<interfaces>
<!-- Existing meal_plans schema (from 0041_nutrition_foundation.sql): -->
```sql
CREATE TABLE IF NOT EXISTS public.meal_plans (
  id            uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id        uuid NOT NULL REFERENCES public.orgs(id) ON DELETE CASCADE,
  client_id     uuid REFERENCES public.clients(id) ON DELETE SET NULL,
  created_by    uuid REFERENCES auth.users(id) ON DELETE SET NULL,
  name          text NOT NULL,
  start_date    date,
  end_date      date,
  status        text NOT NULL DEFAULT 'draft' CHECK (status IN ('draft', 'published')),
  version       integer NOT NULL DEFAULT 1,
  published_at  timestamptz,
  created_at    timestamptz DEFAULT now(),
  updated_at    timestamptz DEFAULT now()
);
```

<!-- Existing meal_plan_feedback schema (from 0042_meal_plan_feedback.sql): -->
```sql
CREATE TABLE IF NOT EXISTS public.meal_plan_feedback (
  id            uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  plan_id       uuid NOT NULL REFERENCES public.meal_plans(id) ON DELETE CASCADE,
  meal_id       uuid REFERENCES public.meal_plan_meals(id) ON DELETE SET NULL,
  client_id     uuid NOT NULL REFERENCES public.clients(id) ON DELETE CASCADE,
  type          text NOT NULL CHECK (type IN ('substitution','dislike','allergy','portion','schedule','other')),
  scope         text NOT NULL CHECK (scope IN ('this_meal','going_forward','all_occurrences')),
  comment       text,
  forward       text CHECK (forward IN ('yes','no','ask_me') OR forward IS NULL),
  status        text NOT NULL DEFAULT 'pending' CHECK (status IN ('pending','reviewed')),
  created_at    timestamptz NOT NULL DEFAULT now()
);
```

<!-- Migration pattern from Phase 8 (0042): -->
- Migration path: supabase/migrations/ (project root, NOT apps/trainer-web/supabase/migrations/)
- Apply via Supabase Management API (POST /v1/projects/ntqdmgvxirswnjlnwopq/database/query)
- Supabase PAT from Windows Credential Manager via Python ctypes (see 08-01-SUMMARY.md)
- Use DO $$ BEGIN ... EXCEPTION WHEN duplicate_object THEN NULL; END $$ for idempotent policy creation
- Use IF NOT EXISTS / IF EXISTS for idempotent DDL
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration 0043 — versioning columns</name>
  <files>supabase/migrations/0043_meal_plan_versioning.sql</files>
  <action>
Create `supabase/migrations/0043_meal_plan_versioning.sql` with these two ALTER TABLE statements:

**1. `meal_plans.parent_plan_id` — self-referential FK for version chain:**
```sql
ALTER TABLE public.meal_plans
  ADD COLUMN IF NOT EXISTS parent_plan_id uuid REFERENCES public.meal_plans(id) ON DELETE SET NULL;

CREATE INDEX IF NOT EXISTS idx_meal_plans_parent_plan_id ON public.meal_plans(parent_plan_id);
```
- `ON DELETE SET NULL` — if the parent plan is deleted, children keep their data but lose the link (safe)
- Only new versioned plans have this set; v1 originals have `parent_plan_id = NULL`

**2. `meal_plan_feedback` AI draft columns — store the Claude-suggested swap:**
```sql
ALTER TABLE public.meal_plan_feedback
  ADD COLUMN IF NOT EXISTS ai_draft_food_item_id uuid REFERENCES public.food_items(id) ON DELETE SET NULL,
  ADD COLUMN IF NOT EXISTS ai_draft_qty_g numeric(8,2),
  ADD COLUMN IF NOT EXISTS ai_draft_reasoning text;
```
- `ai_draft_food_item_id` — the AFCD food Claude suggests as the replacement
- `ai_draft_qty_g` — the adjusted quantity to match original macros
- `ai_draft_reasoning` — plain-text explanation from Claude (e.g. "Swapping chicken thigh for salmon to increase omega-3; 120g matches 22g protein target")
- All nullable — draft is only populated after the coach triggers the AI draft endpoint (Plan 02)

After creating the file, apply the migration via Supabase Management API:
- POST https://api.supabase.com/v1/projects/ntqdmgvxirswnjlnwopq/database/query
- Retrieve PAT via Python ctypes from Windows Credential Manager (credential name: "Supabase CLI:supabase")
- Verify success: SELECT column_name FROM information_schema.columns WHERE table_name = 'meal_plans' AND column_name = 'parent_plan_id' — must return 1 row
- Verify feedback columns: SELECT column_name FROM information_schema.columns WHERE table_name = 'meal_plan_feedback' AND column_name LIKE 'ai_draft%' — must return 3 rows
  </action>
  <verify>
    <automated>python -c "
import os, sys

# Step 1: Verify migration file content
path = 'C:/Users/Troy Morgan/OneDrive/coach-os/supabase/migrations/0043_meal_plan_versioning.sql'
assert os.path.exists(path), 'Migration file missing at ' + path
content = open(path).read()
assert 'parent_plan_id' in content, 'parent_plan_id missing from migration'
assert 'ai_draft_food_item_id' in content, 'ai_draft_food_item_id missing from migration'
assert 'ai_draft_qty_g' in content, 'ai_draft_qty_g missing from migration'
assert 'ai_draft_reasoning' in content, 'ai_draft_reasoning missing from migration'
print('Migration file content: OK')

# Step 2: Verify columns exist in Supabase DB via Management API
import ctypes, json
try:
    import urllib.request
    # Retrieve PAT from Windows Credential Manager
    advapi32 = ctypes.windll.advapi32
    class CREDENTIAL(ctypes.Structure):
        _fields_ = [
            ('Flags', ctypes.c_ulong), ('Type', ctypes.c_ulong),
            ('TargetName', ctypes.c_wchar_p), ('Comment', ctypes.c_wchar_p),
            ('LastWritten', ctypes.c_ulonglong), ('CredentialBlobSize', ctypes.c_ulong),
            ('CredentialBlob', ctypes.c_char_p), ('Persist', ctypes.c_ulong),
            ('AttributeCount', ctypes.c_ulong), ('Attributes', ctypes.c_void_p),
            ('TargetAlias', ctypes.c_wchar_p), ('UserName', ctypes.c_wchar_p),
        ]
    cred_ptr = ctypes.pointer(CREDENTIAL())
    ok = advapi32.CredReadW('Supabase CLI:supabase', 1, 0, ctypes.byref(cred_ptr))
    if not ok:
        print('WARNING: Could not retrieve Supabase PAT from Credential Manager — skipping DB check')
        sys.exit(0)
    pat = cred_ptr.contents.CredentialBlob[:cred_ptr.contents.CredentialBlobSize].decode('utf-16-le')
    # Check meal_plans.parent_plan_id
    sql1 = \"SELECT count(*) as cnt FROM information_schema.columns WHERE table_name = 'meal_plans' AND column_name = 'parent_plan_id'\"
    req1 = urllib.request.Request(
        'https://api.supabase.com/v1/projects/ntqdmgvxirswnjlnwopq/database/query',
        data=json.dumps({'query': sql1}).encode(),
        headers={'Authorization': 'Bearer ' + pat, 'Content-Type': 'application/json'},
        method='POST'
    )
    resp1 = json.loads(urllib.request.urlopen(req1).read())
    cnt1 = int(resp1[0]['cnt'] if isinstance(resp1, list) else resp1.get('cnt', 0))
    assert cnt1 == 1, f'meal_plans.parent_plan_id not found in DB (got {cnt1} rows)'
    print('DB check meal_plans.parent_plan_id: OK')
    # Check meal_plan_feedback ai_draft columns (expect 3)
    sql2 = \"SELECT count(*) as cnt FROM information_schema.columns WHERE table_name = 'meal_plan_feedback' AND column_name LIKE 'ai_draft%'\"
    req2 = urllib.request.Request(
        'https://api.supabase.com/v1/projects/ntqdmgvxirswnjlnwopq/database/query',
        data=json.dumps({'query': sql2}).encode(),
        headers={'Authorization': 'Bearer ' + pat, 'Content-Type': 'application/json'},
        method='POST'
    )
    resp2 = json.loads(urllib.request.urlopen(req2).read())
    cnt2 = int(resp2[0]['cnt'] if isinstance(resp2, list) else resp2.get('cnt', 0))
    assert cnt2 == 3, f'Expected 3 ai_draft columns in meal_plan_feedback, got {cnt2}'
    print('DB check meal_plan_feedback ai_draft columns (3): OK')
except Exception as e:
    print(f'DB verification error: {e}')
    print('If migration was applied successfully via API, this may be a verify-script issue — check manually.')
    sys.exit(1)
" 2>&1</automated>
  </verify>
  <done>Migration 0043 file exists at supabase/migrations/0043_meal_plan_versioning.sql. Applied to Supabase successfully (API returns 200/201). Column checks confirm: parent_plan_id on meal_plans (1 row), ai_draft_* on meal_plan_feedback (3 rows).</done>
</task>

</tasks>

<verification>
- `supabase/migrations/0043_meal_plan_versioning.sql` exists and contains all 4 new columns
- Migration applied to Supabase project ntqdmgvxirswnjlnwopq
- `information_schema.columns` confirms via Management API: `meal_plans.parent_plan_id` exists (1 row), `meal_plan_feedback.ai_draft_food_item_id`, `ai_draft_qty_g`, `ai_draft_reasoning` all exist (3 rows)
</verification>

<success_criteria>
DB is ready for Phase 9: parent_plan_id enables version chaining, ai_draft_* columns enable AI swap storage on existing feedback rows.
</success_criteria>

<output>
After completion, create `.planning/phases/09-ai-feedback-loop-versioning/09-01-SUMMARY.md`
</output>
