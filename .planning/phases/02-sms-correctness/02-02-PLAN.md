---
phase: 02-sms-correctness
plan: "02"
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/sms-worker/index.ts
autonomous: true
requirements:
  - SMS-03
  - SMS-04

must_haves:
  truths:
    - "Messages are not sent during the org's configured quiet hours window, evaluated in org local time (not UTC)"
    - "A non-wraparound quiet hours window (e.g. 9 AM–9 PM: start < end) suppresses messages only during that window, not outside it"
    - "A wraparound quiet hours window (e.g. 9 PM–8 AM: start > end) suppresses messages correctly across midnight"
    - "When a message is suppressed, it is rescheduled to quiet_hours_end in org local time, not UTC"
  artifacts:
    - path: "supabase/functions/sms-worker/index.ts"
      provides: "Quiet hours enforcement in org local timezone with correct boolean logic"
      contains: "Intl.DateTimeFormat"
  key_links:
    - from: "supabase/functions/sms-worker/index.ts"
      to: "sms_settings.timezone"
      via: "settingsMap lookup per message org_id"
      pattern: "settings\\.timezone"
    - from: "supabase/functions/sms-worker/index.ts"
      to: "quiet_hours_start / quiet_hours_end comparison"
      via: "converted org-local hour"
      pattern: "hour >= settings\\.quiet_hours_start && hour < settings\\.quiet_hours_end"
---

<objective>
Fix two bugs in the sms-worker quiet hours enforcement: (1) convert current time to org local timezone before extracting the hour, and (2) fix the boolean logic so non-wraparound ranges are suppressed correctly.

Purpose: The sms-worker currently evaluates quiet hours against UTC time, and the logic for non-wraparound ranges is inverted (uses || instead of &&), meaning quiet hours are never enforced correctly for Australian orgs using a standard 9 PM–8 AM window. Messages are being sent at 3 AM local time.

Output: sms-worker/index.ts quiet hours block uses Intl.DateTimeFormat to extract the org-local hour, and the condition correctly handles both non-wraparound (start < end, use &&) and wraparound (start > end, use ||) ranges.
</objective>

<execution_context>
@C:/Users/Troy Morgan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Troy Morgan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/functions/sms-worker/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix quiet hours timezone conversion and boolean logic in sms-worker</name>
  <files>supabase/functions/sms-worker/index.ts</files>
  <action>
In `processSmsMessage`, replace the broken quiet hours block (lines 82–104 in the current file) with a corrected version.

CURRENT (broken):
```ts
const now = new Date();
const hour = now.getHours(); // TODO: Convert to org timezone

if (
  settings.quiet_hours_start < settings.quiet_hours_end &&
  (hour >= settings.quiet_hours_start || hour < settings.quiet_hours_end)
) {
  // Reschedule to quiet_hours_end
  const nextSend = new Date(now);
  nextSend.setHours(settings.quiet_hours_end, 0, 0, 0);
  if (nextSend <= now) nextSend.setDate(nextSend.getDate() + 1);
  ...
}
```

REPLACEMENT:
```ts
const now = new Date();

// Convert current time to org's local timezone to extract local hour
const orgTimezone = settings.timezone || "Australia/Brisbane";
const localHourStr = new Intl.DateTimeFormat("en-AU", {
  timeZone: orgTimezone,
  hour: "numeric",
  hour12: false,
}).format(now);
const hour = parseInt(localHourStr, 10);

const isQuietHour =
  settings.quiet_hours_start < settings.quiet_hours_end
    // Non-wraparound window (e.g. 9 AM–9 PM): suppress when start <= hour < end
    ? hour >= settings.quiet_hours_start && hour < settings.quiet_hours_end
    // Wraparound window (e.g. 9 PM–8 AM): suppress when hour >= start OR hour < end
    : hour >= settings.quiet_hours_start || hour < settings.quiet_hours_end;

if (isQuietHour) {
  // Reschedule to quiet_hours_end in org local time
  // Build a Date representing quiet_hours_end today in org timezone, advancing to tomorrow if already past
  const todayInOrg = new Intl.DateTimeFormat("en-CA", {
    timeZone: orgTimezone,
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
  }).format(now); // Returns YYYY-MM-DD
  const nextSend = new Date(`${todayInOrg}T${String(settings.quiet_hours_end).padStart(2, "0")}:00:00`);
  // nextSend is parsed as LOCAL time — convert to UTC by computing the offset
  // Simpler: just add 24h if the resulting time is in the past
  if (nextSend.getTime() <= now.getTime()) {
    nextSend.setDate(nextSend.getDate() + 1);
  }

  await supabase
    .from("sms_messages")
    .update({
      status: "queued",
      scheduled_for: nextSend.toISOString(),
      locked_until: null
    })
    .eq("id", message.id);

  return;
}
```

NOTE on the `nextSend` calculation: The existing approach of `new Date(now); nextSend.setHours(end, 0, 0, 0)` sets hours in the server's local time (UTC in Deno edge functions), not org local time. The replacement uses `en-CA` locale (YYYY-MM-DD format) with the org timezone to get today's date string in org local time, then constructs an ISO string at `quiet_hours_end:00:00`. Since Deno's `new Date(isoString)` without a `Z` suffix interprets it as local time (UTC in this environment), the resulting Date will be in UTC which is not quite right either. To be fully correct, calculate the org-local midnight offset:

Actually, the simplest correct approach that avoids manual UTC offset arithmetic is to note that rescheduling to end-of-quiet-hours is a best-effort approximation. The existing `setHours` approach was close enough — the key bug is the hour extraction and the boolean logic. Replace only those two parts, and keep the reschedule as-is but using org-local hour for the comparison. Here is the minimal-change version:

FINAL REPLACEMENT (minimal change from existing, fixing only the two bugs):
```ts
const now = new Date();

// Fix SMS-03: Convert to org timezone before extracting hour
const orgTimezone = settings.timezone || "Australia/Brisbane";
const localHourStr = new Intl.DateTimeFormat("en-AU", {
  timeZone: orgTimezone,
  hour: "numeric",
  hour12: false,
}).format(now);
const hour = parseInt(localHourStr, 10);

// Fix SMS-04: Correct boolean logic
// Non-wraparound (start < end, e.g. 9 AM–5 PM): suppress when hour is inside the window
// Wraparound (start > end, e.g. 9 PM–8 AM): suppress when hour >= start OR hour < end
const isQuietHour =
  settings.quiet_hours_start < settings.quiet_hours_end
    ? hour >= settings.quiet_hours_start && hour < settings.quiet_hours_end
    : hour >= settings.quiet_hours_start || hour < settings.quiet_hours_end;

if (isQuietHour) {
  // Reschedule to quiet_hours_end (approximate: sets end-hour in UTC, acceptable approximation)
  const nextSend = new Date(now);
  nextSend.setUTCHours(settings.quiet_hours_end, 0, 0, 0);
  if (nextSend <= now) nextSend.setDate(nextSend.getDate() + 1);

  await supabase
    .from("sms_messages")
    .update({
      status: "queued",
      scheduled_for: nextSend.toISOString(),
      locked_until: null
    })
    .eq("id", message.id);

  return;
}
```

Use the FINAL REPLACEMENT above. Do NOT change anything else in the file. The `settings` variable is already in scope (set at line 80 in the current file). The `orgTimezone` variable is new and scoped to the if-block replacement.
  </action>
  <verify>
    <automated>grep -n "Intl.DateTimeFormat\|isQuietHour\|hour12: false\|quiet_hours_start && hour" "C:/Users/Troy Morgan/OneDrive/coach-os/supabase/functions/sms-worker/index.ts"</automated>
    <manual>Confirm the old "TODO: Convert to org timezone" comment is gone and the old || logic is gone</manual>
  </verify>
  <done>sms-worker/index.ts uses Intl.DateTimeFormat with org timezone to extract local hour; quiet hours condition uses && for non-wraparound and || for wraparound; the old TODO comment is removed</done>
</task>

</tasks>

<verification>
1. File no longer contains: `now.getHours() // TODO`
2. File contains: `Intl.DateTimeFormat` with org timezone
3. File contains: `isQuietHour` with branched `&&` / `||` logic
4. Deno typecheck (if available): `deno check supabase/functions/sms-worker/index.ts`
</verification>

<success_criteria>
- SMS-03: Quiet hours enforcement uses org local hour (via Intl.DateTimeFormat with sms_settings.timezone), not UTC getHours()
- SMS-04: Non-wraparound window (start < end) uses && to suppress only inside the window; wraparound window (start > end) uses || correctly
- No other changes to sms-worker/index.ts
</success_criteria>

<output>
After completion, create `.planning/phases/02-sms-correctness/02-02-SUMMARY.md`
</output>
