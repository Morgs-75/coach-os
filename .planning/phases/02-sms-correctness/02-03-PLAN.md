---
phase: 02-sms-correctness
plan: "03"
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/trainer-web/src/app/api/sms-inbound/route.ts
  - apps/trainer-web/src/app/api/sms/webhook/route.ts
  - supabase/functions/sms-inbound/index.ts
autonomous: true
requirements:
  - SMS-05

must_haves:
  truths:
    - "A client replying Y to a confirmation SMS sets client_confirmed=true on the correct upcoming booking"
    - "Only one active handler processes inbound Y replies — the Netlify route at /api/sms-inbound"
    - "The dead /api/sms/webhook handler cannot accidentally confirm bookings (column mismatch IS NULL vs false is documented/disabled)"
    - "The inactive supabase/functions/sms-inbound edge function cannot accidentally confirm bookings"
    - "The active handler prefers the nearest upcoming booking when multiple unconfirmed bookings exist"
  artifacts:
    - path: "apps/trainer-web/src/app/api/sms-inbound/route.ts"
      provides: "Active inbound Y-reply handler with tightened booking query"
      contains: "start_time"
    - path: "apps/trainer-web/src/app/api/sms/webhook/route.ts"
      provides: "Dead handler clearly disabled with comment explaining why"
      contains: "DISABLED"
    - path: "supabase/functions/sms-inbound/index.ts"
      provides: "Inactive edge function clearly disabled with comment explaining why"
      contains: "DISABLED"
  key_links:
    - from: "apps/trainer-web/src/app/api/sms-inbound/route.ts"
      to: "bookings table"
      via: "supabase query with start_time >= now() filter"
      pattern: "gte.*start_time.*new Date"
---

<objective>
Consolidate the three inbound Y-reply handlers to a single correct one. Tighten the active handler's booking query to prefer the nearest upcoming (future) booking. Disable the two dead/inactive paths with clear comments explaining why they are disabled.

Purpose: Three handlers exist for client Y replies but only one is wired to Twilio. The dead handler (/api/sms/webhook) will never match bookings because it queries client_confirmed IS NULL on a column that defaults to false. The inactive edge function (supabase/functions/sms-inbound) is not connected to Twilio. The active handler has a subtle 24h lookback that can match a past booking after midnight. Consolidating to one path and tightening the query prevents silent confirmation failures and wrong-booking confirmations.

Output: /api/sms-inbound is the sole active handler with a corrected future-only booking query; the other two paths are disabled with explanatory comments.
</objective>

<execution_context>
@C:/Users/Troy Morgan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Troy Morgan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/trainer-web/src/app/api/sms-inbound/route.ts
@apps/trainer-web/src/app/api/sms/webhook/route.ts
@supabase/functions/sms-inbound/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Tighten the active /api/sms-inbound booking query to prefer nearest upcoming booking</name>
  <files>apps/trainer-web/src/app/api/sms-inbound/route.ts</files>
  <action>
The active handler at `apps/trainer-web/src/app/api/sms-inbound/route.ts` is correct overall but has a subtle bug in the booking query: it uses `.gte("start_time", new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString())` which looks back 24 hours and can match a booking from yesterday when the client replies after midnight.

Fix: change the booking query filter from the 24h lookback to prefer nearest upcoming booking (start_time >= now). Keep a small grace period of 2 hours in the past to handle clients who reply shortly after a session started, but eliminate the 24h window that reaches back to yesterday.

CURRENT booking query (lines 39-49):
```ts
const { data: booking, error: bookingError } = await supabase
  .from("bookings")
  .select("id, start_time")
  .eq("client_id", client.id)
  .eq("status", "confirmed")
  .eq("client_confirmed", false)
  .not("confirmation_sent_at", "is", null)
  .gte("start_time", new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString())
  .order("start_time", { ascending: true })
  .limit(1)
  .maybeSingle();
```

REPLACEMENT:
```ts
// Prefer nearest upcoming session; allow 2-hour grace for replies arriving just after session start
const twoHoursAgo = new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString();
const { data: booking, error: bookingError } = await supabase
  .from("bookings")
  .select("id, start_time")
  .eq("client_id", client.id)
  .eq("status", "confirmed")
  .eq("client_confirmed", false)
  .not("confirmation_sent_at", "is", null)
  .gte("start_time", twoHoursAgo)
  .order("start_time", { ascending: true })
  .limit(1)
  .maybeSingle();
```

Also fix the identical query for `nextBooking` (lines 86-96) the same way — replace the 24h lookback with `twoHoursAgo`. The `twoHoursAgo` variable is already in scope from the first query.

Do NOT change anything else in the file.
  </action>
  <verify>
    <automated>cd "C:/Users/Troy Morgan/OneDrive/coach-os/apps/trainer-web" && npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Confirm old 24h lookback is gone: grep -n "24 \* 60 \* 60" apps/trainer-web/src/app/api/sms-inbound/route.ts should return no matches</manual>
  </verify>
  <done>The active /api/sms-inbound handler queries bookings with start_time >= now - 2h (not now - 24h); TypeScript compiles without new errors</done>
</task>

<task type="auto">
  <name>Task 2: Disable the dead /api/sms/webhook handler and the inactive supabase/functions/sms-inbound edge function</name>
  <files>
    apps/trainer-web/src/app/api/sms/webhook/route.ts
    supabase/functions/sms-inbound/index.ts
  </files>
  <action>
**File 1: `apps/trainer-web/src/app/api/sms/webhook/route.ts`**

This handler is dead — it queries `client_confirmed IS NULL` but the column defaults to `false`, so it can never match any booking. Twilio does not point at this URL. Disable the confirmation logic by replacing the booking confirmation block with an early return that returns TwiML and logs a clear message.

Replace the `isConfirmation` block (lines 48-86) with:
```ts
if (isConfirmation) {
  // DISABLED: This handler is inactive. Twilio inbound webhook points to /api/sms-inbound.
  // This route queried client_confirmed IS NULL but the column defaults to false — it could
  // never match a booking. Keeping the route to avoid 404s on any stray Twilio retries,
  // but confirmation is handled exclusively by /api/sms-inbound.
  console.log("SMS webhook /api/sms/webhook: confirmation reply received but handler is disabled — use /api/sms-inbound");
}
```

Keep the rest of the file (non-confirmation incoming SMS logging, message thread write) unchanged — these parts still work and do not conflict with the active handler.

**File 2: `supabase/functions/sms-inbound/index.ts`**

This edge function is not registered as the Twilio webhook URL (the Netlify route is). Disable the Y-reply handling to prevent it from being accidentally re-enabled. Replace the Y/YES handler block (lines 27-79) with:

```ts
// DISABLED: This edge function is not registered as the Twilio inbound webhook.
// The active inbound handler is the Netlify route at /api/sms-inbound.
// Keeping this file to preserve the function deployment, but confirmation logic
// is disabled to prevent divergent confirmation if this URL is ever mistakenly used.
if (messageBody === "Y" || messageBody === "YES") {
  console.log("sms-inbound edge function: Y reply received but handler is disabled — Twilio should point to /api/sms-inbound");
  return twiml("");
}
```

Do NOT delete either file — just disable the booking confirmation logic with comments explaining why.
  </action>
  <verify>
    <automated>grep -n "DISABLED\|inactive\|/api/sms-inbound" "C:/Users/Troy Morgan/OneDrive/coach-os/apps/trainer-web/src/app/api/sms/webhook/route.ts" "C:/Users/Troy Morgan/OneDrive/coach-os/supabase/functions/sms-inbound/index.ts"</automated>
    <manual>Confirm neither disabled file contains an active .update({ client_confirmed: true }) call: grep -n "client_confirmed: true" apps/trainer-web/src/app/api/sms/webhook/route.ts supabase/functions/sms-inbound/index.ts</manual>
  </verify>
  <done>Both dead/inactive handlers contain DISABLED comment blocks; neither can update client_confirmed on a booking; the active /api/sms-inbound route is unchanged</done>
</task>

</tasks>

<verification>
1. TypeScript build: `cd apps/trainer-web && npx tsc --noEmit` — no new errors
2. Active handler tightened: `grep "twoHoursAgo" apps/trainer-web/src/app/api/sms-inbound/route.ts` — matches
3. Dead handler disabled: `grep "DISABLED" apps/trainer-web/src/app/api/sms/webhook/route.ts` — matches
4. Inactive edge function disabled: `grep "DISABLED" supabase/functions/sms-inbound/index.ts` — matches
5. Only the active handler still has `client_confirmed: true` update logic
</verification>

<success_criteria>
- SMS-05: Exactly one handler (/api/sms-inbound) can update client_confirmed=true on a booking
- The active handler uses a 2-hour grace window instead of the 24-hour lookback
- The dead /api/sms/webhook handler has a clear DISABLED comment explaining the column mismatch
- The inactive supabase/functions/sms-inbound has a clear DISABLED comment explaining it's not the registered Twilio URL
- Zero TypeScript errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/02-sms-correctness/02-03-SUMMARY.md`
</output>
