---
phase: 04-ui-reliability
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/trainer-web/src/app/(app)/calendar/page.tsx
autonomous: true
requirements:
  - UI-02

must_haves:
  truths:
    - "In day view, the 15-second poll queries only the current day's range (00:00–23:59:59 of currentDate)"
    - "In month view, the poll queries the full visible month range (month start to month+1 start)"
    - "In week view, the poll continues to query the 7-day weekStart range (existing behavior, unchanged)"
    - "Switching view mode (day/week/month) resets the poll and fires an immediate query for the new range"
    - "Navigating prev/next (changing currentDate) resets the poll and fires an immediate query for the new range"
    - "Poll is silent — no spinner or refresh indicator"
    - "If the poll fails, it stops until the next reset — no warning shown"
  artifacts:
    - path: "apps/trainer-web/src/app/(app)/calendar/page.tsx"
      provides: "View-aware confirmation poll with immediate-fire on reset"
      contains: "pollKey"
  key_links:
    - from: "viewMode + currentDate state"
      to: "poll useEffect dependency array"
      via: "pollKey or direct deps that include viewMode and currentDate"
      pattern: "useEffect.*pollKey|useEffect.*viewMode.*currentDate"
    - from: "poll range logic"
      to: "loadData() range logic"
      via: "same rangeStart/rangeEnd derivation (day/week/month)"
      pattern: "rangeStart.*currentDate|rangeEnd.*currentDate"
---

<objective>
Fix the calendar's 15-second confirmation poll to query the correct date range for the active view, and reset immediately on any navigation.

Purpose: The poll currently always queries a fixed 7-day weekStart range regardless of view mode. In day view this returns 6 extra days of data; in month view it misses most of the month. Trainers in day or month view never see confirmation updates for visible bookings.

Output: Modified calendar/page.tsx where the poll useEffect derives rangeStart/rangeEnd using the same view-aware logic as loadData(), and resets (fires immediately) whenever viewMode or currentDate changes.
</objective>

<execution_context>
@C:/Users/Troy Morgan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Troy Morgan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/04-ui-reliability/04-CONTEXT.md

Key file: apps/trainer-web/src/app/(app)/calendar/page.tsx

Current state of the poll (lines 163-184):

```tsx
// Poll every 15 seconds for confirmation updates
useEffect(() => {
  if (!orgId) return;
  const interval = setInterval(async () => {
    const rangeStart = new Date(weekStart);
    const rangeEnd = new Date(weekStart);
    rangeEnd.setDate(rangeEnd.getDate() + 7);
    const { data } = await supabase
      .from("bookings")
      .select("id, client_confirmed, confirmation_sent_at, status")
      .eq("org_id", orgId)
      .gte("start_time", rangeStart.toISOString())
      .lt("start_time", rangeEnd.toISOString());
    if (data) {
      setBookings((prev) => prev.map((b) => {
        const updated = data.find((d: any) => d.id === b.id);
        return updated ? { ...b, ...updated } : b;
      }));
    }
  }, 15000);
  return () => clearInterval(interval);
}, [orgId, weekStart]);
```

Bug: Range is always `weekStart` to `weekStart+7`, regardless of `viewMode`. Effect only resets when `orgId` or `weekStart` changes — switching to day view (same week) or month view does NOT reset it.

The correct range logic already exists in `loadData()` (lines 200-214):
```tsx
if (viewMode === "day") {
  rangeStart = new Date(currentDate);
  rangeStart.setHours(0, 0, 0, 0);
  rangeEnd = new Date(currentDate);
  rangeEnd.setHours(23, 59, 59, 999);
} else if (viewMode === "month") {
  rangeStart = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
  rangeEnd = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
} else {
  rangeStart = new Date(weekStart);
  rangeEnd = new Date(weekStart);
  rangeEnd.setDate(rangeEnd.getDate() + 7);
}
```

Navigation state:
- Line 69: `const [currentDate, setCurrentDate] = useState(new Date())`
- Line 110: `const [viewMode, setViewMode] = useState<"day" | "week" | "month">("week")`
- Lines 935-967: prev/next buttons call `setCurrentDate(d)` — this already changes `currentDate`
- Lines 807-820: view mode buttons call `setViewMode(mode)`
- Line 117-124: `weekStart` is derived from `currentDate` via useMemo

Decision from 04-CONTEXT.md (locked):
- Any navigation resets the poll: view-mode switch AND next/prev navigation trigger immediate re-query
- On reset: FIRE IMMEDIATELY for new range, then resume 15-second cycle
- Silent poll — no spinner
- Silent failure — if poll fails, stop until next navigation; no warning shown
- Tab/page visibility: Claude's discretion (use Page Visibility API if it fits cleanly, otherwise keep simple)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix poll useEffect — view-aware range and immediate-fire on navigation</name>
  <files>apps/trainer-web/src/app/(app)/calendar/page.tsx</files>
  <action>
Replace the existing poll `useEffect` (lines 163-184) with a corrected version that:
1. Uses the same range logic as `loadData()` (day/month/week)
2. Fires immediately when the effect mounts (so navigation triggers instant update before the 15s timer)
3. Resets whenever `orgId`, `viewMode`, or `currentDate` changes (not just `weekStart`)

**Step 1 — Add `pollKey` state** to force immediate reset on navigation events. Add this near the other state declarations (around line 75):

```tsx
const [pollKey, setPollKey] = useState(0);
```

**Step 2 — Update the view mode buttons** (around line 810) to also bump pollKey:

```tsx
onClick={() => { setViewMode(mode); setPollKey(k => k + 1); }}
```

**Step 3 — Update the prev/next navigation buttons** (lines ~934-967) to also bump pollKey:

```tsx
// prev button onClick:
onClick={() => {
  const d = new Date(currentDate);
  if (viewMode === "day") d.setDate(d.getDate() - 1);
  else if (viewMode === "week") d.setDate(d.getDate() - 7);
  else d.setMonth(d.getMonth() - 1);
  setCurrentDate(d);
  setPollKey(k => k + 1);
}}

// Today button onClick:
onClick={() => { setCurrentDate(new Date()); setPollKey(k => k + 1); }}

// next button onClick:
onClick={() => {
  const d = new Date(currentDate);
  if (viewMode === "day") d.setDate(d.getDate() + 1);
  else if (viewMode === "week") d.setDate(d.getDate() + 7);
  else d.setMonth(d.getMonth() + 1);
  setCurrentDate(d);
  setPollKey(k => k + 1);
}}
```

**Step 4 — Replace the poll useEffect** entirely. The new version:
- Derives rangeStart/rangeEnd using the same view-aware logic as loadData()
- Fires a poll immediately on mount (before starting the interval)
- Then starts the 15-second interval
- Depends on `[orgId, viewMode, currentDate, pollKey]`

```tsx
// Poll every 15 seconds for confirmation updates
useEffect(() => {
  if (!orgId) return;

  function getRangeForPoll(): { rangeStart: Date; rangeEnd: Date } {
    let rangeStart: Date;
    let rangeEnd: Date;
    if (viewMode === "day") {
      rangeStart = new Date(currentDate);
      rangeStart.setHours(0, 0, 0, 0);
      rangeEnd = new Date(currentDate);
      rangeEnd.setHours(23, 59, 59, 999);
    } else if (viewMode === "month") {
      rangeStart = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
      rangeEnd = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
    } else {
      rangeStart = new Date(weekStart);
      rangeEnd = new Date(weekStart);
      rangeEnd.setDate(rangeEnd.getDate() + 7);
    }
    return { rangeStart, rangeEnd };
  }

  async function doPoll() {
    const { rangeStart, rangeEnd } = getRangeForPoll();
    const { data } = await supabase
      .from("bookings")
      .select("id, client_confirmed, confirmation_sent_at, status")
      .eq("org_id", orgId)
      .gte("start_time", rangeStart.toISOString())
      .lt("start_time", rangeEnd.toISOString());
    if (data) {
      setBookings((prev) => prev.map((b) => {
        const updated = data.find((d: any) => d.id === b.id);
        return updated ? { ...b, ...updated } : b;
      }));
    }
  }

  // Fire immediately for the current range, then start 15s interval
  doPoll();
  const interval = setInterval(doPoll, 15000);
  return () => clearInterval(interval);
}, [orgId, viewMode, currentDate, pollKey]);
```

Note: `weekStart` is a derived value from `currentDate` — including `currentDate` in deps is sufficient. `weekStart` does not need to be a dep since it changes only when `currentDate` changes (and we already have `currentDate` in deps). This avoids a stale closure on `weekStart`.

Do NOT add Page Visibility API — keep it simple per the discretion note in CONTEXT.md.

**What NOT to change:**
- `loadData()` function — no changes needed
- The `useEffect(() => { loadData(); }, [currentDate, viewMode])` effect — leave as-is
- Any other part of the calendar component
- The `weekStart` useMemo
  </action>
  <verify>
    <automated>cd "C:/Users/Troy Morgan/OneDrive/coach-os" && npx tsc --noEmit -p apps/trainer-web/tsconfig.json 2>&1 | head -20</automated>
    <automated>grep -n "pollKey\|getRangeForPoll\|doPoll\|viewMode.*currentDate\|orgId.*viewMode" "apps/trainer-web/src/app/(app)/calendar/page.tsx" | head -20</automated>
  </verify>
  <done>TypeScript compiles clean. File contains pollKey state, getRangeForPoll function inside the poll useEffect, doPoll called immediately before setInterval, and the useEffect dependency array includes orgId, viewMode, currentDate, and pollKey. Nav buttons call setPollKey(k => k + 1).</done>
</task>

</tasks>

<verification>
grep -n "pollKey" apps/trainer-web/src/app/(app)/calendar/page.tsx
grep -n "getRangeForPoll\|doPoll" apps/trainer-web/src/app/(app)/calendar/page.tsx
grep -n "orgId.*viewMode.*currentDate\|currentDate.*viewMode.*orgId" apps/trainer-web/src/app/(app)/calendar/page.tsx
</verification>

<success_criteria>
- `pollKey` state declared in component
- `getRangeForPoll()` function inside poll useEffect with day/month/week branching identical to loadData()
- `doPoll()` called immediately before `setInterval(doPoll, 15000)`
- Poll useEffect deps: `[orgId, viewMode, currentDate, pollKey]`
- View mode toggle buttons call `setPollKey(k => k + 1)`
- Prev/next/Today nav buttons call `setPollKey(k => k + 1)`
- TypeScript compiles with no new errors
- Week view poll behavior unchanged (7-day weekStart range)
</success_criteria>

<output>
After completion, create `.planning/phases/04-ui-reliability/04-02-SUMMARY.md`
</output>
