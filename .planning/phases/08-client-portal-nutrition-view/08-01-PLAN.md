---
phase: 08-client-portal-nutrition-view
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/trainer-web/supabase/migrations/0042_meal_plan_feedback.sql
autonomous: true
requirements:
  - PORTAL-NUTRITION-01
must_haves:
  truths:
    - "meal_plan_feedback table exists in Supabase with all required columns"
    - "Portal (no-auth) can INSERT a feedback row for a client's own plan"
    - "Coach can SELECT and UPDATE feedback rows belonging to their org"
  artifacts:
    - path: "apps/trainer-web/supabase/migrations/0042_meal_plan_feedback.sql"
      provides: "meal_plan_feedback table, RLS policies, indexes"
      contains: "CREATE TABLE meal_plan_feedback"
  key_links:
    - from: "meal_plan_feedback.plan_id"
      to: "meal_plans.id"
      via: "FK reference"
      pattern: "REFERENCES meal_plans"
    - from: "meal_plan_feedback.meal_id"
      to: "meal_plan_meals.id"
      via: "FK reference (nullable)"
      pattern: "REFERENCES meal_plan_meals"
---

<objective>
Create the `meal_plan_feedback` table via Supabase migration. This is the data foundation for Phase 8's feedback loop.

Purpose: Client submits feedback on meals in their portal. Feedback rows are stored here for the coach to review in Phase 9.
Output: Migration SQL file ready to apply via Supabase Management API.
</objective>

<execution_context>
@C:/Users/Troy Morgan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Troy Morgan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

<interfaces>
<!-- Existing nutrition schema from migration 0041 (Phase 6). -->
<!-- meal_plan_feedback must FK into these tables. -->

-- meal_plans: id uuid, org_id uuid, client_id uuid, status text ('draft'|'published'), published_at timestamptz
-- meal_plan_days: id uuid, plan_id uuid FK→meal_plans, day_number int, date date
-- meal_plan_meals: id uuid, day_id uuid FK→meal_plan_days, meal_type text, title text, sort_order int
-- meal_plan_components: id uuid, meal_id uuid FK→meal_plan_meals, food_item_id uuid nullable, qty_g numeric, custom_name text

-- Portal auth pattern (established in Phase 1-4):
-- Portal routes use createServiceClient() (service role, bypasses RLS).
-- Portal API validates identity via clients.portal_token UUID.
-- RLS on tables accessed by the portal is either bypassed (service role) or
-- uses explicit service-role INSERTs.
-- Coach-facing routes use createClient() (user auth) + org_members check.

-- Existing RLS pattern for child nutrition tables (from [06-01] decisions):
-- SELECT: EXISTS subquery chain back to org_id
-- Example: meal_plan_meals SELECT policy:
--   EXISTS (SELECT 1 FROM meal_plan_days d JOIN meal_plans p ON p.id = d.plan_id
--           WHERE d.id = meal_plan_meals.day_id AND p.org_id = auth.jwt()->>'org_id')
-- Portal feedback INSERT will use service role (no RLS needed for portal write path).
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration 0042 — meal_plan_feedback table</name>
  <files>apps/trainer-web/supabase/migrations/0042_meal_plan_feedback.sql</files>
  <action>
Create the SQL migration file. Apply it via the Supabase Management API using the same pattern as previous migrations (not via CLI — per [06-01] decisions, sequential filenames are incompatible with Supabase CLI migration tracking).

Table definition:

```sql
CREATE TABLE meal_plan_feedback (
  id            uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  plan_id       uuid NOT NULL REFERENCES meal_plans(id) ON DELETE CASCADE,
  meal_id       uuid REFERENCES meal_plan_meals(id) ON DELETE SET NULL,
  client_id     uuid NOT NULL REFERENCES clients(id) ON DELETE CASCADE,
  type          text NOT NULL CHECK (type IN ('substitution','dislike','allergy','portion','schedule','other')),
  scope         text NOT NULL CHECK (scope IN ('this_meal','going_forward','all_occurrences')),
  comment       text,
  forward       text CHECK (forward IN ('yes','no','ask_me') OR forward IS NULL),
  status        text NOT NULL DEFAULT 'pending' CHECK (status IN ('pending','reviewed')),
  created_at    timestamptz NOT NULL DEFAULT now()
);
```

Indexes for query performance:
```sql
CREATE INDEX idx_meal_plan_feedback_plan_id ON meal_plan_feedback(plan_id);
CREATE INDEX idx_meal_plan_feedback_client_id ON meal_plan_feedback(client_id);
CREATE INDEX idx_meal_plan_feedback_status ON meal_plan_feedback(status);
```

RLS — enable and add two policies:

```sql
ALTER TABLE meal_plan_feedback ENABLE ROW LEVEL SECURITY;

-- Coach SELECT/UPDATE: feedback belongs to plans in their org
CREATE POLICY "coach_select_feedback" ON meal_plan_feedback
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM meal_plans p
      JOIN org_members om ON om.org_id = p.org_id
      WHERE p.id = meal_plan_feedback.plan_id
        AND om.user_id = auth.uid()
    )
  );

CREATE POLICY "coach_update_feedback" ON meal_plan_feedback
  FOR UPDATE USING (
    EXISTS (
      SELECT 1 FROM meal_plans p
      JOIN org_members om ON om.org_id = p.org_id
      WHERE p.id = meal_plan_feedback.plan_id
        AND om.user_id = auth.uid()
    )
  );
```

NOTE: Portal INSERT uses service role (bypasses RLS), so no client INSERT policy needed.

After writing the file, apply it via Supabase Management API:
```bash
SUPABASE_PROJECT_REF="ntqdmgvxirswnjlnwopq"
# Read PAT via PowerShell WinCred pattern (get_cred.ps1)
# POST to https://api.supabase.com/v1/projects/{ref}/database/query
# with Authorization: Bearer {PAT} and body: { "query": "<sql>" }
```

Use the gsd-tools commit helper after successful apply.
  </action>
  <verify>
    <automated>
      node -e "
      const { createClient } = require('@supabase/supabase-js');
      // Quick schema check — verify table exists
      // Run: psql or supabase query to confirm table exists
      console.log('Verify manually: SELECT table_name FROM information_schema.tables WHERE table_name = \'meal_plan_feedback\'')
      "
    </automated>
  </verify>
  <done>Migration file exists at apps/trainer-web/supabase/migrations/0042_meal_plan_feedback.sql and has been applied. `SELECT count(*) FROM meal_plan_feedback` returns 0 (table exists, no rows yet). RLS is enabled on the table.</done>
</task>

</tasks>

<verification>
- Migration file exists at the correct path
- Table applied to Supabase: `SELECT count(*) FROM meal_plan_feedback` → 0 rows, no error
- RLS enabled: `SELECT relrowsecurity FROM pg_class WHERE relname = 'meal_plan_feedback'` → true
</verification>

<success_criteria>
meal_plan_feedback table exists in Supabase with all 10 columns, 3 indexes, RLS enabled, and 2 coach policies applied.
</success_criteria>

<output>
After completion, create `.planning/phases/08-client-portal-nutrition-view/08-01-SUMMARY.md`
</output>
