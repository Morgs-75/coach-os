---
phase: 08-client-portal-nutrition-view
plan: "03"
type: execute
wave: 3
depends_on:
  - "08-02"
files_modified:
  - apps/trainer-web/src/app/(portal)/portal/[token]/page.tsx
  - apps/trainer-web/src/app/(portal)/portal/[token]/PortalDashboard.tsx
  - apps/trainer-web/src/app/(portal)/portal/[token]/NutritionView.tsx
  - apps/trainer-web/src/app/(portal)/portal/[token]/FeedbackDrawer.tsx
autonomous: false
requirements:
  - PORTAL-NUTRITION-03
  - PORTAL-NUTRITION-04
must_haves:
  truths:
    - "Portal shows a 'Nutrition' tab when a published meal plan exists for the client"
    - "Each of the 7 days is rendered in a collapsible card with day header, date, and meal list"
    - "Each meal shows a component table: Component / Qty / Unit / C / P / F / kcal columns with a meal totals row"
    - "Day totals panel shows 4 KPI boxes (carbs, protein, fat, calories) and a CSS-only stacked bar macro chart"
    - "Client can open a feedback drawer from any meal, fill in type/scope/comment/forward fields, submit"
    - "Feedback submission calls POST /api/portal/nutrition/feedback and shows success state"
    - "If no published plan exists, the Nutrition tab shows a friendly empty state message"
  artifacts:
    - path: "apps/trainer-web/src/app/(portal)/portal/[token]/NutritionView.tsx"
      provides: "7-day collapsible plan view with macro tables and day totals"
      min_lines: 120
    - path: "apps/trainer-web/src/app/(portal)/portal/[token]/FeedbackDrawer.tsx"
      provides: "Slide-in drawer for meal feedback submission"
      min_lines: 80
    - path: "apps/trainer-web/src/app/(portal)/portal/[token]/PortalDashboard.tsx"
      provides: "Tab navigation (Sessions | Nutrition) with conditional tab rendering"
    - path: "apps/trainer-web/src/app/(portal)/portal/[token]/page.tsx"
      provides: "Server fetch of published nutrition plan passed as prop to PortalDashboard"
  key_links:
    - from: "page.tsx (server)"
      to: "GET /api/portal/nutrition"
      via: "fetch in server component"
      pattern: "fetch.*api/portal/nutrition"
    - from: "NutritionView.tsx"
      to: "FeedbackDrawer.tsx"
      via: "openFeedback(meal) callback prop"
      pattern: "onFeedback|openFeedback"
    - from: "FeedbackDrawer.tsx"
      to: "POST /api/portal/nutrition/feedback"
      via: "fetch in handleSubmit"
      pattern: "fetch.*api/portal/nutrition/feedback"
---

<objective>
Build the client-facing nutrition view inside the portal. This is the primary deliverable of Phase 8: the client sees their meal plan, explores meals, and submits feedback.

Purpose: Closes the feedback loop between coach-built plans (Phase 7) and client experience. Client sees exactly what they're eating and can flag issues.
Output: Four files — updated server page, updated PortalDashboard with tabs, NutritionView component, FeedbackDrawer component.
</objective>

<execution_context>
@C:/Users/Troy Morgan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Troy Morgan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md

<interfaces>
<!-- Existing portal server page pattern (page.tsx): -->
// Uses: import { createServiceClient } from "@/lib/supabase/service"
// Pattern: fetch multiple data sources in parallel with Promise.all
// Passes props down to PortalDashboard client component
// Next.js 15 async params: const { token } = await params

<!-- Existing PortalDashboard props interface: -->
// interface Props {
//   token: string;
//   clientName: string;
//   displayName: string;
//   primaryColor: string;
//   sessionsRemaining: number;
//   cancelNoticeHours: number;
//   upcomingBookings: Booking[];
//   pastBookings: Booking[];
// }
// Add: mealPlan: NutritionPlan | null

<!-- Macro calculation — implement inline, no library: -->
// Per component: scale proportionally to qty_g
//   scaled_protein = (food_item.protein_g / 100) * qty_g
//   scaled_fat = (food_item.fat_g / 100) * qty_g
//   scaled_carb = (food_item.carb_g / 100) * qty_g
//   scaled_kcal = (food_item.energy_kcal / 100) * qty_g
// Meal totals = sum of all component scaled values
// Day totals = sum of all meal totals in the day

<!-- Stacked bar chart — CSS only, no chart library: -->
// <div className="flex h-4 rounded-full overflow-hidden w-full">
//   <div style={{ width: `${carbPct}%`, backgroundColor: '#f59e0b' }} />  {/* carbs amber */}
//   <div style={{ width: `${proteinPct}%`, backgroundColor: '#3b82f6' }} />  {/* protein blue */}
//   <div style={{ width: `${fatPct}%`, backgroundColor: '#ef4444' }} />  {/* fat red */}
// </div>
// Where pct = (macro_kcal / total_kcal) * 100
// Carb kcal = carb_g * 4, Protein kcal = protein_g * 4, Fat kcal = fat_g * 9

<!-- GET /api/portal/nutrition response shape: -->
// { plan: NutritionPlan | null, clientName: string }
// NutritionPlan = {
//   id: string, name: string, start_date: string, end_date: string, published_at: string,
//   days: Array<{
//     id: string, day_number: number, date: string | null,
//     meals: Array<{
//       id: string, meal_type: string, title: string | null, sort_order: number,
//       components: Array<{
//         id: string, qty_g: number, custom_name: string | null,
//         food_item: { id: string, food_name: string, energy_kcal: number, protein_g: number, fat_g: number, carb_g: number } | null
//       }>
//     }>
//   }>
// }

<!-- POST /api/portal/nutrition/feedback request body: -->
// { token, plan_id, meal_id?, type, scope, comment?, forward? }
// type: 'substitution'|'dislike'|'allergy'|'portion'|'schedule'|'other'
// scope: 'this_meal'|'going_forward'|'all_occurrences'
// forward: 'yes'|'no'|'ask_me'

<!-- Existing portal design system (from PortalDashboard.tsx): -->
// max-w-2xl mx-auto px-4 layout
// bg-white rounded-xl border border-gray-200 overflow-hidden cards
// Collapsible pattern: button with SVG chevron + conditional render
// primaryColor applied via inline style={{ color: primaryColor }} and style={{ backgroundColor: primaryColor }}
// Text scale: text-sm for body, text-xs for secondary, font-semibold for headings
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: NutritionView + FeedbackDrawer components</name>
  <files>
    apps/trainer-web/src/app/(portal)/portal/[token]/NutritionView.tsx
    apps/trainer-web/src/app/(portal)/portal/[token]/FeedbackDrawer.tsx
  </files>
  <action>
Create two new client components.

**NutritionView.tsx**

Props:
```typescript
interface NutritionViewProps {
  plan: NutritionPlan;  // never null — caller guards
  token: string;
  primaryColor: string;
}
```

Structure:
- Plan header: plan name + date range (start_date – end_date) in a small gray subheading
- For each day (sorted by day_number):
  - Collapsible card (same pattern as upcoming/past sessions in PortalDashboard):
    - Header button: "Day {day_number}" + date formatted as "Mon 3 Mar" (use `new Date(day.date).toLocaleDateString("en-AU", {weekday:'short',day:'numeric',month:'short'})` — if date is null show "Day {day_number}")
    - When open:
      - For each meal (sorted by sort_order):
        - Meal heading: `{meal.meal_type}` capitalised + `{meal.title}` if present (e.g. "Breakfast — Eggs & Oats")
        - Component table with columns: Component | Qty | Unit | C | P | F | kcal
          - `thead` with those 7 headers (text-xs uppercase text-gray-400)
          - `tbody` one row per component:
            - Component: `food_item.food_name` OR `custom_name` if food_item is null
            - Qty: `qty_g` formatted to 1 decimal (or integer if whole number)
            - Unit: "g" always
            - C: `(food_item.carb_g / 100 * qty_g).toFixed(1)` or "—" if no food_item
            - P: protein scaled same
            - F: fat scaled same
            - kcal: energy scaled same
          - Meal totals row in `tfoot` (bold): sum of all component macros, label "Total"
        - "Leave feedback" button (text-xs, styled with primaryColor border/text) that calls `onFeedback(meal)` callback
      - Day totals panel (below last meal):
        - 4 KPI boxes in a 2×2 grid or single row (whichever fits max-w-2xl):
          - Carbs: total_carb_g formatted to 0dp + "g"
          - Protein: total_protein_g to 0dp + "g"
          - Fat: total_fat_g to 0dp + "g"
          - Calories: total_kcal to 0dp + "kcal"
          - Label below each number in text-xs text-gray-400
        - Stacked bar chart (CSS, no library):
          ```tsx
          // kcal contributions: carb_kcal = carb_g*4, prot_kcal = protein_g*4, fat_kcal = fat_g*9
          // pct = (x_kcal / total_kcal) * 100  (guard divide-by-zero → show empty bar)
          <div className="flex h-3 rounded-full overflow-hidden w-full mt-3">
            <div style={{ width: `${carbPct}%`, backgroundColor: '#f59e0b' }} title={`Carbs ${carbPct.toFixed(0)}%`} />
            <div style={{ width: `${proteinPct}%`, backgroundColor: '#3b82f6' }} title={`Protein ${proteinPct.toFixed(0)}%`} />
            <div style={{ width: `${fatPct}%`, backgroundColor: '#ef4444' }} title={`Fat ${fatPct.toFixed(0)}%`} />
          </div>
          ```
        - Color legend: small dots + "Carbs", "Protein", "Fat" labels in text-xs

State: `expandedDays` Set<string> — start with day 1 expanded (first day), rest collapsed. Toggle on header click.

Callback prop: `onFeedback: (meal: Meal) => void` — passed down from PortalDashboard, calls FeedbackDrawer open.

**FeedbackDrawer.tsx**

Props:
```typescript
interface FeedbackDrawerProps {
  isOpen: boolean;
  meal: Meal | null;  // which meal the feedback is about
  planId: string;
  token: string;
  primaryColor: string;
  onClose: () => void;
  onSuccess: () => void;
}
```

Implementation:
- Slide-in from right or bottom sheet (bottom on mobile): `fixed inset-0 z-50` backdrop + `fixed bottom-0 left-0 right-0 bg-white rounded-t-2xl p-5` panel (or right drawer on wider screens — use the bottom sheet pattern to match mobile-first portal).
- Heading: "Feedback for {meal?.meal_type}" or "Meal Feedback"
- Form fields:
  1. **Type** — `<select>` with options: Substitution request / I dislike this / Allergy concern / Portion size / Scheduling issue / Other. Maps to values: substitution/dislike/allergy/portion/schedule/other.
  2. **Scope** — `<select>`: Just this instance / Going forward / All occurrences. Maps to: this_meal/going_forward/all_occurrences.
  3. **Comment** — `<textarea>` placeholder "Tell your coach more (optional)" rows=3.
  4. **Forward preference** — `<select>` (optional, labelled "Would you like your coach to act on this?"): Yes please / Not right now / Ask me. Maps to: yes/no/ask_me. Include a blank/null option.
- Submit button (styled with primaryColor bg): calls POST /api/portal/nutrition/feedback with { token, plan_id: planId, meal_id: meal.id, type, scope, comment, forward }.
- States: idle / submitting / success / error.
  - Success state: "Thank you! Your coach has been notified." with a Close button.
  - Error state: show error message in red, allow retry.
- Close button (X) in top-right corner of panel.
- Clicking backdrop closes drawer.

Style: match portal design system (bg-white, border-gray-200, text-sm, font-semibold headings, rounded inputs with border border-gray-200 px-3 py-2 text-sm).
  </action>
  <verify>
    <automated>cd "/c/Users/Troy Morgan/OneDrive/coach-os/apps/trainer-web" && npx tsc --noEmit 2>&1 | tail -20</automated>
  </verify>
  <done>NutritionView.tsx renders 7 collapsible day cards each with meal tables, totals, stacked bar, and feedback button. FeedbackDrawer.tsx renders a bottom sheet form with 4 fields, submits to API, shows success/error. TypeScript compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Wire Nutrition tab into portal page + PortalDashboard</name>
  <files>
    apps/trainer-web/src/app/(portal)/portal/[token]/page.tsx
    apps/trainer-web/src/app/(portal)/portal/[token]/PortalDashboard.tsx
  </files>
  <action>
Update the server page to fetch the nutrition plan, then update PortalDashboard to add tab navigation.

**page.tsx changes:**
1. Add nutrition plan fetch to the existing `Promise.all`:
   ```typescript
   // Fetch active published plan for this client
   supabase
     .from("meal_plans")
     .select(`
       id, name, start_date, end_date, published_at, version,
       days:meal_plan_days(
         id, day_number, date,
         meals:meal_plan_meals(
           id, meal_type, title, sort_order,
           components:meal_plan_components(
             id, qty_g, custom_name, sort_order,
             food_item:food_items(id, food_name, energy_kcal, protein_g, fat_g, carb_g)
           )
         )
       )
     `)
     .eq("client_id", client.id)
     .eq("status", "published")
     .order("published_at", { ascending: false })
     .limit(1)
     .maybeSingle()   // returns null (not error) when no row matches
   ```
2. Sort the days/meals/components (same sort logic as coach builder GET — day_number, sort_order, sort_order).
3. Pass `mealPlan={planRes.data ?? null}` as a new prop to `<PortalDashboard>`.

**PortalDashboard.tsx changes:**
1. Add `mealPlan: NutritionPlan | null` to the Props interface.
2. Add `activeTab` state: `useState<'sessions' | 'nutrition'>('sessions')`.
3. Add tab bar below the header (before the `max-w-2xl` content area):
   ```tsx
   <div className="bg-white border-b border-gray-200">
     <div className="max-w-2xl mx-auto px-4 flex gap-1">
       {(['sessions', 'nutrition'] as const).map(tab => (
         <button
           key={tab}
           onClick={() => setActiveTab(tab)}
           className={`px-4 py-3 text-sm font-medium border-b-2 -mb-px transition-colors ${
             activeTab === tab
               ? 'border-current font-semibold'
               : 'border-transparent text-gray-500 hover:text-gray-700'
           }`}
           style={activeTab === tab ? { color: primaryColor, borderColor: primaryColor } : {}}
         >
           {tab === 'sessions' ? 'Sessions' : 'Nutrition'}
         </button>
       ))}
     </div>
   </div>
   ```
4. Conditionally render content:
   - `activeTab === 'sessions'` → existing sessions content (hero card, upcoming, past, bottom note)
   - `activeTab === 'nutrition'` → render nutrition content:
     - If `mealPlan` is null: empty state card "No active meal plan yet. Your coach will publish one when it's ready."
     - If `mealPlan` is not null: render `<NutritionView plan={mealPlan} token={token} primaryColor={primaryColor} onFeedback={handleOpenFeedback} />`
5. Add feedback drawer state:
   ```typescript
   const [feedbackMeal, setFeedbackMeal] = useState<Meal | null>(null);
   const [feedbackOpen, setFeedbackOpen] = useState(false);
   function handleOpenFeedback(meal: Meal) {
     setFeedbackMeal(meal);
     setFeedbackOpen(true);
   }
   ```
6. Render `<FeedbackDrawer>` at bottom of return (always mounted, isOpen controls visibility):
   ```tsx
   <FeedbackDrawer
     isOpen={feedbackOpen}
     meal={feedbackMeal}
     planId={mealPlan?.id ?? ''}
     token={token}
     primaryColor={primaryColor}
     onClose={() => setFeedbackOpen(false)}
     onSuccess={() => setFeedbackOpen(false)}
   />
   ```
7. Import `NutritionView` and `FeedbackDrawer` at top of file.

Import the `NutritionPlan` and `Meal` types from `NutritionView.tsx` — export them from that file for sharing.

The existing sessions tab content must remain IDENTICAL — do not refactor or move any existing code other than wrapping it in the `activeTab === 'sessions'` conditional.
  </action>
  <verify>
    <automated>cd "/c/Users/Troy Morgan/OneDrive/coach-os/apps/trainer-web" && npx tsc --noEmit 2>&1 | tail -20</automated>
  </verify>
  <done>Portal page compiles. Nutrition tab appears in the tab bar. Clicking it shows NutritionView (or empty state). Sessions tab still works identically. FeedbackDrawer opens when "Leave feedback" is clicked on a meal.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 8 portal nutrition view:
    - Nutrition tab in client portal
    - 7-day collapsible plan view with macro component tables and day totals
    - CSS-only stacked macro bar chart
    - Feedback drawer with type/scope/comment/forward fields
    - Feedback submission stores to DB + SMS coach
  </what-built>
  <how-to-verify>
    1. Start dev server: `cd apps/trainer-web && npm run dev`
    2. Open portal: http://localhost:3000/portal/{your_test_token}
    3. Verify Sessions tab still works (upcoming/past sessions, cancel button)
    4. Click "Nutrition" tab
    5. If no published plan: confirm empty state message appears (not an error)
    6. To test with a plan: in Supabase set a meal_plan.status = 'published' for the test client
    7. Verify: 7 day cards appear, first day is expanded by default
    8. Expand a day: check macro table columns (Component / Qty / Unit / C / P / F / kcal)
    9. Check meal totals row appears in table footer
    10. Check day totals KPI boxes (4 values) + stacked bar chart renders
    11. Click "Leave feedback" on any meal → bottom drawer opens
    12. Select type = "Dislike", scope = "Going forward", add comment, click Submit
    13. Confirm success message appears
    14. In Supabase: SELECT * FROM meal_plan_feedback → confirm row exists with correct values
  </how-to-verify>
  <resume-signal>Type "approved" when all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- TypeScript compiles: `cd apps/trainer-web && npx tsc --noEmit` → no errors
- Portal loads at /portal/{token} with Nutrition tab visible
- Feedback row appears in meal_plan_feedback after submission
- Sessions tab unaffected (existing functionality preserved)
</verification>

<success_criteria>
Client can navigate to Nutrition tab, view their published 7-day meal plan with full macro data, and submit feedback that stores to the DB and notifies the coach via SMS.
</success_criteria>

<output>
After completion, create `.planning/phases/08-client-portal-nutrition-view/08-03-SUMMARY.md`
</output>
