---
phase: 05-production-hygiene
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/trainer-web/src/lib/supabase/middleware.ts
autonomous: true
requirements:
  - INFRA-01

must_haves:
  truths:
    - "Netlify function logs do not contain user IDs on routine authenticated requests"
    - "Unauthenticated redirect still works correctly after the log removal"
  artifacts:
    - path: "apps/trainer-web/src/lib/supabase/middleware.ts"
      provides: "Auth middleware without PII logging"
      contains: "updateSession"
  key_links:
    - from: "apps/trainer-web/src/lib/supabase/middleware.ts"
      to: "Netlify function logs"
      via: "console.log removal"
      pattern: "console\\.log.*user.*id"
---

<objective>
Remove PII-leaking console.log statements from the Next.js auth middleware.

Purpose: Every authenticated page request currently logs the user's UUID and session error state to Netlify function logs. This leaks PII on every request in production.
Output: Middleware with PII console.log statements removed; auth behaviour unchanged.
</objective>

<execution_context>
@C:/Users/Troy Morgan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Troy Morgan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@apps/trainer-web/src/lib/supabase/middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove PII console.log from auth middleware</name>
  <files>apps/trainer-web/src/lib/supabase/middleware.ts</files>
  <action>
    In `apps/trainer-web/src/lib/supabase/middleware.ts`, remove the two console.log calls that leak PII:

    1. Line 42: `console.log("Middleware auth check:", { user: user?.id, error: error?.message, path: request.nextUrl.pathname });`
       — Remove this line entirely. It logs user.id (PII) on every authenticated request.

    2. Line 48: `console.log("Redirecting to login - no user found");`
       — Remove this line entirely. It is a low-value noise log and adds no debugging value not already implicit in the redirect behaviour.

    Do NOT change any other logic in the file. The auth check, redirect, and x-user-id header forwarding must remain exactly as-is. Only the two console.log calls are removed.

    Expected result: the file no longer contains any console.log statements.
  </action>
  <verify>
    <automated>grep -c "console\.log" "apps/trainer-web/src/lib/supabase/middleware.ts" && echo "FAIL: console.log still present" || echo "PASS: no console.log"</automated>
    <manual>Run `grep "console.log" apps/trainer-web/src/lib/supabase/middleware.ts` — should return no output. Confirm the getUser() call, redirect logic, and x-user-id header set are all still present.</manual>
  </verify>
  <done>
    `apps/trainer-web/src/lib/supabase/middleware.ts` contains zero console.log calls.
    The getUser() auth check, unauthenticated redirect, and x-user-id header forwarding are all still present and unchanged.
  </done>
</task>

</tasks>

<verification>
After execution:
1. `grep "console.log" apps/trainer-web/src/lib/supabase/middleware.ts` returns no output
2. `grep "getUser\|x-user-id\|redirect\|updateSession" apps/trainer-web/src/lib/supabase/middleware.ts` returns all four — confirming auth behaviour is intact
3. No TypeScript errors: `cd apps/trainer-web && npx tsc --noEmit 2>&1 | head -20`
</verification>

<success_criteria>
- Netlify function logs no longer contain user IDs or session error state on routine authenticated requests
- Auth redirect for unauthenticated users still functions (behaviour unchanged — only logging removed)
</success_criteria>

<output>
After completion, create `.planning/phases/05-production-hygiene/05-01-SUMMARY.md`
</output>
