---
phase: 10-async-ai-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/0046_meal_plan_generation_status.sql
autonomous: true
requirements:
  - ASYNC-01
must_haves:
  truths:
    - "meal_plans rows have a generation_status column defaulting to 'idle'"
    - "meal_plans rows have a generation_error column for error messages"
    - "Existing rows are not broken — migration is additive (nullable columns, safe default)"
  artifacts:
    - path: "supabase/migrations/0046_meal_plan_generation_status.sql"
      provides: "ALTER TABLE statements adding generation_status and generation_error to meal_plans"
      contains: "generation_status"
  key_links:
    - from: "supabase/migrations/0046_meal_plan_generation_status.sql"
      to: "meal_plans table"
      via: "ALTER TABLE meal_plans ADD COLUMN"
      pattern: "generation_status"
---

<objective>
Add two columns to the `meal_plans` table: `generation_status` (text, values: idle/generating/complete/error) and `generation_error` (text, nullable). These columns are the coordination layer between the async /start, /run, and /status endpoints.

Purpose: The async generation architecture requires a persistent status field so /run can check idempotency and /status can report progress. Without this migration the API split cannot function.
Output: Migration file 0046 ready to apply via Supabase Management API.
</objective>

<execution_context>
@C:/Users/Troy Morgan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Troy Morgan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-async-ai-generation/10-CONTEXT.md

Prior migrations for reference pattern:
@supabase/migrations/0045_meal_plan_intake.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write migration 0046 — add generation_status + generation_error to meal_plans</name>
  <files>supabase/migrations/0046_meal_plan_generation_status.sql</files>
  <action>
Create `supabase/migrations/0046_meal_plan_generation_status.sql` with:

```sql
-- Migration 0046: Add async generation status columns to meal_plans
-- These columns coordinate the split start/run/status endpoints.
-- generation_status: idle | generating | complete | error
-- generation_error:  non-null when status='error', null otherwise

ALTER TABLE meal_plans
  ADD COLUMN IF NOT EXISTS generation_status text NOT NULL DEFAULT 'idle',
  ADD COLUMN IF NOT EXISTS generation_error text;

-- Constrain valid values so the DB rejects typos
ALTER TABLE meal_plans
  ADD CONSTRAINT meal_plans_generation_status_check
  CHECK (generation_status IN ('idle', 'generating', 'complete', 'error'));
```

Then apply via the Supabase Management API (same pattern as previous migrations — use the PowerShell WinCred pattern to retrieve the PAT, then POST to `https://api.supabase.com/v1/projects/ntqdmgvxirswnjlnwopq/database/query`).

Apply command (adapt from prior sessions):
```bash
PAT=$(powershell.exe -Command "
  \$cred = [System.Runtime.InteropServices.Marshal]
  Add-Type -AssemblyName System.Runtime.InteropServices
  # Use CredReadW via advapi32 as in prior sessions
  \$encoded = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String((Get-StoredCredential -Target 'Supabase CLI:supabase').Password))
  Write-Output \$encoded
" 2>/dev/null)

# If WinCred fails, prompt user for PAT inline
curl -s -X POST "https://api.supabase.com/v1/projects/ntqdmgvxirswnjlnwopq/database/query" \
  -H "Authorization: Bearer $PAT" \
  -H "Content-Type: application/json" \
  -d '{"query": "ALTER TABLE meal_plans ADD COLUMN IF NOT EXISTS generation_status text NOT NULL DEFAULT '\''idle'\'', ADD COLUMN IF NOT EXISTS generation_error text; ALTER TABLE meal_plans ADD CONSTRAINT meal_plans_generation_status_check CHECK (generation_status IN (''idle'', ''generating'', ''complete'', ''error''));"}'
```

If the PAT retrieval via script is uncertain, apply using the gsd-tools pattern for PAT retrieval that worked in session 2026-02-27 (requests library + browser User-Agent).

The migration file is the source of truth — commit it regardless of whether the curl apply succeeds (apply can be retried).
  </action>
  <verify>
    <automated>
      curl -s "https://api.supabase.com/v1/projects/ntqdmgvxirswnjlnwopq/database/query" \
        -H "Authorization: Bearer $SUPABASE_PAT" \
        -H "Content-Type: application/json" \
        -d '{"query": "SELECT column_name, data_type, column_default FROM information_schema.columns WHERE table_name = '\''meal_plans'\'' AND column_name IN ('\''generation_status'\'', '\''generation_error'\'');"}' | python -c "import sys,json; cols=[r['column_name'] for r in json.load(sys.stdin)]; assert 'generation_status' in cols and 'generation_error' in cols, f'Missing columns: {cols}'; print('OK')"
    </automated>
  </verify>
  <done>
    - `supabase/migrations/0046_meal_plan_generation_status.sql` exists with ALTER TABLE statements
    - Migration applied to production DB: `SELECT column_name FROM information_schema.columns WHERE table_name='meal_plans' AND column_name='generation_status'` returns a row
    - Existing meal_plans rows have generation_status='idle' (the DEFAULT)
    - CHECK constraint rejects values outside idle/generating/complete/error
  </done>
</task>

</tasks>

<verification>
- Migration file exists at `supabase/migrations/0046_meal_plan_generation_status.sql`
- Both columns present in production: generation_status (text, default 'idle') + generation_error (text, nullable)
- Existing meal_plans rows unaffected (additive migration, has safe DEFAULT)
</verification>

<success_criteria>
`SELECT generation_status, generation_error FROM meal_plans LIMIT 1` executes without error and returns generation_status='idle'.
</success_criteria>

<output>
After completion, create `.planning/phases/10-async-ai-generation/10-01-SUMMARY.md`
</output>
