---
phase: 06-nutrition-foundation
plan: 04
type: execute
wave: 3
depends_on:
  - 06-01
  - 06-03
files_modified:
  - apps/trainer-web/src/app/(app)/nutrition/page.tsx
  - apps/trainer-web/src/app/(app)/nutrition/NutritionClient.tsx
  - apps/trainer-web/src/app/api/nutrition/plans/route.ts
  - apps/trainer-web/src/components/Sidebar.tsx
autonomous: false
requirements:
  - NUTR-05
  - NUTR-06

must_haves:
  truths:
    - "Sidebar shows a Nutrition nav item linking to /nutrition"
    - "Coach can visit /nutrition and see a list of all meal plans for their org"
    - "Plans list is filterable by client using a dropdown"
    - "Coach can open a create plan modal and fill in: client (select), plan name, start date, end date"
    - "Submitting the modal creates a meal_plans row with status=draft and the plan appears in the list"
    - "Each plan row shows a status badge: grey for draft, green for published"
  artifacts:
    - path: "apps/trainer-web/src/app/(app)/nutrition/page.tsx"
      provides: "Server component wrapper for /nutrition route"
    - path: "apps/trainer-web/src/app/(app)/nutrition/NutritionClient.tsx"
      provides: "Client component with plan list, filter, create modal"
    - path: "apps/trainer-web/src/app/api/nutrition/plans/route.ts"
      provides: "GET (list plans) and POST (create plan) API"
    - path: "apps/trainer-web/src/components/Sidebar.tsx"
      provides: "Sidebar with Nutrition nav item added"
  key_links:
    - from: "NutritionClient.tsx"
      to: "/api/nutrition/plans"
      via: "fetch on mount (GET) and form submit (POST)"
      pattern: "fetch.*api/nutrition/plans"
    - from: "/api/nutrition/plans"
      to: "meal_plans table"
      via: "Supabase select/insert with org_id scoping"
      pattern: "supabase.from('meal_plans')"
    - from: "Sidebar.tsx"
      to: "/nutrition"
      via: "navigation array entry"
      pattern: "href.*nutrition"
---

<objective>
Scaffold the /nutrition section of the coach app: sidebar nav entry, plan list page (filterable by client), create plan modal, and the backing API routes (GET + POST /api/nutrition/plans).

Purpose: Completes the Phase 6 deliverables â€” coaches can navigate to /nutrition, see their plans, and create new ones with a client and date range.
Output: /nutrition page + NutritionClient.tsx + plans API + Sidebar update.
</objective>

<execution_context>
@C:/Users/Troy Morgan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Troy Morgan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-nutrition-foundation/06-CONTEXT.md
@.planning/phases/06-nutrition-foundation/06-01-SUMMARY.md
@.planning/phases/06-nutrition-foundation/06-03-SUMMARY.md

<interfaces>
<!-- Sidebar navigation array (from src/components/Sidebar.tsx) -->
```typescript
const navigation = [
  { name: "Dashboard", href: "/dashboard", icon: "ðŸ“Š" },
  { name: "AI Coach", href: "/coach", icon: "ðŸ§ " },
  { name: "Insights", href: "/insights", icon: "ðŸ’¡" },
  { name: "Calendar", href: "/calendar", icon: "ðŸ“…" },
  { name: "Clients", href: "/clients", icon: "ðŸ‘¥" },
  { name: "Leads", href: "/leads", icon: "ðŸ“‹" },
  { name: "Pricing", href: "/pricing", icon: "ðŸ’µ" },
  { name: "myMarketing", href: "/marketing", icon: "ðŸ“£" },
  { name: "Email", href: "/email", icon: "ðŸ“§" },
  { name: "Messages", href: "/messages", icon: "ðŸ’¬" },
  { name: "Automations", href: "/automations", icon: "âš¡" },
  { name: "myAccounts", href: "/my-accounts", icon: "ðŸ’°" },
  { name: "myProducts", href: "/products", icon: "ðŸ“¦" },
  { name: "myExecutiveAssistant", href: "/my-ea", icon: "ðŸ¤–" },
  { name: "myFitnessMBA", href: "/my-fitness-mba", icon: "ðŸŽ“" },
];
```
Add `{ name: "Nutrition", href: "/nutrition", icon: "ðŸ¥—" }` after "Clients" (before "Leads").

<!-- meal_plans table columns: id, org_id, client_id, created_by, name, start_date, end_date, status, version, published_at, created_at, updated_at -->

<!-- clients table: id, org_id, name (or first_name+last_name), status -->
Check existing clients page for how client name is displayed:
- Field is likely `name` (full name) or `first_name` + `last_name` â€” check clients table schema

<!-- API route pattern (copy from existing) -->
From apps/trainer-web/src/app/api/my-accounts/transactions/route.ts:
- Import NextResponse from "next/server"
- Import createClient from "@/lib/supabase/server"
- Use getOrgId helper pattern (auth.getUser â†’ org_members â†’ org_id)
- Return 401 if no org_id
- Wrap in try/catch, return 500 on error

<!-- Page + client component split pattern -->
From apps/trainer-web/src/app/(app)/leads/page.tsx:
- page.tsx is minimal (just renders the "use client" component)
- All interactivity in the same file (leads page is all in one "use client" file)
- For /nutrition, use the page.tsx + NutritionClient.tsx split for cleanliness

<!-- Modal pattern (from leads page) -->
- useState for showModal, formState
- Fixed overlay: className="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
- Modal card: className="bg-white dark:bg-gray-900 rounded-xl p-6 w-full max-w-md"
- Form inputs use: className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 dark:bg-gray-800"
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Nutrition to sidebar and create /api/nutrition/plans route</name>
  <files>
    apps/trainer-web/src/components/Sidebar.tsx
    apps/trainer-web/src/app/api/nutrition/plans/route.ts
  </files>
  <action>
**Sidebar update:**

In `apps/trainer-web/src/components/Sidebar.tsx`, locate the `navigation` array and insert the Nutrition item after the Clients entry:

```typescript
{ name: "Nutrition", href: "/nutrition", icon: "ðŸ¥—" },
```

This should appear between `{ name: "Clients", href: "/clients", icon: "ðŸ‘¥" }` and `{ name: "Leads", href: "/leads", icon: "ðŸ“‹" }`.

No other changes to Sidebar.tsx.

---

**Plans API route:**

Create `apps/trainer-web/src/app/api/nutrition/plans/route.ts` with two handlers:

**GET handler** â€” list plans for the org, optionally filtered by client_id:
```typescript
export async function GET(request: Request) {
  // 1. Auth + getOrgId (401 if not member)
  // 2. Parse ?client_id= from URL (optional)
  // 3. Query:
  //    supabase.from('meal_plans')
  //      .select(`*, client:clients(id, name)`)  -- or first_name+last_name if clients.name doesn't exist
  //      .eq('org_id', orgId)
  //      .order('created_at', { ascending: false })
  // 4. If client_id param present, add .eq('client_id', clientId)
  // 5. Return { plans: data }
}
```

Note on clients table name field: Check if clients table has `name` column or `first_name`/`last_name`. Use whichever exists. If unsure, select `id, name, first_name, last_name` and the client component handles display.

**POST handler** â€” create a new plan:
```typescript
export async function POST(request: Request) {
  // 1. Auth + getOrgId (401 if not member)
  // 2. Parse body: { client_id, name, start_date, end_date }
  // 3. Validate: name is required
  // 4. Insert:
  //    supabase.from('meal_plans').insert({
  //      org_id: orgId,
  //      client_id: body.client_id || null,
  //      created_by: user.id,
  //      name: body.name,
  //      start_date: body.start_date || null,
  //      end_date: body.end_date || null,
  //      status: 'draft',
  //      version: 1,
  //    }).select().single()
  // 5. Return { plan: data } with status 201
}
```

For `created_by`, get the user.id from `supabase.auth.getUser()` (already called in getOrgId â€” refactor to return both, or call getUser again).
  </action>
  <verify>
    <automated>node -e "const fs=require('fs'); ['apps/trainer-web/src/components/Sidebar.tsx','apps/trainer-web/src/app/api/nutrition/plans/route.ts'].forEach(f=>{if(!fs.existsSync(f))throw new Error('Missing file: '+f);}); const sb=fs.readFileSync('apps/trainer-web/src/components/Sidebar.tsx','utf8'); if(!sb.includes('/nutrition'))throw new Error('Sidebar missing nutrition link'); const api=fs.readFileSync('apps/trainer-web/src/app/api/nutrition/plans/route.ts','utf8'); ['meal_plans','org_id','client_id','status'].forEach(c=>{if(!api.includes(c))throw new Error('Plans API missing: '+c);}); console.log('Sidebar + API OK');" 2>&1</automated>
  </verify>
  <done>Sidebar.tsx has /nutrition nav entry. /api/nutrition/plans supports GET (list with optional client_id filter) and POST (create plan). Both routes are org-scoped and return 401 if unauthenticated.</done>
</task>

<task type="auto">
  <name>Task 2: Create /nutrition page and NutritionClient component</name>
  <files>
    apps/trainer-web/src/app/(app)/nutrition/page.tsx
    apps/trainer-web/src/app/(app)/nutrition/NutritionClient.tsx
  </files>
  <action>
Create the directory `apps/trainer-web/src/app/(app)/nutrition/` and two files:

**page.tsx** (server component wrapper):
```typescript
import NutritionClient from "./NutritionClient";

export default function NutritionPage() {
  return <NutritionClient />;
}
```

**NutritionClient.tsx** â€” full client component:

```typescript
"use client";

import { useState, useEffect } from "react";
import { createClient } from "@/lib/supabase/client";
import { clsx } from "clsx";

interface Client {
  id: string;
  name: string | null;
  first_name?: string | null;
  last_name?: string | null;
}

interface MealPlan {
  id: string;
  name: string;
  status: "draft" | "published";
  version: number;
  start_date: string | null;
  end_date: string | null;
  created_at: string;
  client: Client | null;
}
```

**Plan list view:**
- Page header: "Nutrition Plans" (h1, same styling as other pages: `text-2xl font-bold text-gray-900 dark:text-gray-100`)
- Subheading: "Create and manage meal plans for your clients"
- Top bar: client filter dropdown (left) + "New Plan" button (right, `bg-brand-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-brand-700`)
- Client filter: `<select>` with "All clients" option + one option per client (loaded from Supabase `clients` table filtered by org_id)
- Plan list: table or card list. Use a clean table with columns: Plan Name | Client | Date Range | Status | Created
  - Plan Name: `font-medium text-gray-900 dark:text-gray-100`
  - Client name: text-gray-600, "Unassigned" if no client
  - Date Range: "1 Mar â€“ 7 Mar 2025" format, "No dates" if both null
  - Status badge: draft = `bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400 px-2 py-0.5 rounded-full text-xs font-medium`, published = `bg-green-100 text-green-700 px-2 py-0.5 rounded-full text-xs font-medium`
  - Created date: locale date string
- Empty state: "No plans yet. Create your first meal plan." with icon

**Create plan modal:**
- Triggered by "New Plan" button
- Fixed overlay with dark backdrop (z-50)
- Modal card max-w-md
- Form fields:
  1. Client (select â€” "No client" option + all org clients)
  2. Plan Name (text input, required, placeholder "e.g. 7-Day Weight Loss Plan")
  3. Start Date (date input, optional)
  4. End Date (date input, optional)
- Submit button: "Create Plan" (disabled + spinner while submitting)
- On success: close modal, refresh list, plan appears at top
- On error: show inline error message below form

**Data loading:**
```typescript
useEffect(() => {
  loadData();
}, [selectedClientId]);

async function loadData() {
  const supabase = createClient();
  // 1. Get org_id from org_members
  // 2. GET /api/nutrition/plans?client_id=... (if filter active)
  // 3. GET clients list from supabase directly for filter dropdown:
  //    supabase.from('clients').select('id, name, first_name, last_name').eq('org_id', orgId).eq('status', 'active').order('name')
  // 4. setPlans + setClients
}
```

**Create plan submit:**
```typescript
async function handleCreatePlan(e: React.FormEvent) {
  e.preventDefault();
  setCreating(true);
  const res = await fetch('/api/nutrition/plans', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(form),
  });
  if (res.ok) {
    setShowModal(false);
    setForm({ client_id: '', name: '', start_date: '', end_date: '' });
    await loadData();
  } else {
    const err = await res.json();
    setError(err.error || 'Failed to create plan');
  }
  setCreating(false);
}
```

**Client name helper:**
```typescript
function clientDisplayName(client: Client | null): string {
  if (!client) return "Unassigned";
  return client.name || [client.first_name, client.last_name].filter(Boolean).join(' ') || "Unknown";
}
```

**Date range helper:**
```typescript
function formatDateRange(start: string | null, end: string | null): string {
  if (!start && !end) return "No dates";
  const fmt = (d: string) => new Date(d).toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' });
  if (start && end) return `${fmt(start)} â€“ ${fmt(end)}`;
  if (start) return `From ${fmt(start)}`;
  return `Until ${fmt(end!)}`;
}
```

Follow the dark mode patterns seen in existing pages â€” use `dark:` variants consistently (dark:bg-gray-900, dark:text-gray-100, dark:border-gray-700 etc.).
  </action>
  <verify>
    <automated>node -e "const fs=require('fs'); ['apps/trainer-web/src/app/(app)/nutrition/page.tsx','apps/trainer-web/src/app/(app)/nutrition/NutritionClient.tsx'].forEach(f=>{if(!fs.existsSync(f))throw new Error('Missing: '+f);}); const c=fs.readFileSync('apps/trainer-web/src/app/(app)/nutrition/NutritionClient.tsx','utf8'); ['use client','MealPlan','showModal','handleCreatePlan','draft','published','New Plan'].forEach(k=>{if(!c.includes(k))throw new Error('NutritionClient missing: '+k);}); console.log('Nutrition page files OK');" 2>&1</automated>
  </verify>
  <done>apps/trainer-web/src/app/(app)/nutrition/page.tsx and NutritionClient.tsx exist. Plan list renders with client filter and status badges. Create plan modal submits to POST /api/nutrition/plans.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete /nutrition section:
    - Sidebar nav entry "Nutrition" linking to /nutrition
    - Plan list page: client filter dropdown, plan rows with status badges
    - Create plan modal: client select, name, start/end date fields
    - API: GET + POST /api/nutrition/plans (org-scoped, authenticated)
  </what-built>
  <how-to-verify>
    1. Run the dev server: `cd apps/trainer-web && npm run dev`

    2. Navigate to http://localhost:3000/nutrition
       - Expected: "Nutrition Plans" heading, empty state "No plans yet", "New Plan" button

    3. Check the sidebar shows "Nutrition" with the salad icon between Clients and Leads.

    4. Click "New Plan":
       - Expected: Modal opens with client dropdown, name field, start/end date fields

    5. Fill in the form: select a client, name "Test Plan", pick start and end dates. Click "Create Plan".
       - Expected: Modal closes, plan appears in list with "draft" status badge in grey

    6. Refresh the page.
       - Expected: Plan is still in the list (persisted to DB)

    Type "approved" if all steps work, or describe any issues.
  </how-to-verify>
  <resume-signal>Type "approved" to confirm /nutrition page works end-to-end, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
- GET http://localhost:3000/nutrition returns 200 (page loads)
- Sidebar has "Nutrition" link between Clients and Leads
- Creating a plan via modal inserts a row in meal_plans with status='draft', version=1
- `SELECT id, name, status, version FROM meal_plans ORDER BY created_at DESC LIMIT 3` shows the created plan
- Plan list shows correct status badges and client names
</verification>

<success_criteria>
Coach can navigate to /nutrition, view all org plans filtered by client, and create a new draft plan with a client assignment and date range. Plan persists and shows correct status badge in the list.
</success_criteria>

<output>
After completion, create `.planning/phases/06-nutrition-foundation/06-04-SUMMARY.md`
</output>
