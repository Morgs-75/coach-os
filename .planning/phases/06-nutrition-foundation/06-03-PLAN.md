---
phase: 06-nutrition-foundation
plan: 03
type: execute
wave: 2
depends_on:
  - 06-01
files_modified:
  - apps/trainer-web/src/app/api/nutrition/foods/route.ts
autonomous: true
requirements:
  - NUTR-04

must_haves:
  truths:
    - "GET /api/nutrition/foods?q=chicken returns up to 20 food_items rows matching the query"
    - "Response shape: { foods: [{ id, food_name, food_group, energy_kcal, protein_g, fat_g, carb_g, fibre_g }] }"
    - "Search is case-insensitive and matches partial food names (e.g. ?q=chick returns chicken items)"
    - "Empty or missing q param returns empty array, not an error"
    - "Unauthenticated requests are rejected with 401 (food search is coach-only in Phase 6)"
  artifacts:
    - path: "apps/trainer-web/src/app/api/nutrition/foods/route.ts"
      provides: "Food search API endpoint"
      exports: ["GET"]
  key_links:
    - from: "apps/trainer-web/src/app/api/nutrition/foods/route.ts"
      to: "food_items table"
      via: "Supabase ilike query on food_name"
      pattern: "supabase.from('food_items').select"
---

<objective>
Create the food search API route at GET /api/nutrition/foods?q=... that queries the food_items table and returns top 20 matches by name. This route is consumed by the Phase 7 plan builder's inline food search component.

Purpose: Building the API in Phase 6 removes a dependency from Phase 7, and validates the food_items table data is queryable.
Output: apps/trainer-web/src/app/api/nutrition/foods/route.ts
</objective>

<execution_context>
@C:/Users/Troy Morgan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Troy Morgan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-nutrition-foundation/06-CONTEXT.md
@.planning/phases/06-nutrition-foundation/06-01-SUMMARY.md

<interfaces>
<!-- API route pattern from existing codebase -->
From apps/trainer-web/src/app/api/my-accounts/transactions/route.ts:
```typescript
import { NextResponse } from "next/server";
import { createClient } from "@/lib/supabase/server";

// Get org_id helper:
async function getOrgId(supabase: Awaited<ReturnType<typeof createClient>>) {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return null;
  const { data: membership } = await supabase
    .from("org_members")
    .select("org_id")
    .eq("user_id", user.id)
    .single();
  return membership?.org_id ?? null;
}

export async function GET(request: Request) {
  try {
    const supabase = await createClient();
    const orgId = await getOrgId(supabase);
    if (!orgId) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }
    const url = new URL(request.url);
    // ... query params
    return NextResponse.json({ transactions: data });
  } catch (error) {
    return NextResponse.json({ error: "Failed to fetch" }, { status: 500 });
  }
}
```

<!-- food_items table columns: id, afcd_food_id, food_name, food_group, energy_kcal, protein_g, fat_g, carb_g, fibre_g -->
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GET /api/nutrition/foods route</name>
  <files>apps/trainer-web/src/app/api/nutrition/foods/route.ts</files>
  <action>
Create the directory `apps/trainer-web/src/app/api/nutrition/` and the file `apps/trainer-web/src/app/api/nutrition/foods/route.ts`.

Follow the existing API route pattern (see interfaces above):

```typescript
import { NextResponse } from "next/server";
import { createClient } from "@/lib/supabase/server";

async function getOrgId(supabase: Awaited<ReturnType<typeof createClient>>) {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return null;
  const { data: membership } = await supabase
    .from("org_members")
    .select("org_id")
    .eq("user_id", user.id)
    .single();
  return membership?.org_id ?? null;
}

export async function GET(request: Request) {
  try {
    const supabase = await createClient();
    const orgId = await getOrgId(supabase);
    if (!orgId) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    const url = new URL(request.url);
    const q = url.searchParams.get("q")?.trim() ?? "";

    if (!q || q.length < 2) {
      return NextResponse.json({ foods: [] });
    }

    const { data, error } = await supabase
      .from("food_items")
      .select("id, food_name, food_group, energy_kcal, protein_g, fat_g, carb_g, fibre_g")
      .ilike("food_name", `%${q}%`)
      .order("food_name", { ascending: true })
      .limit(20);

    if (error) {
      console.error("Food search error:", error);
      return NextResponse.json({ error: "Search failed" }, { status: 500 });
    }

    return NextResponse.json({ foods: data ?? [] });
  } catch (error) {
    console.error("Food search error:", error);
    return NextResponse.json({ error: "Search failed" }, { status: 500 });
  }
}
```

Notes:
- Minimum query length of 2 chars prevents full-table scans on single-keystroke inputs.
- Returning empty array (not error) for short/empty queries makes the Phase 7 UI simpler.
- `ilike` uses Postgres ILIKE which benefits from the pg_trgm GIN index created in migration 0041.
- No mock data fallback needed â€” if food_items is empty the array is just empty.
- The endpoint is authenticated (org_id check) because it's coach-side only in Phase 6. Phase 8 will need a portal variant if client-facing food display is needed.
  </action>
  <verify>
    <automated>node -e "const fs=require('fs'); const s=fs.readFileSync('apps/trainer-web/src/app/api/nutrition/foods/route.ts','utf8'); ['ilike','food_name','food_group','energy_kcal','protein_g','fat_g','carb_g','Unauthorized','limit(20)'].forEach(c=>{if(!s.includes(c))throw new Error('Missing: '+c);}); console.log('Route structure OK');" 2>&1</automated>
  </verify>
  <done>apps/trainer-web/src/app/api/nutrition/foods/route.ts exists. GET /api/nutrition/foods?q=chicken returns { foods: [...] } with up to 20 food_items rows. Unauthenticated requests return 401.</done>
</task>

</tasks>

<verification>
After food_items is seeded (Plan 02):
- `curl -H "Cookie: ..." "http://localhost:3000/api/nutrition/foods?q=chicken"` returns JSON with up to 20 food objects
- Each food object has: id, food_name, food_group, energy_kcal, protein_g, fat_g, carb_g, fibre_g
- `curl "http://localhost:3000/api/nutrition/foods?q=a"` (single char) returns `{ "foods": [] }`
- `curl "http://localhost:3000/api/nutrition/foods"` (no auth) returns 401
</verification>

<success_criteria>
GET /api/nutrition/foods?q=... returns up to 20 AFCD food matches in under 200ms. Response shape compatible with Phase 7 plan builder's autocomplete component.
</success_criteria>

<output>
After completion, create `.planning/phases/06-nutrition-foundation/06-03-SUMMARY.md`
</output>
