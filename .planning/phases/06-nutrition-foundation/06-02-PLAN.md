---
phase: 06-nutrition-foundation
plan: 02
type: execute
wave: 2
depends_on:
  - 06-01
files_modified:
  - apps/trainer-web/scripts/seed-afcd.ts
  - apps/trainer-web/package.json
autonomous: true
requirements:
  - NUTR-03

must_haves:
  truths:
    - "Running the seed script inserts ~1,588 rows into food_items"
    - "Each row has food_name, food_group, energy_kcal, protein_g, fat_g, carb_g populated (nulls acceptable for fibre_g if AFCD column absent)"
    - "afcd_food_id is populated from AFCD's public food ID column for deduplication"
    - "Re-running the script is safe (upsert on afcd_food_id — no duplicates)"
    - "The script reads the AFCD Excel file from a local path passed as CLI arg or from a well-known default path"
  artifacts:
    - path: "apps/trainer-web/scripts/seed-afcd.ts"
      provides: "One-time AFCD import script"
      contains: "upsert"
    - path: "apps/trainer-web/package.json"
      provides: "tsx dev dependency for running TypeScript scripts"
  key_links:
    - from: "seed-afcd.ts"
      to: "food_items table"
      via: "Supabase service role client upsert"
      pattern: "supabase.from('food_items').upsert"
---

<objective>
Write a one-time seed script at apps/trainer-web/scripts/seed-afcd.ts that parses the AFCD Release 3 Excel file and bulk-upserts all food records into the food_items Supabase table.

Purpose: Phase 7 (plan builder with food search) and Phase 8 (portal macros) depend on the food library being populated. This script runs once per environment.
Output: apps/trainer-web/scripts/seed-afcd.ts — executable via `npx tsx scripts/seed-afcd.ts path/to/AFCD.xlsx`
</objective>

<execution_context>
@C:/Users/Troy Morgan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Troy Morgan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-nutrition-foundation/06-CONTEXT.md
@.planning/phases/06-nutrition-foundation/06-01-SUMMARY.md

<interfaces>
<!-- food_items table schema from migration 0041 -->
```sql
CREATE TABLE food_items (
  id            uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  afcd_food_id  text UNIQUE,
  food_name     text NOT NULL,
  food_group    text,
  energy_kcal   numeric(8,2),
  protein_g     numeric(8,2),
  fat_g         numeric(8,2),
  carb_g        numeric(8,2),
  fibre_g       numeric(8,2),
  created_at    timestamptz DEFAULT now()
);
```

<!-- Supabase client pattern from codebase -->
From apps/trainer-web/src/lib/supabase/server.ts (use service role in scripts):
Use @supabase/supabase-js createClient with SUPABASE_URL + SUPABASE_SERVICE_ROLE_KEY env vars
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install tsx dependency and write seed script</name>
  <files>
    apps/trainer-web/scripts/seed-afcd.ts
    apps/trainer-web/package.json
  </files>
  <action>
**Step 1 — Ensure tsx is available.**

In `apps/trainer-web/package.json`, add `"tsx": "^4.0.0"` to `devDependencies` if not already present. Check first with `cat apps/trainer-web/package.json | grep tsx`. If already there, skip.

Run `npm install` in `apps/trainer-web/` to install it.

Also ensure `exceljs` is available — check `package.json`. If missing, add `"exceljs": "^4.4.0"` to dependencies and re-run install.

**Step 2 — Create `apps/trainer-web/scripts/seed-afcd.ts`.**

Create the `apps/trainer-web/scripts/` directory first (`mkdir -p apps/trainer-web/scripts`).

The script must:
1. Accept the AFCD Excel file path as a CLI argument (`process.argv[2]`). Exit with usage message if not provided.
2. Load the Excel file using `exceljs` (WorkbookReader for memory efficiency, or `readFile` for simplicity).
3. Identify the correct worksheet — AFCD Release 3 has a sheet called "All solids & liquids per 100g" or similar. Try the first worksheet if name lookup fails.
4. Read the header row to locate columns dynamically. AFCD column names to find (case-insensitive, partial match):
   - Food ID → `afcd_food_id` (column header contains "Public Food Key" or "Food ID")
   - Food Name → `food_name` (contains "Food Name")
   - Food Group → `food_group` (contains "Classification" or "Food Group")
   - Energy (kJ) → skip; use **Energy with dietary fibre (kcal)** or **Energy, without dietary fibre (kcal)** → `energy_kcal` (prefer "with dietary fibre", fall back to "without")
   - Protein → `protein_g` (contains "Protein")
   - Total fat → `fat_g` (contains "Fat, total")
   - Carbohydrate → `carb_g` (contains "Carbohydrate" and NOT "fructose" etc. — use the total carb column)
   - Dietary fibre → `fibre_g` (contains "Dietary fibre" or "Fibre, total dietary")
5. Skip header row and any rows where Food Name is empty.
6. Parse numeric values: strip whitespace, treat empty string / "N" / "–" / "-" as null. Use `parseFloat()`.
7. Build batches of 500 rows and upsert to Supabase using service role key:
   ```typescript
   await supabase.from('food_items').upsert(batch, { onConflict: 'afcd_food_id' });
   ```
8. Log progress: "Batch N/M inserted (X rows)" and final count.
9. Print total rows processed and total rows in food_items after seeding.

**Environment variables required:**
- `SUPABASE_URL` — e.g. `https://ntqdmgvxirswnjlnwopq.supabase.co`
- `SUPABASE_SERVICE_ROLE_KEY` — service role key (not anon key)

Load via `dotenv` from `apps/trainer-web/.env.local`:
```typescript
import 'dotenv/config'; // reads .env.local automatically if dotenv/config is available
// OR manually: import { config } from 'dotenv'; config({ path: '.env.local' });
```

Check if `dotenv` is in package.json — if not, add it. Most Next.js projects already have it.

**Full script structure:**
```typescript
#!/usr/bin/env tsx
import 'dotenv/config';
import ExcelJS from 'exceljs';
import { createClient } from '@supabase/supabase-js';

const SUPABASE_URL = process.env.SUPABASE_URL!;
const SUPABASE_SERVICE_ROLE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY!;
const BATCH_SIZE = 500;

async function main() {
  const filePath = process.argv[2];
  if (!filePath) {
    console.error('Usage: npx tsx scripts/seed-afcd.ts <path-to-AFCD.xlsx>');
    process.exit(1);
  }

  if (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE_KEY) {
    console.error('Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY in environment');
    process.exit(1);
  }

  const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);

  const workbook = new ExcelJS.Workbook();
  await workbook.xlsx.readFile(filePath);

  // ... column detection, row iteration, batch upsert logic
}

main().catch(console.error);
```

After writing the script, add a `scripts:seed-afcd` entry to `apps/trainer-web/package.json`:
```json
"scripts": {
  "seed-afcd": "tsx scripts/seed-afcd.ts"
}
```

**Important:** The AFCD Excel file will be provided by the user at runtime — do NOT attempt to download it. The script just needs to be ready. Document the download location in a comment at the top: `// AFCD Release 3 download: https://www.foodstandards.gov.au/science-data/monitoringnutrients/ausnut/fooddetails`
  </action>
  <verify>
    <automated>cd "C:/Users/Troy Morgan/OneDrive/coach-os/apps/trainer-web" && node -e "const fs=require('fs'); const s=fs.readFileSync('scripts/seed-afcd.ts','utf8'); const checks=['upsert','afcd_food_id','BATCH_SIZE','food_items','exceljs','SUPABASE_SERVICE_ROLE_KEY']; checks.forEach(c=>{if(!s.includes(c))throw new Error('Missing: '+c);}); console.log('Script structure OK');" 2>&1</automated>
  </verify>
  <done>apps/trainer-web/scripts/seed-afcd.ts exists with column auto-detection, batch upsert, and progress logging. exceljs is in package.json. Running `npx tsx scripts/seed-afcd.ts path/to/afcd.xlsx` from apps/trainer-web/ would execute the import.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Seed script at apps/trainer-web/scripts/seed-afcd.ts is ready to import AFCD Release 3 data into the food_items table. The script auto-detects columns from the Excel header row and upserts in batches of 500.

    The AFCD Excel file is NOT included in the repo — you need to download it and run the script.
  </what-built>
  <how-to-verify>
    1. Download AFCD Release 3 Excel from: https://www.foodstandards.gov.au/science-data/monitoringnutrients/ausnut/fooddetails
       Look for "AFCD Release 3" — download the "Food Composition Data" Excel file.

    2. From the apps/trainer-web/ directory, run:
       ```
       npx tsx scripts/seed-afcd.ts /path/to/afcd-release3.xlsx
       ```
       (Make sure SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY are in .env.local)

    3. Verify in Supabase dashboard or via SQL:
       ```sql
       SELECT count(*) FROM food_items;
       -- Expected: ~1,588

       SELECT food_name, food_group, energy_kcal, protein_g, fat_g, carb_g
       FROM food_items
       LIMIT 5;
       -- Expected: real food names with numeric macro values
       ```

    4. Type "seeded" if the count is approximately correct (1,400–1,700 rows), or describe any issues.
  </how-to-verify>
  <resume-signal>Type "seeded" to confirm ~1,588 rows inserted, or describe any parsing issues for fixes.</resume-signal>
</task>

</tasks>

<verification>
- `SELECT count(*) FROM food_items` returns approximately 1,400–1,700 rows
- `SELECT food_name, energy_kcal, protein_g FROM food_items WHERE food_name ILIKE '%chicken%' LIMIT 3` returns rows with numeric macro values
- Re-running seed script produces no new rows (upsert is idempotent)
</verification>

<success_criteria>
food_items table populated with ~1,588 AFCD Australian food records. Each row has food_name (required), food_group, and at least energy_kcal, protein_g, fat_g, carb_g populated. Seed script is idempotent.
</success_criteria>

<output>
After completion, create `.planning/phases/06-nutrition-foundation/06-02-SUMMARY.md`
</output>
