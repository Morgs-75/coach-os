---
phase: 06-nutrition-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/0041_nutrition_foundation.sql
autonomous: true
requirements:
  - NUTR-01
  - NUTR-02

must_haves:
  truths:
    - "food_items table exists with columns: id, afcd_food_id, food_name, food_group, energy_kcal, protein_g, fat_g, carb_g, fibre_g, created_at"
    - "meal_plans table exists with org-scoped client assignment, date range, status (draft/published), version, and published_at"
    - "meal_plan_days, meal_plan_meals, meal_plan_components tables exist and enforce referential integrity"
    - "RLS policies allow coach (org_member) to read/write their org's plans"
    - "food_items is public read (no RLS restriction) so food search works without org context"
  artifacts:
    - path: "supabase/migrations/0041_nutrition_foundation.sql"
      provides: "All 5 nutrition tables with constraints and RLS"
      contains: "CREATE TABLE food_items"
  key_links:
    - from: "meal_plan_components"
      to: "food_items"
      via: "food_item_id FK"
      pattern: "REFERENCES food_items"
    - from: "meal_plan_components"
      to: "meal_plan_meals"
      via: "meal_id FK"
      pattern: "REFERENCES meal_plan_meals"
    - from: "meal_plans"
      to: "clients"
      via: "client_id FK"
      pattern: "REFERENCES clients"
---

<objective>
Create Supabase migration 0041 that defines the complete nutrition data model: food_items, meal_plans, meal_plan_days, meal_plan_meals, and meal_plan_components.

Purpose: All downstream plans (seed script, food search API, /nutrition page) depend on these tables existing.
Output: supabase/migrations/0041_nutrition_foundation.sql — ready to apply via Supabase Management API.
</objective>

<execution_context>
@C:/Users/Troy Morgan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Troy Morgan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-nutrition-foundation/06-CONTEXT.md

<!-- Existing migration for reference pattern -->
@supabase/migrations/0040_client_purchases_session_duration.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write migration 0041_nutrition_foundation.sql</name>
  <files>supabase/migrations/0041_nutrition_foundation.sql</files>
  <action>
Create the file at supabase/migrations/0041_nutrition_foundation.sql with the following:

**Table: food_items** (global, no org_id — AFCD data is shared across all orgs)
```sql
CREATE TABLE food_items (
  id            uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  afcd_food_id  text UNIQUE,           -- AFCD internal ID for dedup on re-seed
  food_name     text NOT NULL,
  food_group    text,
  energy_kcal   numeric(8,2),
  protein_g     numeric(8,2),
  fat_g         numeric(8,2),
  carb_g        numeric(8,2),
  fibre_g       numeric(8,2),
  created_at    timestamptz DEFAULT now()
);
```
RLS: Enable RLS but add a public SELECT policy (food search must work without auth context). No INSERT/UPDATE/DELETE for non-service-role (seed script uses service role key).

**Table: meal_plans**
```sql
CREATE TABLE meal_plans (
  id            uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id        uuid NOT NULL REFERENCES orgs(id) ON DELETE CASCADE,
  client_id     uuid REFERENCES clients(id) ON DELETE SET NULL,
  created_by    uuid REFERENCES auth.users(id) ON DELETE SET NULL,
  name          text NOT NULL,
  start_date    date,
  end_date      date,
  status        text NOT NULL DEFAULT 'draft' CHECK (status IN ('draft', 'published')),
  version       integer NOT NULL DEFAULT 1,
  published_at  timestamptz,
  created_at    timestamptz DEFAULT now(),
  updated_at    timestamptz DEFAULT now()
);
```
RLS: Enable RLS. Policy: coach can SELECT/INSERT/UPDATE/DELETE where org_id = their org_id (via org_members join). Pattern matches how other org-scoped tables are protected in this codebase — check auth.uid() in a subquery on org_members.

**Table: meal_plan_days**
```sql
CREATE TABLE meal_plan_days (
  id          uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  plan_id     uuid NOT NULL REFERENCES meal_plans(id) ON DELETE CASCADE,
  day_number  integer NOT NULL,           -- 1-based (Day 1, Day 2 etc.)
  date        date,                       -- optional calendar date
  created_at  timestamptz DEFAULT now(),
  UNIQUE(plan_id, day_number)
);
```
RLS: Enable RLS. Policy: SELECT/INSERT/UPDATE/DELETE where plan_id is in a plan belonging to the coach's org.

**Table: meal_plan_meals**
```sql
CREATE TABLE meal_plan_meals (
  id         uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  day_id     uuid NOT NULL REFERENCES meal_plan_days(id) ON DELETE CASCADE,
  meal_type  text NOT NULL CHECK (meal_type IN ('breakfast', 'morning_snack', 'lunch', 'afternoon_snack', 'dinner', 'evening_snack', 'other')),
  title      text,                        -- e.g. "Pre-workout meal"
  note       text,
  sort_order integer NOT NULL DEFAULT 0,
  created_at timestamptz DEFAULT now()
);
```
RLS: Enable RLS. Policy: SELECT/INSERT/UPDATE/DELETE where day_id resolves back to a plan in the coach's org (via meal_plan_days JOIN meal_plans).

**Table: meal_plan_components**
```sql
CREATE TABLE meal_plan_components (
  id           uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  meal_id      uuid NOT NULL REFERENCES meal_plan_meals(id) ON DELETE CASCADE,
  food_item_id uuid REFERENCES food_items(id) ON DELETE SET NULL,
  qty_g        numeric(8,2) NOT NULL DEFAULT 100,
  custom_name  text,                      -- override display name (e.g. "1 medium egg")
  sort_order   integer NOT NULL DEFAULT 0,
  created_at   timestamptz DEFAULT now()
);
```
RLS: Enable RLS. Policy: SELECT/INSERT/UPDATE/DELETE where meal_id resolves back to a plan in the coach's org.

**Index:** Add GIN index on food_items.food_name for fast full-text search:
```sql
CREATE INDEX food_items_name_gin ON food_items USING gin(to_tsvector('english', food_name));
```
Also add a plain btree index for ILIKE queries as fallback:
```sql
CREATE INDEX food_items_name_trgm ON food_items USING gin(food_name gin_trgm_ops);
```
Note: pg_trgm extension must be enabled. Add `CREATE EXTENSION IF NOT EXISTS pg_trgm;` at the top of the migration.

Add a header comment: `-- Migration 0041: nutrition foundation tables (food_items, meal_plans, meal_plan_days, meal_plan_meals, meal_plan_components)`

For RLS policies on meal_plan_days/meals/components that need to walk back to org_id, use EXISTS subqueries rather than JOINs for clarity:
```sql
-- Example for meal_plan_days:
CREATE POLICY "org members can manage plan days" ON meal_plan_days
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM meal_plans mp
      JOIN org_members om ON om.org_id = mp.org_id
      WHERE mp.id = meal_plan_days.plan_id
        AND om.user_id = auth.uid()
    )
  );
```
Apply the same pattern (adjusting the chain) for meal_plan_meals (via meal_plan_days -> meal_plans) and meal_plan_components (via meal_plan_meals -> meal_plan_days -> meal_plans).
  </action>
  <verify>
    <automated>node -e "const fs=require('fs'); const sql=fs.readFileSync('supabase/migrations/0041_nutrition_foundation.sql','utf8'); const checks=['food_items','meal_plans','meal_plan_days','meal_plan_meals','meal_plan_components','pg_trgm','food_items_name_gin','CHECK (status IN']; checks.forEach(c=>{if(!sql.includes(c))throw new Error('Missing: '+c);}); console.log('All checks pass');" 2>&1</automated>
  </verify>
  <done>File supabase/migrations/0041_nutrition_foundation.sql exists. Contains all 5 CREATE TABLE statements, pg_trgm extension, GIN indexes, and RLS policies for all tables. The file can be applied to Supabase via Management API.</done>
</task>

<task type="auto">
  <name>Task 2: Apply migration via Supabase Management API</name>
  <files></files>
  <action>
Apply the migration to the production Supabase database using the Management API pattern established in this project. The Supabase project ref is `ntqdmgvxirswnjlnwopq`.

Use the PowerShell credential helper pattern to retrieve the PAT from Windows Credential Manager (see MEMORY.md: `get_cred.ps1` pattern using WinCred advapi32 CredReadW). Then POST the SQL to:

```
POST https://api.supabase.com/v1/projects/ntqdmgvxirswnjlnwopq/database/query
Authorization: Bearer {PAT}
Content-Type: application/json
Body: { "query": "{contents of 0041_nutrition_foundation.sql}" }
```

After applying, verify the tables exist by querying:
```sql
SELECT table_name FROM information_schema.tables
WHERE table_schema = 'public'
  AND table_name IN ('food_items','meal_plans','meal_plan_days','meal_plan_meals','meal_plan_components')
ORDER BY table_name;
```
Expected: 5 rows returned.

If the pg_trgm extension fails (already exists), that is fine — the `IF NOT EXISTS` guard handles it.
  </action>
  <verify>
    <automated>powershell -Command "$pat = (.\get_cred.ps1 'Supabase CLI:supabase' 2>/dev/null || echo ''); if (!$pat) { Write-Host 'PAT retrieval: use manual API call'; exit 0 }; $body = @{query='SELECT count(*) FROM information_schema.tables WHERE table_schema=''public'' AND table_name IN (''food_items'',''meal_plans'',''meal_plan_days'',''meal_plan_meals'',''meal_plan_components'')'} | ConvertTo-Json; $r=Invoke-RestMethod -Uri 'https://api.supabase.com/v1/projects/ntqdmgvxirswnjlnwopq/database/query' -Method POST -Headers @{Authorization='Bearer '+$pat;'Content-Type'='application/json'} -Body $body; Write-Host ($r | ConvertTo-Json)" 2>&1 || echo "Verify manually: SELECT count(*) FROM information_schema.tables WHERE table_name IN ('food_items','meal_plans','meal_plan_days','meal_plan_meals','meal_plan_components') should return 5"</automated>
  </verify>
  <done>All 5 tables exist in the public schema of the Supabase project. Migration applied successfully.</done>
</task>

</tasks>

<verification>
- `SELECT table_name FROM information_schema.tables WHERE table_schema='public' AND table_name IN ('food_items','meal_plans','meal_plan_days','meal_plan_meals','meal_plan_components') ORDER BY table_name;` returns 5 rows
- `\d food_items` shows columns: id, afcd_food_id, food_name, food_group, energy_kcal, protein_g, fat_g, carb_g, fibre_g, created_at
- `\d meal_plans` shows status column with CHECK constraint for 'draft'/'published'
- `SELECT count(*) FROM pg_indexes WHERE tablename = 'food_items';` returns at least 2 (GIN indexes)
</verification>

<success_criteria>
All 5 nutrition tables exist in Supabase with correct schema, RLS policies, and indexes. Downstream plans (seed script, food search API, /nutrition page) can proceed.
</success_criteria>

<output>
After completion, create `.planning/phases/06-nutrition-foundation/06-01-SUMMARY.md`
</output>
