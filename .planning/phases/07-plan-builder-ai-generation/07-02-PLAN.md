---
phase: 07-plan-builder-ai-generation
plan: 02
type: execute
wave: 2
depends_on:
  - 07-01
files_modified:
  - apps/trainer-web/src/app/(app)/nutrition/[planId]/PlanBuilderClient.tsx
  - apps/trainer-web/src/app/api/nutrition/plans/[planId]/meals/route.ts
  - apps/trainer-web/src/app/api/nutrition/plans/[planId]/meals/[mealId]/route.ts
  - apps/trainer-web/src/app/api/nutrition/plans/[planId]/meals/[mealId]/components/route.ts
  - apps/trainer-web/src/app/api/nutrition/plans/[planId]/meals/[mealId]/components/[componentId]/route.ts
autonomous: true
requirements:
  - NUTR-08
  - NUTR-09

must_haves:
  truths:
    - "Coach can add a meal to a selected day by clicking 'Add Meal', choosing a meal type, and submitting"
    - "Each meal card has a '+ Add Component' row that opens an inline food search input"
    - "Typing 2+ characters in the food search shows a dropdown of matching AFCD foods from /api/nutrition/foods"
    - "Selecting a food from the dropdown adds a component row with default qty 100g"
    - "Qty input is editable inline; changing it immediately updates the displayed macro values for that row"
    - "Meal totals (kcal, protein, carbs, fat) are summed from all components and shown in the meal card footer"
    - "Day totals (kcal, protein, carbs, fat) are summed from all meals and shown below all meal cards"
    - "POST /api/nutrition/plans/[planId]/meals creates a meal_plan_meals row"
    - "POST /api/nutrition/plans/[planId]/meals/[mealId]/components creates a meal_plan_components row"
    - "PATCH /api/nutrition/plans/[planId]/meals/[mealId]/components/[componentId] updates qty_g or custom_name"
    - "DELETE /api/nutrition/plans/[planId]/meals/[mealId]/components/[componentId] removes a component"
  artifacts:
    - path: "apps/trainer-web/src/app/api/nutrition/plans/[planId]/meals/route.ts"
      provides: "POST — add meal to a day"
    - path: "apps/trainer-web/src/app/api/nutrition/plans/[planId]/meals/[mealId]/components/route.ts"
      provides: "POST — add component to a meal"
    - path: "apps/trainer-web/src/app/api/nutrition/plans/[planId]/meals/[mealId]/components/[componentId]/route.ts"
      provides: "PATCH qty_g/custom_name, DELETE component"
  key_links:
    - from: "PlanBuilderClient.tsx (DayPanel)"
      to: "/api/nutrition/plans/[planId]/meals"
      via: "POST on Add Meal submit"
      pattern: "fetch.*meals.*POST"
    - from: "PlanBuilderClient.tsx (FoodSearchInput)"
      to: "/api/nutrition/foods"
      via: "GET with ?q= on keypress"
      pattern: "fetch.*api/nutrition/foods"
    - from: "PlanBuilderClient.tsx (ComponentRow)"
      to: "/api/nutrition/plans/[planId]/meals/[mealId]/components/[componentId]"
      via: "PATCH on qty change blur, DELETE on remove click"
      pattern: "fetch.*components.*PATCH|DELETE"
---

<objective>
Wire up meal CRUD and inline food search so coaches can build out a day's meals and components with auto-calculated macros.

Purpose: This plan is the core editing functionality of the plan builder. When complete, a coach can manually compose a full meal plan from AFCD foods with real macro numbers.
Output: 4 new API routes + PlanBuilderClient.tsx updated with Add Meal modal, inline food search, component rows, meal totals, and day totals.
</objective>

<execution_context>
@C:/Users/Troy Morgan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Troy Morgan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-plan-builder-ai-generation/07-01-SUMMARY.md

<interfaces>
<!-- Tables referenced -->
<!-- meal_plan_meals: id, day_id, meal_type, title, note, sort_order, created_at -->
<!-- meal_plan_components: id, meal_id, food_item_id, qty_g, custom_name, sort_order, created_at -->
<!-- food_items: id, food_name, food_group, energy_kcal, protein_g, fat_g, carb_g, fibre_g -->

<!-- Existing food search API -->
<!-- GET /api/nutrition/foods?q=chicken returns { foods: [{ id, food_name, food_group, energy_kcal, protein_g, fat_g, carb_g, fibre_g }] } -->
<!-- Minimum 2-char query; empty array returned for short/empty queries -->

<!-- Macro calculation rule (all values per 100g in DB) -->
<!--   scaled_value = db_value_per_100g * (qty_g / 100) -->
<!--   Round to 1 decimal place for display -->
<!--   Sum across components for meal total; sum meal totals for day total -->

<!-- meal_type values: breakfast, morning_snack, lunch, afternoon_snack, dinner, evening_snack, other -->

<!-- API route pattern for nested dynamic segments -->
<!-- apps/trainer-web/src/app/api/nutrition/plans/[planId]/meals/[mealId]/components/[componentId]/route.ts -->
<!-- params is a Promise in Next.js 15: const { planId, mealId, componentId } = await params; -->

<!-- Inline food search UX pattern -->
<!--
  1. Component row shows a text input with placeholder "Search food…"
  2. On input change (>=2 chars): fetch /api/nutrition/foods?q=... after 200ms debounce
  3. Dropdown appears below input showing food_name + food_group
  4. Click selects food: POST to /api/nutrition/plans/[planId]/meals/[mealId]/components
       body: { food_item_id: food.id, qty_g: 100, custom_name: null }
  5. Dropdown closes, search input resets to "" for next component
-->

<!-- Qty editing -->
<!--
  - Each component row shows an <input type="number" min="1" step="1"> for qty_g
  - onChange: update local state (optimistic)
  - onBlur: PATCH /api/nutrition/plans/[planId]/meals/[mealId]/components/[componentId] with { qty_g: newValue }
  - Macros re-compute immediately from local state on onChange (no API call needed for display)
-->
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create meals and components API routes</name>
  <files>
    apps/trainer-web/src/app/api/nutrition/plans/[planId]/meals/route.ts
    apps/trainer-web/src/app/api/nutrition/plans/[planId]/meals/[mealId]/route.ts
    apps/trainer-web/src/app/api/nutrition/plans/[planId]/meals/[mealId]/components/route.ts
    apps/trainer-web/src/app/api/nutrition/plans/[planId]/meals/[mealId]/components/[componentId]/route.ts
  </files>
  <action>
All routes follow the same auth pattern: createClient → getOrgId → verify plan ownership → operate.

**Helper for ownership verification (repeat inline in each file — no shared module needed):**
```typescript
async function verifyPlanOwnership(supabase, planId: string, orgId: string): Promise<boolean> {
  const { data } = await supabase
    .from("meal_plans")
    .select("id")
    .eq("id", planId)
    .eq("org_id", orgId)
    .single();
  return !!data;
}
```

---

**1. apps/trainer-web/src/app/api/nutrition/plans/[planId]/meals/route.ts**

POST — add a meal to a day:
```typescript
export async function POST(
  request: Request,
  { params }: { params: Promise<{ planId: string }> }
) {
  const { planId } = await params;
  // auth + ownership check
  const body = await request.json();
  const { day_id, meal_type, title = null, note = null } = body;
  if (!day_id || !meal_type) return 400 "day_id and meal_type are required"

  // Verify day belongs to this plan
  const { data: dayCheck } = await supabase
    .from("meal_plan_days")
    .select("id")
    .eq("id", day_id)
    .eq("plan_id", planId)
    .single();
  if (!dayCheck) return 404 "Day not found"

  // Determine sort_order (max existing + 1)
  const { data: existing } = await supabase
    .from("meal_plan_meals")
    .select("sort_order")
    .eq("day_id", day_id)
    .order("sort_order", { ascending: false })
    .limit(1);
  const sort_order = existing && existing.length > 0 ? existing[0].sort_order + 1 : 0;

  const { data, error } = await supabase
    .from("meal_plan_meals")
    .insert({ day_id, meal_type, title, note, sort_order })
    .select()
    .single();

  return 201 { meal: data }
}
```

---

**2. apps/trainer-web/src/app/api/nutrition/plans/[planId]/meals/[mealId]/route.ts**

PATCH — update meal title/note/meal_type:
```typescript
export async function PATCH(
  request: Request,
  { params }: { params: Promise<{ planId: string; mealId: string }> }
) {
  const { planId, mealId } = await params;
  // auth + ownership check
  const body = await request.json();
  const allowedFields = ["meal_type", "title", "note", "sort_order"];
  const updates: Record<string, unknown> = {};
  for (const f of allowedFields) { if (f in body) updates[f] = body[f]; }

  const { data, error } = await supabase
    .from("meal_plan_meals")
    .update(updates)
    .eq("id", mealId)
    .select()
    .single();

  // Note: RLS on meal_plan_meals already ensures the meal belongs to an org the coach can access.
  // No explicit plan_id WHERE needed — RLS enforces it via the EXISTS chain.
  return { meal: data }
}

DELETE — remove a meal (CASCADE deletes its components):
export async function DELETE(
  request: Request,
  { params }: { params: Promise<{ planId: string; mealId: string }> }
) {
  const { planId, mealId } = await params;
  // auth + ownership check
  await supabase.from("meal_plan_meals").delete().eq("id", mealId);
  return 204
}
```

---

**3. apps/trainer-web/src/app/api/nutrition/plans/[planId]/meals/[mealId]/components/route.ts**

POST — add a component to a meal:
```typescript
export async function POST(
  request: Request,
  { params }: { params: Promise<{ planId: string; mealId: string }> }
) {
  const { planId, mealId } = await params;
  // auth + ownership check
  const body = await request.json();
  const { food_item_id = null, qty_g = 100, custom_name = null } = body;

  // Determine sort_order
  const { data: existing } = await supabase
    .from("meal_plan_components")
    .select("sort_order")
    .eq("meal_id", mealId)
    .order("sort_order", { ascending: false })
    .limit(1);
  const sort_order = existing && existing.length > 0 ? existing[0].sort_order + 1 : 0;

  const { data, error } = await supabase
    .from("meal_plan_components")
    .insert({ meal_id: mealId, food_item_id, qty_g, custom_name, sort_order })
    .select(`*, food_item:food_items(id, food_name, food_group, energy_kcal, protein_g, fat_g, carb_g, fibre_g)`)
    .single();

  return 201 { component: data }
}
```

---

**4. apps/trainer-web/src/app/api/nutrition/plans/[planId]/meals/[mealId]/components/[componentId]/route.ts**

PATCH — update qty_g or custom_name:
```typescript
export async function PATCH(
  request: Request,
  { params }: { params: Promise<{ planId: string; mealId: string; componentId: string }> }
) {
  const { componentId } = await params;
  // auth + ownership check via planId
  const body = await request.json();
  const updates: Record<string, unknown> = {};
  if ("qty_g" in body) updates.qty_g = Number(body.qty_g);
  if ("custom_name" in body) updates.custom_name = body.custom_name;

  const { data, error } = await supabase
    .from("meal_plan_components")
    .update(updates)
    .eq("id", componentId)
    .select(`*, food_item:food_items(id, food_name, food_group, energy_kcal, protein_g, fat_g, carb_g, fibre_g)`)
    .single();

  return { component: data }
}

DELETE — remove a component:
export async function DELETE(
  request: Request,
  { params }: { params: Promise<{ planId: string; mealId: string; componentId: string }> }
) {
  const { componentId } = await params;
  // auth + ownership check via planId
  await supabase.from("meal_plan_components").delete().eq("id", componentId);
  return 204
}
```

Write all 4 files as valid TypeScript, using the existing patterns (NextResponse, createClient from @/lib/supabase/server, try/catch, 401/404/500 error shapes). All pseudocode above must be converted to real TypeScript.
  </action>
  <verify>
    <automated>node -e "
const fs = require('fs');
const files = [
  'apps/trainer-web/src/app/api/nutrition/plans/[planId]/meals/route.ts',
  'apps/trainer-web/src/app/api/nutrition/plans/[planId]/meals/[mealId]/route.ts',
  'apps/trainer-web/src/app/api/nutrition/plans/[planId]/meals/[mealId]/components/route.ts',
  'apps/trainer-web/src/app/api/nutrition/plans/[planId]/meals/[mealId]/components/[componentId]/route.ts',
];
files.forEach(f => { if (!fs.existsSync(f)) throw new Error('Missing: ' + f); });
const meals = fs.readFileSync(files[0], 'utf8');
['meal_plan_meals','day_id','meal_type','sort_order'].forEach(k => { if (!meals.includes(k)) throw new Error('meals route missing: ' + k); });
const comps = fs.readFileSync(files[2], 'utf8');
['meal_plan_components','food_item_id','qty_g','food_items'].forEach(k => { if (!comps.includes(k)) throw new Error('components route missing: ' + k); });
const compId = fs.readFileSync(files[3], 'utf8');
['PATCH','DELETE','qty_g'].forEach(k => { if (!compId.includes(k)) throw new Error('component[id] route missing: ' + k); });
console.log('All meal/component routes OK');
" 2>&1</automated>
  </verify>
  <done>4 API routes created: POST meals, PATCH/DELETE meal, POST components, PATCH/DELETE component. All are org-scoped via plan ownership check and RLS. Component POST returns food_item join for immediate macro display.</done>
</task>

<task type="auto">
  <name>Task 2: Update PlanBuilderClient with Add Meal, food search, component rows, and macro totals</name>
  <files>
    apps/trainer-web/src/app/(app)/nutrition/[planId]/PlanBuilderClient.tsx
  </files>
  <action>
Rewrite `apps/trainer-web/src/app/(app)/nutrition/[planId]/PlanBuilderClient.tsx` to add meal editing and food search. Keep all existing types and helpers from Plan 01. Add the following:

---

**State additions to PlanBuilderClient:**
```typescript
// No new top-level state needed — meal/component state lives inside DayPanel
```

---

**Replace the DayPanel component** (was read-only in Plan 01) with a fully interactive version:

```typescript
function DayPanel({
  day,
  planId,
  onDayUpdated,
}: {
  day: Day;
  planId: string;
  onDayUpdated: (updatedDay: Day) => void;
}) {
  const [showAddMeal, setShowAddMeal] = useState(false);
  const [mealType, setMealType] = useState<string>("breakfast");
  const [mealTitle, setMealTitle] = useState("");
  const [addingMeal, setAddingMeal] = useState(false);

  // Compute day totals from local state
  const dayTotals = computeTotals(day.meals.flatMap((m) => m.components));

  async function handleAddMeal(e: React.FormEvent) {
    e.preventDefault();
    setAddingMeal(true);
    try {
      const res = await fetch(`/api/nutrition/plans/${planId}/meals`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          day_id: day.id,
          meal_type: mealType,
          title: mealTitle.trim() || null,
        }),
      });
      if (res.ok) {
        const data = await res.json();
        const newMeal: Meal = { ...data.meal, components: [] };
        onDayUpdated({ ...day, meals: [...day.meals, newMeal] });
        setShowAddMeal(false);
        setMealTitle("");
        setMealType("breakfast");
      }
    } finally {
      setAddingMeal(false);
    }
  }

  function handleMealUpdated(updatedMeal: Meal) {
    onDayUpdated({
      ...day,
      meals: day.meals.map((m) => (m.id === updatedMeal.id ? updatedMeal : m)),
    });
  }

  function handleMealDeleted(mealId: string) {
    onDayUpdated({ ...day, meals: day.meals.filter((m) => m.id !== mealId) });
  }

  const MEAL_TYPE_OPTIONS = [
    { value: "breakfast", label: "Breakfast" },
    { value: "morning_snack", label: "Morning Snack" },
    { value: "lunch", label: "Lunch" },
    { value: "afternoon_snack", label: "Afternoon Snack" },
    { value: "dinner", label: "Dinner" },
    { value: "evening_snack", label: "Evening Snack" },
    { value: "other", label: "Other" },
  ];

  const inputClass = "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 dark:bg-gray-800 dark:text-gray-100";

  return (
    <div className="space-y-4">
      {/* Day header */}
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-lg font-semibold text-gray-900 dark:text-gray-100">
            Day {day.day_number}
          </h2>
          {day.date && (
            <p className="text-sm text-gray-500 dark:text-gray-400">
              {new Date(day.date).toLocaleDateString("en-AU", {
                weekday: "long", day: "numeric", month: "long",
              })}
            </p>
          )}
        </div>
        <button
          onClick={() => setShowAddMeal(true)}
          className="bg-brand-600 text-white px-3 py-1.5 rounded-lg text-sm font-medium hover:bg-brand-700 transition-colors"
        >
          + Add Meal
        </button>
      </div>

      {/* Add meal form (inline) */}
      {showAddMeal && (
        <div className="bg-white dark:bg-gray-900 border border-brand-200 dark:border-brand-800 rounded-xl p-4">
          <form onSubmit={handleAddMeal} className="space-y-3">
            <div className="flex gap-3">
              <select
                value={mealType}
                onChange={(e) => setMealType(e.target.value)}
                className={inputClass + " flex-1"}
              >
                {MEAL_TYPE_OPTIONS.map((o) => (
                  <option key={o.value} value={o.value}>{o.label}</option>
                ))}
              </select>
              <input
                type="text"
                placeholder="Custom title (optional)"
                value={mealTitle}
                onChange={(e) => setMealTitle(e.target.value)}
                className={inputClass + " flex-1"}
              />
            </div>
            <div className="flex justify-end gap-2">
              <button
                type="button"
                onClick={() => { setShowAddMeal(false); setMealTitle(""); }}
                className="px-3 py-1.5 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100"
              >
                Cancel
              </button>
              <button
                type="submit"
                disabled={addingMeal}
                className="bg-brand-600 text-white px-4 py-1.5 rounded-lg text-sm font-medium hover:bg-brand-700 disabled:opacity-50 flex items-center gap-2"
              >
                {addingMeal && <span className="w-3 h-3 border-2 border-white/50 border-t-white rounded-full animate-spin" />}
                Add Meal
              </button>
            </div>
          </form>
        </div>
      )}

      {/* Meals */}
      {day.meals.length === 0 && !showAddMeal ? (
        <div className="bg-white dark:bg-gray-900 border border-dashed border-gray-300 dark:border-gray-700 rounded-xl p-8 text-center">
          <p className="text-gray-400 dark:text-gray-500 text-sm">
            No meals yet. Add a meal to get started.
          </p>
        </div>
      ) : (
        <div className="space-y-3">
          {day.meals.map((meal) => (
            <MealCard
              key={meal.id}
              meal={meal}
              planId={planId}
              onMealUpdated={handleMealUpdated}
              onMealDeleted={handleMealDeleted}
            />
          ))}
        </div>
      )}

      {/* Day totals */}
      {day.meals.length > 0 && (
        <MacroBar label="Day total" totals={dayTotals} highlight />
      )}
    </div>
  );
}
```

---

**Replace the MealCard component** with an interactive version:

```typescript
function MealCard({
  meal,
  planId,
  onMealUpdated,
  onMealDeleted,
}: {
  meal: Meal;
  planId: string;
  onMealUpdated: (m: Meal) => void;
  onMealDeleted: (id: string) => void;
}) {
  const label = MEAL_TYPE_LABELS[meal.meal_type] ?? meal.meal_type;
  const mealTotals = computeTotals(meal.components);

  async function handleDeleteMeal() {
    if (!confirm("Delete this meal?")) return;
    await fetch(`/api/nutrition/plans/${planId}/meals/${meal.id}`, { method: "DELETE" });
    onMealDeleted(meal.id);
  }

  function handleComponentUpdated(updated: Component) {
    onMealUpdated({
      ...meal,
      components: meal.components.map((c) => (c.id === updated.id ? updated : c)),
    });
  }

  function handleComponentAdded(added: Component) {
    onMealUpdated({ ...meal, components: [...meal.components, added] });
  }

  function handleComponentDeleted(id: string) {
    onMealUpdated({ ...meal, components: meal.components.filter((c) => c.id !== id) });
  }

  return (
    <div className="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl overflow-hidden">
      {/* Meal header */}
      <div className="flex items-center justify-between px-4 py-3 border-b border-gray-100 dark:border-gray-800">
        <div>
          <span className="text-xs font-semibold uppercase tracking-wider text-brand-600 dark:text-brand-400">
            {label}
          </span>
          {meal.title && (
            <p className="text-sm font-medium text-gray-900 dark:text-gray-100">{meal.title}</p>
          )}
        </div>
        <button
          onClick={handleDeleteMeal}
          className="text-xs text-gray-400 hover:text-red-500 transition-colors"
        >
          Remove
        </button>
      </div>

      {/* Components table */}
      <div className="px-4 pt-2 pb-1">
        {meal.components.length > 0 && (
          <table className="w-full text-xs mb-2">
            <thead>
              <tr className="text-gray-400 dark:text-gray-500">
                <th className="text-left font-normal pb-1 pr-2">Food</th>
                <th className="text-right font-normal pb-1 px-1 w-20">Qty (g)</th>
                <th className="text-right font-normal pb-1 px-1 w-14">kcal</th>
                <th className="text-right font-normal pb-1 px-1 w-12">P (g)</th>
                <th className="text-right font-normal pb-1 px-1 w-12">C (g)</th>
                <th className="text-right font-normal pb-1 px-1 w-12">F (g)</th>
                <th className="w-6" />
              </tr>
            </thead>
            <tbody>
              {meal.components.map((c) => (
                <ComponentRow
                  key={c.id}
                  component={c}
                  planId={planId}
                  mealId={meal.id}
                  onUpdated={handleComponentUpdated}
                  onDeleted={handleComponentDeleted}
                />
              ))}
            </tbody>
          </table>
        )}
        {/* Inline food search */}
        <FoodSearchInput
          planId={planId}
          mealId={meal.id}
          onAdded={handleComponentAdded}
        />
      </div>

      {/* Meal totals */}
      {meal.components.length > 0 && (
        <div className="px-4 pb-3">
          <MacroBar label="Meal total" totals={mealTotals} />
        </div>
      )}
    </div>
  );
}
```

---

**ComponentRow component:**

```typescript
function ComponentRow({
  component,
  planId,
  mealId,
  onUpdated,
  onDeleted,
}: {
  component: Component;
  planId: string;
  mealId: string;
  onUpdated: (c: Component) => void;
  onDeleted: (id: string) => void;
}) {
  const [qty, setQty] = useState(String(component.qty_g));

  const scale = Number(qty) / 100;
  const kcal = component.food_item?.energy_kcal != null ? +(component.food_item.energy_kcal * scale).toFixed(1) : null;
  const p = component.food_item?.protein_g != null ? +(component.food_item.protein_g * scale).toFixed(1) : null;
  const carb = component.food_item?.carb_g != null ? +(component.food_item.carb_g * scale).toFixed(1) : null;
  const fat = component.food_item?.fat_g != null ? +(component.food_item.fat_g * scale).toFixed(1) : null;
  const name = component.custom_name ?? component.food_item?.food_name ?? "Unknown";

  async function handleQtyBlur() {
    const newQty = Math.max(1, Number(qty) || 100);
    setQty(String(newQty));
    if (newQty === component.qty_g) return; // no change
    const res = await fetch(
      `/api/nutrition/plans/${planId}/meals/${mealId}/components/${component.id}`,
      {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ qty_g: newQty }),
      }
    );
    if (res.ok) {
      const data = await res.json();
      onUpdated(data.component);
    }
  }

  async function handleDelete() {
    await fetch(
      `/api/nutrition/plans/${planId}/meals/${mealId}/components/${component.id}`,
      { method: "DELETE" }
    );
    onDeleted(component.id);
  }

  return (
    <tr className="text-gray-700 dark:text-gray-300 group">
      <td className="py-1 pr-2 text-xs">{name}</td>
      <td className="text-right py-1 px-1">
        <input
          type="number"
          min="1"
          step="1"
          value={qty}
          onChange={(e) => setQty(e.target.value)}
          onBlur={handleQtyBlur}
          className="w-16 text-right text-xs px-1 py-0.5 border border-transparent hover:border-gray-300 dark:hover:border-gray-600 focus:border-brand-400 rounded focus:outline-none bg-transparent focus:bg-white dark:focus:bg-gray-800"
        />
      </td>
      <td className="text-right py-1 px-1 text-xs">{kcal ?? "—"}</td>
      <td className="text-right py-1 px-1 text-xs">{p ?? "—"}</td>
      <td className="text-right py-1 px-1 text-xs">{carb ?? "—"}</td>
      <td className="text-right py-1 px-1 text-xs">{fat ?? "—"}</td>
      <td className="py-1 pl-1">
        <button
          onClick={handleDelete}
          className="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500 transition-opacity text-xs"
        >
          ✕
        </button>
      </td>
    </tr>
  );
}
```

---

**FoodSearchInput component:**

```typescript
function FoodSearchInput({
  planId,
  mealId,
  onAdded,
}: {
  planId: string;
  mealId: string;
  onAdded: (c: Component) => void;
}) {
  const [query, setQuery] = useState("");
  const [results, setResults] = useState<FoodItem[]>([]);
  const [searching, setSearching] = useState(false);
  const [adding, setAdding] = useState(false);
  const debounceRef = useRef<ReturnType<typeof setTimeout> | null>(null);

  function handleQueryChange(e: React.ChangeEvent<HTMLInputElement>) {
    const val = e.target.value;
    setQuery(val);
    if (debounceRef.current) clearTimeout(debounceRef.current);
    if (val.length < 2) { setResults([]); return; }
    debounceRef.current = setTimeout(async () => {
      setSearching(true);
      try {
        const res = await fetch(`/api/nutrition/foods?q=${encodeURIComponent(val)}`);
        if (res.ok) {
          const data = await res.json();
          setResults(data.foods ?? []);
        }
      } finally {
        setSearching(false);
      }
    }, 200);
  }

  async function handleSelect(food: FoodItem) {
    setAdding(true);
    setResults([]);
    setQuery("");
    try {
      const res = await fetch(`/api/nutrition/plans/${planId}/meals/${mealId}/components`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ food_item_id: food.id, qty_g: 100 }),
      });
      if (res.ok) {
        const data = await res.json();
        onAdded(data.component);
      }
    } finally {
      setAdding(false);
    }
  }

  return (
    <div className="relative mb-2">
      <input
        type="text"
        placeholder="+ Search food to add…"
        value={query}
        onChange={handleQueryChange}
        disabled={adding}
        className="w-full text-xs px-2 py-1.5 border border-dashed border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-1 focus:ring-brand-400 focus:border-brand-400 bg-transparent dark:text-gray-300 placeholder-gray-400 disabled:opacity-50"
      />
      {(results.length > 0 || searching) && (
        <div className="absolute left-0 right-0 top-full mt-1 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl shadow-lg z-20 max-h-48 overflow-y-auto">
          {searching && (
            <div className="px-3 py-2 text-xs text-gray-400">Searching…</div>
          )}
          {results.map((food) => (
            <button
              key={food.id}
              onMouseDown={() => handleSelect(food)} // mouseDown to fire before blur
              className="w-full text-left px-3 py-2 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors"
            >
              <p className="text-xs font-medium text-gray-900 dark:text-gray-100">{food.food_name}</p>
              {food.food_group && (
                <p className="text-xs text-gray-400">{food.food_group}</p>
              )}
            </button>
          ))}
        </div>
      )}
    </div>
  );
}
```

Import `useRef` at the top: `import { useState, useEffect, useCallback, useRef } from "react";`

---

**computeTotals helper and MacroBar component:**

```typescript
interface MacroTotals {
  kcal: number;
  protein: number;
  carb: number;
  fat: number;
}

function computeTotals(components: Component[]): MacroTotals {
  return components.reduce(
    (acc, c) => {
      const scale = c.qty_g / 100;
      return {
        kcal: acc.kcal + (c.food_item?.energy_kcal ?? 0) * scale,
        protein: acc.protein + (c.food_item?.protein_g ?? 0) * scale,
        carb: acc.carb + (c.food_item?.carb_g ?? 0) * scale,
        fat: acc.fat + (c.food_item?.fat_g ?? 0) * scale,
      };
    },
    { kcal: 0, protein: 0, carb: 0, fat: 0 }
  );
}

function MacroBar({
  label,
  totals,
  highlight = false,
}: {
  label: string;
  totals: MacroTotals;
  highlight?: boolean;
}) {
  return (
    <div
      className={
        "flex items-center gap-4 text-xs rounded-lg px-3 py-2 " +
        (highlight
          ? "bg-brand-50 dark:bg-brand-900/20 font-medium"
          : "bg-gray-50 dark:bg-gray-800/50")
      }
    >
      <span className="text-gray-500 dark:text-gray-400 w-20">{label}</span>
      <span className="text-gray-800 dark:text-gray-200">{totals.kcal.toFixed(0)} kcal</span>
      <span className="text-gray-600 dark:text-gray-400">P: {totals.protein.toFixed(1)}g</span>
      <span className="text-gray-600 dark:text-gray-400">C: {totals.carb.toFixed(1)}g</span>
      <span className="text-gray-600 dark:text-gray-400">F: {totals.fat.toFixed(1)}g</span>
    </div>
  );
}
```

---

**onDayUpdated in PlanBuilderClient:** Update the top-level `plan` state when a day's meals change. Add this function to PlanBuilderClient and pass it down to DayPanel:

```typescript
function handleDayUpdated(updatedDay: Day) {
  setPlan((p) =>
    p ? { ...p, days: p.days.map((d) => (d.id === updatedDay.id ? updatedDay : d)) } : p
  );
}
```

Pass to DayPanel: `<DayPanel day={selectedDay} planId={planId} onDayUpdated={handleDayUpdated} />`

Ensure `loadPlan` is still available for explicit reloads (AI generation in Plan 03 will call it). Keep `onReload` prop removed from DayPanel since local state mutations are now used instead of full reloads.
  </action>
  <verify>
    <automated>node -e "
const fs = require('fs');
const pb = fs.readFileSync('apps/trainer-web/src/app/(app)/nutrition/[planId]/PlanBuilderClient.tsx', 'utf8');
const checks = [
  'FoodSearchInput',
  'ComponentRow',
  'MacroBar',
  'computeTotals',
  'handleAddMeal',
  'handleComponentUpdated',
  'handleComponentAdded',
  'handleComponentDeleted',
  'api/nutrition/foods',
  'api/nutrition/plans',
  'qty_g',
  'useRef',
  'debounceRef',
  'onDayUpdated',
  'handleDayUpdated',
];
checks.forEach(k => { if (!pb.includes(k)) throw new Error('PlanBuilderClient missing: ' + k); });
console.log('PlanBuilderClient fully wired OK');
" 2>&1</automated>
  </verify>
  <done>PlanBuilderClient.tsx has interactive DayPanel (Add Meal form), MealCard (delete), ComponentRow (qty edit + delete, macros scale), FoodSearchInput (debounced AFCD search → add component), MacroBar (meal + day totals), computeTotals helper. All mutations go through local state callbacks — no full page reloads needed.</done>
</task>

</tasks>

<verification>
- Coach opens a plan → selects or adds Day 1 → clicks "+ Add Meal" → chooses "Breakfast" → submits → meal card appears
- In the meal card, type "egg" in the food search → dropdown shows AFCD results → click one → component row appears with qty=100, macros populated
- Change qty to 150 → tab away → macros update to reflect 150g scale; PATCH fires to persist
- Click ✕ on a component → row disappears
- Meal total bar shows sum of all component macros
- Day total bar shows sum across all meals
- Click "Remove" on a meal card → meal disappears
</verification>

<success_criteria>
Coach can manually add meals with 3+ food components to a day, edit quantities, and see correctly calculated macros (components → meal total → day total). All changes persist to Supabase.
</success_criteria>

<output>
After completion, create `.planning/phases/07-plan-builder-ai-generation/07-02-SUMMARY.md`
</output>
