---
phase: 07-plan-builder-ai-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/trainer-web/src/app/(app)/nutrition/[planId]/page.tsx
  - apps/trainer-web/src/app/(app)/nutrition/[planId]/PlanBuilderClient.tsx
  - apps/trainer-web/src/app/(app)/nutrition/NutritionClient.tsx
  - apps/trainer-web/src/app/api/nutrition/plans/[planId]/route.ts
  - apps/trainer-web/src/app/api/nutrition/plans/[planId]/days/route.ts
autonomous: true
requirements:
  - NUTR-07

must_haves:
  truths:
    - "Clicking a plan row in /nutrition navigates to /nutrition/[planId]"
    - "Plan builder page loads the plan name, client, and date range from the DB"
    - "Left sidebar lists days (Day 1 through Day N); clicking a day shows that day's content in the main area"
    - "Add Day button appends a new day (INSERT into meal_plan_days) and selects it"
    - "Each day panel shows the day number, optional date, and an empty state when no meals exist yet"
    - "GET /api/nutrition/plans/[planId] returns the plan with its days, meals, and components in one response"
    - "GET/POST /api/nutrition/plans/[planId]/days supports listing and adding days"
  artifacts:
    - path: "apps/trainer-web/src/app/(app)/nutrition/[planId]/page.tsx"
      provides: "Server component wrapper for the plan builder route"
    - path: "apps/trainer-web/src/app/(app)/nutrition/[planId]/PlanBuilderClient.tsx"
      provides: "Client component: days sidebar, selected-day panel, plan header"
    - path: "apps/trainer-web/src/app/api/nutrition/plans/[planId]/route.ts"
      provides: "GET plan with full nested data (days + meals + components)"
    - path: "apps/trainer-web/src/app/api/nutrition/plans/[planId]/days/route.ts"
      provides: "GET list days, POST add a new day"
  key_links:
    - from: "NutritionClient.tsx"
      to: "/nutrition/[planId]"
      via: "anchor/link on plan row"
      pattern: "href.*planId|/nutrition.*plan\\.id"
    - from: "PlanBuilderClient.tsx"
      to: "/api/nutrition/plans/[planId]"
      via: "fetch on mount"
      pattern: "fetch.*api/nutrition/plans"
    - from: "/api/nutrition/plans/[planId]"
      to: "meal_plans + meal_plan_days + meal_plan_meals + meal_plan_components"
      via: "Supabase nested select"
      pattern: "meal_plan_days.*meal_plan_meals.*meal_plan_components"
---

<objective>
Build the plan builder page shell at /nutrition/[planId]: days sidebar, day panel, plan header, and the backing API routes to load and add days.

Purpose: Establishes the page structure that Plans 02 and 03 will fill with meal/component editing and AI generation. This plan delivers the navigation skeleton — a coach can open a plan and add days — but meals/components are read-only display only (editable in Plan 02).
Output: /nutrition/[planId] route + PlanBuilderClient.tsx + GET plan API + days CRUD API.
</objective>

<execution_context>
@C:/Users/Troy Morgan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Troy Morgan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-nutrition-foundation/06-04-SUMMARY.md

<interfaces>
<!-- Existing plan list in NutritionClient.tsx — add a link to each row -->
Current plan row (no link yet):
```tsx
<tr key={plan.id} className="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
  <td className="px-4 py-3">
    <span className="font-medium text-gray-900 dark:text-gray-100">{plan.name}</span>
  </td>
  ...
</tr>
```
Change the plan name cell to be a link:
```tsx
<td className="px-4 py-3">
  <a
    href={`/nutrition/${plan.id}`}
    className="font-medium text-gray-900 dark:text-gray-100 hover:text-brand-600 dark:hover:text-brand-400 transition-colors"
  >
    {plan.name}
  </a>
</td>
```

<!-- meal_plan_days columns: id, plan_id, day_number (1-based), date (optional), created_at -->
<!-- meal_plan_meals columns: id, day_id, meal_type, title, note, sort_order, created_at -->
<!-- meal_plan_components columns: id, meal_id, food_item_id, qty_g, custom_name, sort_order, created_at -->
<!-- food_items columns: id, afcd_food_id, food_name, food_group, energy_kcal, protein_g, fat_g, carb_g, fibre_g -->

<!-- API route pattern for dynamic segments — Next.js App Router -->
Dynamic route: apps/trainer-web/src/app/api/nutrition/plans/[planId]/route.ts
```typescript
import { NextResponse } from "next/server";
import { createClient } from "@/lib/supabase/server";

async function getOrgAndUser(supabase) { /* same as plans/route.ts */ }

export async function GET(
  request: Request,
  { params }: { params: Promise<{ planId: string }> }
) {
  const { planId } = await params;
  // ...
}
```
Note: In Next.js 15 App Router, params is a Promise. Always await params.

<!-- UI layout: two-column — narrow sidebar (days list) + main content area -->
Layout:
```
+---------------------+--------------------------------------------------+
| Plan header (full width, top)                                         |
+---------------------+--------------------------------------------------+
| Days sidebar        | Day N panel                                      |
| (w-56, flex-col)    | - Day title + date                               |
|  [Day 1]            | - Meal cards (Phase 02)                          |
|  [Day 2]            | - Empty state if no meals                        |
|  [Day 3]            |                                                  |
|  [+ Add Day]        |                                                  |
+---------------------+--------------------------------------------------+
```

<!-- Tailwind patterns from existing pages -->
- Page wrapper: className="p-6 max-w-7xl mx-auto"
- Back link: className="flex items-center gap-1 text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 mb-4 transition-colors"
- Section card: className="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl"
- Sidebar item active: className="bg-brand-50 dark:bg-brand-900/20 text-brand-700 dark:text-brand-300 font-medium"
- Sidebar item inactive: className="text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 hover:text-gray-900 dark:hover:text-gray-100"
- Add Day button: secondary style — className="flex items-center gap-1 text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors w-full"
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add plan link in NutritionClient.tsx and create plan detail API routes</name>
  <files>
    apps/trainer-web/src/app/(app)/nutrition/NutritionClient.tsx
    apps/trainer-web/src/app/api/nutrition/plans/[planId]/route.ts
    apps/trainer-web/src/app/api/nutrition/plans/[planId]/days/route.ts
  </files>
  <action>
**1. Update NutritionClient.tsx — add link on plan name**

In `apps/trainer-web/src/app/(app)/nutrition/NutritionClient.tsx`, find the plan name table cell:
```tsx
<td className="px-4 py-3">
  <span className="font-medium text-gray-900 dark:text-gray-100">
    {plan.name}
  </span>
</td>
```
Replace the `<span>` with an `<a>` tag:
```tsx
<td className="px-4 py-3">
  <a
    href={`/nutrition/${plan.id}`}
    className="font-medium text-gray-900 dark:text-gray-100 hover:text-brand-600 dark:hover:text-brand-400 transition-colors"
  >
    {plan.name}
  </a>
</td>
```
No other changes to NutritionClient.tsx.

---

**2. Create GET /api/nutrition/plans/[planId]**

Create directory `apps/trainer-web/src/app/api/nutrition/plans/[planId]/` and file `route.ts`:

```typescript
import { NextResponse } from "next/server";
import { createClient } from "@/lib/supabase/server";

async function getOrgAndUser(supabase: Awaited<ReturnType<typeof createClient>>) {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return { orgId: null, userId: null };
  const { data: membership } = await supabase
    .from("org_members")
    .select("org_id")
    .eq("user_id", user.id)
    .single();
  return { orgId: membership?.org_id ?? null, userId: user.id };
}

export async function GET(
  request: Request,
  { params }: { params: Promise<{ planId: string }> }
) {
  try {
    const { planId } = await params;
    const supabase = await createClient();
    const { orgId } = await getOrgAndUser(supabase);
    if (!orgId) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

    // Load plan with nested days > meals > components > food_item
    const { data: plan, error } = await supabase
      .from("meal_plans")
      .select(`
        *,
        client:clients(id, name, first_name, last_name),
        days:meal_plan_days(
          *,
          meals:meal_plan_meals(
            *,
            components:meal_plan_components(
              *,
              food_item:food_items(id, food_name, food_group, energy_kcal, protein_g, fat_g, carb_g, fibre_g)
            )
          )
        )
      `)
      .eq("id", planId)
      .eq("org_id", orgId)
      .single();

    if (error || !plan) {
      return NextResponse.json({ error: "Plan not found" }, { status: 404 });
    }

    // Sort days by day_number, meals by sort_order, components by sort_order
    if (plan.days) {
      plan.days.sort((a: any, b: any) => a.day_number - b.day_number);
      for (const day of plan.days) {
        if (day.meals) {
          day.meals.sort((a: any, b: any) => a.sort_order - b.sort_order);
          for (const meal of day.meals) {
            if (meal.components) {
              meal.components.sort((a: any, b: any) => a.sort_order - b.sort_order);
            }
          }
        }
      }
    }

    return NextResponse.json({ plan });
  } catch (error) {
    console.error("Plan fetch error:", error);
    return NextResponse.json({ error: "Failed to fetch plan" }, { status: 500 });
  }
}

export async function PATCH(
  request: Request,
  { params }: { params: Promise<{ planId: string }> }
) {
  try {
    const { planId } = await params;
    const supabase = await createClient();
    const { orgId } = await getOrgAndUser(supabase);
    if (!orgId) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

    const body = await request.json();
    const allowedFields = ["name", "start_date", "end_date", "client_id", "status", "published_at"];
    const updates: Record<string, unknown> = { updated_at: new Date().toISOString() };
    for (const field of allowedFields) {
      if (field in body) updates[field] = body[field];
    }

    const { data, error } = await supabase
      .from("meal_plans")
      .update(updates)
      .eq("id", planId)
      .eq("org_id", orgId)
      .select()
      .single();

    if (error) {
      console.error("Plan update error:", error);
      return NextResponse.json({ error: "Failed to update plan" }, { status: 500 });
    }

    return NextResponse.json({ plan: data });
  } catch (error) {
    console.error("Plan update error:", error);
    return NextResponse.json({ error: "Failed to update plan" }, { status: 500 });
  }
}
```

---

**3. Create GET/POST /api/nutrition/plans/[planId]/days**

Create `apps/trainer-web/src/app/api/nutrition/plans/[planId]/days/route.ts`:

```typescript
import { NextResponse } from "next/server";
import { createClient } from "@/lib/supabase/server";

async function getOrgId(supabase: Awaited<ReturnType<typeof createClient>>) {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return null;
  const { data: membership } = await supabase
    .from("org_members")
    .select("org_id")
    .eq("user_id", user.id)
    .single();
  return membership?.org_id ?? null;
}

async function verifyPlanOwnership(
  supabase: Awaited<ReturnType<typeof createClient>>,
  planId: string,
  orgId: string
): Promise<boolean> {
  const { data } = await supabase
    .from("meal_plans")
    .select("id")
    .eq("id", planId)
    .eq("org_id", orgId)
    .single();
  return !!data;
}

export async function GET(
  request: Request,
  { params }: { params: Promise<{ planId: string }> }
) {
  try {
    const { planId } = await params;
    const supabase = await createClient();
    const orgId = await getOrgId(supabase);
    if (!orgId) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

    const owned = await verifyPlanOwnership(supabase, planId, orgId);
    if (!owned) return NextResponse.json({ error: "Not found" }, { status: 404 });

    const { data, error } = await supabase
      .from("meal_plan_days")
      .select("*")
      .eq("plan_id", planId)
      .order("day_number", { ascending: true });

    if (error) return NextResponse.json({ error: "Failed to fetch days" }, { status: 500 });
    return NextResponse.json({ days: data ?? [] });
  } catch (error) {
    return NextResponse.json({ error: "Failed to fetch days" }, { status: 500 });
  }
}

export async function POST(
  request: Request,
  { params }: { params: Promise<{ planId: string }> }
) {
  try {
    const { planId } = await params;
    const supabase = await createClient();
    const orgId = await getOrgId(supabase);
    if (!orgId) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

    const owned = await verifyPlanOwnership(supabase, planId, orgId);
    if (!owned) return NextResponse.json({ error: "Not found" }, { status: 404 });

    // Determine next day_number
    const { data: existingDays } = await supabase
      .from("meal_plan_days")
      .select("day_number")
      .eq("plan_id", planId)
      .order("day_number", { ascending: false })
      .limit(1);

    const nextDayNumber = existingDays && existingDays.length > 0
      ? existingDays[0].day_number + 1
      : 1;

    const body = await request.json().catch(() => ({}));
    const date = body.date ?? null;

    const { data, error } = await supabase
      .from("meal_plan_days")
      .insert({ plan_id: planId, day_number: nextDayNumber, date })
      .select()
      .single();

    if (error) {
      console.error("Add day error:", error);
      return NextResponse.json({ error: "Failed to add day" }, { status: 500 });
    }

    return NextResponse.json({ day: data }, { status: 201 });
  } catch (error) {
    return NextResponse.json({ error: "Failed to add day" }, { status: 500 });
  }
}
```
  </action>
  <verify>
    <automated>node -e "
const fs = require('fs');
const files = [
  'apps/trainer-web/src/app/(app)/nutrition/NutritionClient.tsx',
  'apps/trainer-web/src/app/api/nutrition/plans/[planId]/route.ts',
  'apps/trainer-web/src/app/api/nutrition/plans/[planId]/days/route.ts',
];
files.forEach(f => { if (!fs.existsSync(f)) throw new Error('Missing: ' + f); });
const nc = fs.readFileSync('apps/trainer-web/src/app/(app)/nutrition/NutritionClient.tsx', 'utf8');
if (!nc.includes('/nutrition/\${plan.id}')) throw new Error('NutritionClient missing plan link');
const pr = fs.readFileSync('apps/trainer-web/src/app/api/nutrition/plans/[planId]/route.ts', 'utf8');
['meal_plan_days','meal_plan_meals','meal_plan_components','food_items','PATCH','org_id'].forEach(c => { if (!pr.includes(c)) throw new Error('Plan route missing: ' + c); });
const dr = fs.readFileSync('apps/trainer-web/src/app/api/nutrition/plans/[planId]/days/route.ts', 'utf8');
['meal_plan_days','day_number','plan_id'].forEach(c => { if (!dr.includes(c)) throw new Error('Days route missing: ' + c); });
console.log('All checks pass');
" 2>&1</automated>
  </verify>
  <done>NutritionClient.tsx links plan names to /nutrition/[planId]. GET /api/nutrition/plans/[planId] returns plan with nested days/meals/components. PATCH updates plan fields. POST /api/nutrition/plans/[planId]/days inserts a new day with auto-incremented day_number.</done>
</task>

<task type="auto">
  <name>Task 2: Create /nutrition/[planId] page and PlanBuilderClient component</name>
  <files>
    apps/trainer-web/src/app/(app)/nutrition/[planId]/page.tsx
    apps/trainer-web/src/app/(app)/nutrition/[planId]/PlanBuilderClient.tsx
  </files>
  <action>
Create directory `apps/trainer-web/src/app/(app)/nutrition/[planId]/` and two files:

**page.tsx** (server component wrapper):
```typescript
import PlanBuilderClient from "./PlanBuilderClient";

export default async function PlanBuilderPage({
  params,
}: {
  params: Promise<{ planId: string }>;
}) {
  const { planId } = await params;
  return <PlanBuilderClient planId={planId} />;
}
```

---

**PlanBuilderClient.tsx** — full plan builder shell:

```typescript
"use client";

import { useState, useEffect, useCallback } from "react";
import Link from "next/link";

// --- Type definitions ---

interface FoodItem {
  id: string;
  food_name: string;
  food_group: string | null;
  energy_kcal: number | null;
  protein_g: number | null;
  fat_g: number | null;
  carb_g: number | null;
  fibre_g: number | null;
}

interface Component {
  id: string;
  meal_id: string;
  food_item_id: string | null;
  qty_g: number;
  custom_name: string | null;
  sort_order: number;
  food_item: FoodItem | null;
}

interface Meal {
  id: string;
  day_id: string;
  meal_type: string;
  title: string | null;
  note: string | null;
  sort_order: number;
  components: Component[];
}

interface Day {
  id: string;
  plan_id: string;
  day_number: number;
  date: string | null;
  meals: Meal[];
}

interface PlanClient {
  id: string;
  name: string | null;
  first_name?: string | null;
  last_name?: string | null;
}

interface Plan {
  id: string;
  name: string;
  status: "draft" | "published";
  version: number;
  start_date: string | null;
  end_date: string | null;
  published_at: string | null;
  client: PlanClient | null;
  days: Day[];
}

// --- Helpers ---

function clientDisplayName(client: PlanClient | null): string {
  if (!client) return "Unassigned";
  return (
    client.name ||
    [client.first_name, client.last_name].filter(Boolean).join(" ") ||
    "Unknown"
  );
}

function formatDate(d: string | null): string {
  if (!d) return "";
  return new Date(d).toLocaleDateString("en-AU", {
    day: "numeric",
    month: "short",
    year: "numeric",
  });
}

const MEAL_TYPE_LABELS: Record<string, string> = {
  breakfast: "Breakfast",
  morning_snack: "Morning Snack",
  lunch: "Lunch",
  afternoon_snack: "Afternoon Snack",
  dinner: "Dinner",
  evening_snack: "Evening Snack",
  other: "Other",
};

// --- Component ---

export default function PlanBuilderClient({ planId }: { planId: string }) {
  const [plan, setPlan] = useState<Plan | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [selectedDayId, setSelectedDayId] = useState<string | null>(null);
  const [addingDay, setAddingDay] = useState(false);

  const loadPlan = useCallback(async () => {
    try {
      const res = await fetch(`/api/nutrition/plans/${planId}`);
      if (!res.ok) {
        setError("Plan not found");
        return;
      }
      const data = await res.json();
      setPlan(data.plan);
      // Auto-select first day if none selected
      if (data.plan.days?.length > 0 && !selectedDayId) {
        setSelectedDayId(data.plan.days[0].id);
      }
    } catch {
      setError("Failed to load plan");
    } finally {
      setLoading(false);
    }
  }, [planId, selectedDayId]);

  useEffect(() => {
    loadPlan();
  }, [planId]); // Load once on mount; reload called explicitly after mutations

  async function handleAddDay() {
    if (!plan) return;
    setAddingDay(true);
    try {
      const res = await fetch(`/api/nutrition/plans/${planId}/days`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({}),
      });
      if (res.ok) {
        const data = await res.json();
        const newDay: Day = { ...data.day, meals: [] };
        setPlan((p) => p ? { ...p, days: [...p.days, newDay] } : p);
        setSelectedDayId(data.day.id);
      }
    } catch {
      // Silently fail; could add error toast in later plan
    } finally {
      setAddingDay(false);
    }
  }

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <div className="w-6 h-6 border-2 border-brand-500 border-t-transparent rounded-full animate-spin" />
      </div>
    );
  }

  if (error || !plan) {
    return (
      <div className="p-6">
        <Link href="/nutrition" className="text-sm text-brand-600 hover:underline">
          ← Back to Nutrition Plans
        </Link>
        <p className="mt-4 text-gray-500 dark:text-gray-400">{error ?? "Plan not found."}</p>
      </div>
    );
  }

  const selectedDay = plan.days.find((d) => d.id === selectedDayId) ?? null;

  return (
    <div className="p-6 max-w-7xl mx-auto">
      {/* Back nav */}
      <Link
        href="/nutrition"
        className="flex items-center gap-1 text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 mb-4 transition-colors"
      >
        ← Nutrition Plans
      </Link>

      {/* Plan header */}
      <div className="mb-6 flex items-start justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold text-gray-900 dark:text-gray-100">
            {plan.name}
          </h1>
          <p className="text-sm text-gray-500 dark:text-gray-400 mt-0.5">
            {clientDisplayName(plan.client)}
            {(plan.start_date || plan.end_date) && (
              <span className="mx-2 text-gray-300 dark:text-gray-600">·</span>
            )}
            {plan.start_date && formatDate(plan.start_date)}
            {plan.start_date && plan.end_date && " – "}
            {plan.end_date && formatDate(plan.end_date)}
          </p>
        </div>
        <div className="flex items-center gap-2 flex-shrink-0">
          <span
            className={
              plan.status === "published"
                ? "px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700"
                : "px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400"
            }
          >
            {plan.status}
          </span>
          {/* Publish button rendered by Plan 04 */}
          <div id="plan-action-slot" />
        </div>
      </div>

      {/* Main layout: days sidebar + day panel */}
      <div className="flex gap-6 min-h-[500px]">

        {/* Days sidebar */}
        <aside className="w-48 flex-shrink-0">
          <div className="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl overflow-hidden">
            <div className="px-3 py-2 border-b border-gray-100 dark:border-gray-800">
              <p className="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Days
              </p>
            </div>
            <nav className="p-1">
              {plan.days.length === 0 && (
                <p className="text-xs text-gray-400 dark:text-gray-500 px-3 py-2">
                  No days yet
                </p>
              )}
              {plan.days.map((day) => (
                <button
                  key={day.id}
                  onClick={() => setSelectedDayId(day.id)}
                  className={
                    "w-full text-left px-3 py-2 rounded-lg text-sm transition-colors " +
                    (selectedDayId === day.id
                      ? "bg-brand-50 dark:bg-brand-900/20 text-brand-700 dark:text-brand-300 font-medium"
                      : "text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 hover:text-gray-900 dark:hover:text-gray-100")
                  }
                >
                  Day {day.day_number}
                  {day.date && (
                    <span className="block text-xs text-gray-400 dark:text-gray-500 font-normal">
                      {new Date(day.date).toLocaleDateString("en-AU", { day: "numeric", month: "short" })}
                    </span>
                  )}
                </button>
              ))}
            </nav>
            <div className="p-1 border-t border-gray-100 dark:border-gray-800">
              <button
                onClick={handleAddDay}
                disabled={addingDay}
                className="flex items-center gap-1 text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors w-full disabled:opacity-50"
              >
                {addingDay ? (
                  <span className="w-3 h-3 border-2 border-current border-t-transparent rounded-full animate-spin" />
                ) : (
                  <span>+</span>
                )}
                Add Day
              </button>
            </div>
          </div>
        </aside>

        {/* Day content panel */}
        <div className="flex-1 min-w-0">
          {!selectedDay ? (
            <div className="bg-white dark:bg-gray-900 border border-dashed border-gray-300 dark:border-gray-700 rounded-xl p-10 text-center">
              <p className="text-gray-400 dark:text-gray-500">
                {plan.days.length === 0
                  ? "Add a day to start building your plan."
                  : "Select a day from the sidebar."}
              </p>
            </div>
          ) : (
            <DayPanel
              day={selectedDay}
              planId={planId}
              onReload={loadPlan}
            />
          )}
        </div>

      </div>
    </div>
  );
}

// --- DayPanel: renders meals for a selected day ---
// Phase 02 will add meal editing. Phase 01 renders a read-only scaffold.

function DayPanel({
  day,
  planId,
  onReload,
}: {
  day: Day;
  planId: string;
  onReload: () => void;
}) {
  return (
    <div className="space-y-4">
      {/* Day header */}
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-lg font-semibold text-gray-900 dark:text-gray-100">
            Day {day.day_number}
          </h2>
          {day.date && (
            <p className="text-sm text-gray-500 dark:text-gray-400">
              {new Date(day.date).toLocaleDateString("en-AU", {
                weekday: "long",
                day: "numeric",
                month: "long",
              })}
            </p>
          )}
        </div>
        {/* Add Meal button — wired in Plan 02 */}
        <div id={`add-meal-slot-${day.id}`} />
      </div>

      {/* Meals list — empty state when no meals */}
      {day.meals.length === 0 ? (
        <div className="bg-white dark:bg-gray-900 border border-dashed border-gray-300 dark:border-gray-700 rounded-xl p-8 text-center">
          <p className="text-gray-400 dark:text-gray-500 text-sm">
            No meals yet. Add a meal to get started.
          </p>
        </div>
      ) : (
        <div className="space-y-3">
          {day.meals.map((meal) => (
            <MealCard key={meal.id} meal={meal} />
          ))}
        </div>
      )}
    </div>
  );
}

// --- MealCard: read-only in Plan 01; made editable in Plan 02 ---

function MealCard({ meal }: { meal: Meal }) {
  const label = MEAL_TYPE_LABELS[meal.meal_type] ?? meal.meal_type;
  return (
    <div className="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl p-4">
      <div className="flex items-center justify-between mb-2">
        <div>
          <span className="text-xs font-semibold uppercase tracking-wider text-brand-600 dark:text-brand-400">
            {label}
          </span>
          {meal.title && (
            <p className="text-sm font-medium text-gray-900 dark:text-gray-100">{meal.title}</p>
          )}
        </div>
      </div>
      {meal.components.length === 0 ? (
        <p className="text-xs text-gray-400 dark:text-gray-500">No components yet.</p>
      ) : (
        <table className="w-full text-xs mt-1">
          <thead>
            <tr className="text-gray-400 dark:text-gray-500">
              <th className="text-left font-normal pb-1">Food</th>
              <th className="text-right font-normal pb-1">Qty (g)</th>
              <th className="text-right font-normal pb-1">kcal</th>
              <th className="text-right font-normal pb-1">P</th>
              <th className="text-right font-normal pb-1">C</th>
              <th className="text-right font-normal pb-1">F</th>
            </tr>
          </thead>
          <tbody>
            {meal.components.map((c) => {
              const scale = c.qty_g / 100;
              const kcal = c.food_item?.energy_kcal != null ? +(c.food_item.energy_kcal * scale).toFixed(1) : null;
              const p = c.food_item?.protein_g != null ? +(c.food_item.protein_g * scale).toFixed(1) : null;
              const carb = c.food_item?.carb_g != null ? +(c.food_item.carb_g * scale).toFixed(1) : null;
              const fat = c.food_item?.fat_g != null ? +(c.food_item.fat_g * scale).toFixed(1) : null;
              const name = c.custom_name ?? c.food_item?.food_name ?? "Unknown";
              return (
                <tr key={c.id} className="text-gray-700 dark:text-gray-300">
                  <td className="py-0.5 pr-2">{name}</td>
                  <td className="text-right py-0.5">{c.qty_g}</td>
                  <td className="text-right py-0.5">{kcal ?? "—"}</td>
                  <td className="text-right py-0.5">{p ?? "—"}</td>
                  <td className="text-right py-0.5">{carb ?? "—"}</td>
                  <td className="text-right py-0.5">{fat ?? "—"}</td>
                </tr>
              );
            })}
          </tbody>
        </table>
      )}
    </div>
  );
}
```
  </action>
  <verify>
    <automated>node -e "
const fs = require('fs');
const files = [
  'apps/trainer-web/src/app/(app)/nutrition/[planId]/page.tsx',
  'apps/trainer-web/src/app/(app)/nutrition/[planId]/PlanBuilderClient.tsx',
];
files.forEach(f => { if (!fs.existsSync(f)) throw new Error('Missing: ' + f); });
const pb = fs.readFileSync('apps/trainer-web/src/app/(app)/nutrition/[planId]/PlanBuilderClient.tsx', 'utf8');
['use client','PlanBuilderClient','Day','selectedDayId','handleAddDay','DayPanel','MealCard','loadPlan','api/nutrition/plans'].forEach(k => {
  if (!pb.includes(k)) throw new Error('PlanBuilderClient missing: ' + k);
});
console.log('Plan builder files OK');
" 2>&1</automated>
  </verify>
  <done>apps/trainer-web/src/app/(app)/nutrition/[planId]/page.tsx and PlanBuilderClient.tsx exist. Coach can navigate from /nutrition to a plan, see the days sidebar, add days, and view a read-only meal/component display. Macro values scaled from food_item per 100g × qty_g.</done>
</task>

</tasks>

<verification>
- Visit /nutrition → click a plan name → navigates to /nutrition/[planId]
- Plan builder shows plan name, client, status badge in header
- Days sidebar is empty with "Add a day" prompt when no days exist
- Click "Add Day" → Day 1 appears in sidebar, day panel shows empty state
- Click "Add Day" again → Day 2 appears
- GET /api/nutrition/plans/[planId] returns plan with nested days/meals/components arrays sorted by day_number/sort_order
</verification>

<success_criteria>
Coach can open a plan from the /nutrition list, see the plan builder layout (header + days sidebar + day panel), and add days via the sidebar. Plan data loads from the API with full nesting. Macro values display correctly in component rows (scaled per qty_g).
</success_criteria>

<output>
After completion, create `.planning/phases/07-plan-builder-ai-generation/07-01-SUMMARY.md`
</output>
