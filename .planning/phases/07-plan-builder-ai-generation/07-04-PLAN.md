---
phase: 07-plan-builder-ai-generation
plan: 04
type: execute
wave: 4
depends_on:
  - 07-03
files_modified:
  - apps/trainer-web/src/app/(app)/nutrition/[planId]/PlanBuilderClient.tsx
autonomous: false
requirements:
  - NUTR-11

must_haves:
  truths:
    - "Plan builder header shows a 'Publish' button when plan status is 'draft'"
    - "Clicking Publish calls PATCH /api/nutrition/plans/[planId] with { status: 'published', published_at: now() }"
    - "After publish, the status badge in the header updates to 'published' (green) without a page reload"
    - "Published plan returns status='published' from GET /api/nutrition/plans/[planId]"
    - "The Publish button is replaced by a 'Published' badge (no button) once status is published"
    - "Publish requires the plan to have at least 1 day — show an error if plan has no days"
  artifacts:
    - path: "apps/trainer-web/src/app/(app)/nutrition/[planId]/PlanBuilderClient.tsx"
      provides: "Publish button that PATCHes plan status to published"
  key_links:
    - from: "PlanBuilderClient.tsx (Publish button)"
      to: "PATCH /api/nutrition/plans/[planId]"
      via: "fetch PATCH with { status: 'published', published_at }"
      pattern: "fetch.*plans.*planId.*PATCH"
---

<objective>
Add the Publish action to the plan builder and run the human-verify checkpoint confirming the complete Phase 7 flow works end-to-end.

Purpose: Publish sets meal_plans.status = 'published' + published_at = now(), making the plan visible in Phase 8's client portal. This plan also gates on human verification of the full Phase 7 feature set.
Output: Publish button in PlanBuilderClient.tsx + human-verify checkpoint.
</objective>

<execution_context>
@C:/Users/Troy Morgan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Troy Morgan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-plan-builder-ai-generation/07-03-SUMMARY.md

<interfaces>
<!-- PATCH /api/nutrition/plans/[planId] — already implemented in Plan 01 -->
<!-- Accepts: { status, published_at, name, start_date, end_date, client_id } -->
<!-- Returns: { plan: { id, status, published_at, ... } } -->

<!-- Current plan header in PlanBuilderClient.tsx (from Plan 01/02/03) -->
<!--
  <div className="flex items-center gap-2 flex-shrink-0">
    <span className={plan.status === "published" ? "...green..." : "...grey..."}>
      {plan.status}
    </span>
    <button onClick={() => setShowGenerateModal(true)}>Generate with AI</button>
    <div id="plan-action-slot" />   <-- placeholder added in Plan 01 for this button
  </div>
-->

<!-- After this plan, the header flex row should read: [status badge] [Publish / Published] [Generate with AI] -->
<!-- If published: no Publish button, just "Published" text or green check -->
<!-- If draft + has days: "Publish" button (brand primary) -->
<!-- If draft + no days: "Publish" button disabled with tooltip "Add at least one day before publishing" -->
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Publish button to PlanBuilderClient</name>
  <files>
    apps/trainer-web/src/app/(app)/nutrition/[planId]/PlanBuilderClient.tsx
  </files>
  <action>
Add publish state and the Publish button to `PlanBuilderClient.tsx`.

**State addition** to PlanBuilderClient (top-level component):
```typescript
const [publishing, setPublishing] = useState(false);
const [publishError, setPublishError] = useState<string | null>(null);
```

**handlePublish function** (add inside PlanBuilderClient, before the return statement):
```typescript
async function handlePublish() {
  if (!plan) return;
  if (plan.days.length === 0) {
    setPublishError("Add at least one day before publishing.");
    return;
  }
  setPublishing(true);
  setPublishError(null);
  try {
    const res = await fetch(`/api/nutrition/plans/${planId}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        status: "published",
        published_at: new Date().toISOString(),
      }),
    });
    if (res.ok) {
      const data = await res.json();
      setPlan((p) => p ? { ...p, status: data.plan.status, published_at: data.plan.published_at } : p);
    } else {
      const data = await res.json();
      setPublishError(data.error ?? "Failed to publish");
    }
  } catch {
    setPublishError("Failed to publish");
  } finally {
    setPublishing(false);
  }
}
```

**Update the plan header** — replace the placeholder `<div id="plan-action-slot" />` (or the existing header action area) with the publish button. In the header's flex row, add this between the status badge and "Generate with AI" button:

```tsx
{/* Publish action */}
{plan.status === "published" ? (
  <span className="text-xs text-green-600 dark:text-green-400 font-medium flex items-center gap-1">
    ✓ Published
  </span>
) : (
  <button
    onClick={handlePublish}
    disabled={publishing || plan.days.length === 0}
    title={plan.days.length === 0 ? "Add at least one day before publishing" : undefined}
    className="bg-brand-600 text-white px-3 py-1.5 rounded-lg text-sm font-medium hover:bg-brand-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1.5 transition-colors"
  >
    {publishing && (
      <span className="w-3 h-3 border-2 border-white/50 border-t-white rounded-full animate-spin" />
    )}
    Publish
  </button>
)}
```

**Publish error display** — add below the plan header (after the closing `</div>` of the header block), before the main layout:
```tsx
{publishError && (
  <div className="mb-4 px-3 py-2 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-sm text-red-600 dark:text-red-400">
    {publishError}
  </div>
)}
```

Remove the `<div id="plan-action-slot" />` placeholder that was added in Plan 01 (it has been replaced by the publish/published render above).
  </action>
  <verify>
    <automated>node -e "
const fs = require('fs');
const pb = fs.readFileSync('apps/trainer-web/src/app/(app)/nutrition/[planId]/PlanBuilderClient.tsx', 'utf8');
['handlePublish','publishing','publishError','status.*published','Published.*✓|✓.*Published','PATCH'].forEach(k => {
  const re = new RegExp(k);
  if (!re.test(pb)) throw new Error('PlanBuilderClient missing: ' + k);
});
console.log('Publish button OK');
" 2>&1</automated>
  </verify>
  <done>PlanBuilderClient.tsx has handlePublish, publishing state, publish error display. Draft plans show 'Publish' button (disabled if no days). Published plans show '✓ Published' text. PATCH /api/nutrition/plans/[planId] called with status=published and published_at. Status badge updates instantly without reload.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 7 — Plan Builder + AI Generation:

    Plan 01: Plan builder shell
    - /nutrition plan list now links plan names to /nutrition/[planId]
    - GET /api/nutrition/plans/[planId] returns full nested plan (days > meals > components > food_item)
    - PATCH /api/nutrition/plans/[planId] updates plan fields (name, status, published_at etc.)
    - POST /api/nutrition/plans/[planId]/days adds a new day with auto-incremented day_number
    - /nutrition/[planId] page: plan header (name, client, date range, status badge), days sidebar, day content panel, Add Day button

    Plan 02: Meal editing + food search + macro calculation
    - DayPanel has "+ Add Meal" button that opens an inline form (meal_type + optional title)
    - MealCard shows components in a table with qty inputs and macro columns (kcal, P, C, F)
    - Inline food search: type 2+ chars → AFCD dropdown → click to add component at 100g
    - Qty input is editable; changing it rescales macros immediately; PATCH persists on blur
    - Delete component (✕ on hover) and delete meal (Remove button)
    - Meal total bar and day total bar auto-sum all components

    Plan 03: AI generation
    - "Generate with AI" button in plan header opens GenerateModal
    - Inputs: goal (text), calorie target (number), macro split (3 % inputs summing to 100), dietary restrictions (text)
    - POST /api/nutrition/plans/[planId]/generate calls claude-sonnet-4-6 with AFCD food sample + inputs
    - Endpoint clears existing days, inserts generated 7-day plan, validates all food_item_ids
    - On success plan reloads showing Day 1–7 with meals and macro values

    Plan 04: Publish
    - "Publish" button in plan header PATCHes status=published + published_at=now()
    - Disabled if plan has no days
    - Shows "✓ Published" once published
  </what-built>
  <how-to-verify>
    1. Start the dev server: `cd apps/trainer-web && npm run dev`

    **Manual build flow:**
    2. Navigate to http://localhost:3000/nutrition → click a plan name → should navigate to /nutrition/[planId]
    3. Verify plan header shows plan name, client, date range, status badge, "Generate with AI" and "Publish" buttons
    4. Click "+ Add Day" in the sidebar → Day 1 appears, day panel shows "No meals yet"
    5. Click "+ Add Meal" → choose "Breakfast" → submit → meal card appears
    6. In the meal card, type "egg" in the food search → dropdown appears with AFCD foods → click one → component row appears (qty=100, macros visible)
    7. Add 2 more components. Verify meal total bar shows summed macros.
    8. Change a qty value (e.g. 150) → tab away → macros update; verify the change persists on reload
    9. Add a second day → add meals → verify day total bar sums all meals

    **AI generation flow:**
    10. On a fresh (no days) or existing plan, click "Generate with AI"
    11. Leave defaults → click "Generate Plan" → spinner appears
    12. Wait ~30 seconds → modal closes → sidebar shows Day 1–7
    13. Click Day 1 → meals and components visible with macro values
    14. Edit a component qty manually → verify it persists

    **Publish flow:**
    15. Click "Publish" → button shows spinner → status badge turns green, "✓ Published" appears
    16. Refresh page → plan still shows as "published"
    17. Try clicking "Publish" on a plan with no days → button should be disabled

    Type "approved" when all flows work, or describe any issues.
  </how-to-verify>
  <resume-signal>Type "approved" to confirm Phase 7 plan builder works end-to-end (manual build + AI generation + publish), or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
- GET /nutrition/[planId] loads without error for an existing plan
- Adding a day → adding a meal → adding 3 components → macro values correct (P+C+F×9 ≈ kcal within rounding)
- AI generation fills 7 days with AFCD-matched components
- Publish sets status=published; subsequent GET returns published_at timestamp
- SELECT id, status, published_at FROM meal_plans WHERE id = '[planId]' shows status='published'
</verification>

<success_criteria>
Phase 7 is complete when: (1) coach can manually build a 7-day plan with meals + AFCD components and see correct macros, (2) AI generation fills all 7 days from a single click, (3) publish action makes the plan visible for Phase 8's portal view.
</success_criteria>

<output>
After completion, create `.planning/phases/07-plan-builder-ai-generation/07-04-SUMMARY.md`
</output>
