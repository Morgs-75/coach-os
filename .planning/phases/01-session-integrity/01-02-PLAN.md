---
phase: 01-session-integrity
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/cron-sms-reminders/index.ts
autonomous: true
requirements:
  - DATA-02
  - DATA-03

must_haves:
  truths:
    - "Bookings marked complete by the cron job correctly deduct one session from the package"
    - "The cron deduction uses the same atomic use_session() DB function as the browser paths"
    - "A booking with no purchase_id (no package) is completed without error and no deduction is attempted"
  artifacts:
    - path: "supabase/functions/cron-sms-reminders/index.ts"
      provides: "Auto-complete section that fetches affected booking IDs and calls use_session() for each"
      contains: "use_session"
  key_links:
    - from: "supabase/functions/cron-sms-reminders/index.ts"
      to: "public.use_session()"
      via: "supabase.rpc('use_session', { p_purchase_id })"
      pattern: "use_session"
---

<objective>
Fix the cron function so that when it bulk-marks past bookings as `completed`, it also deducts a session from each booking's associated package using the atomic `use_session()` DB function.

Purpose: Bookings completed by the cron (when no browser calendar is open) currently advance to `status='completed'` but never decrement `sessions_used`. This means cron-completed sessions are free — the session count is never consumed.

Output: `cron-sms-reminders/index.ts` auto-complete section fetches the affected rows (with `purchase_id`), marks them completed, and calls `supabase.rpc('use_session', { p_purchase_id })` for each that has a package.
</objective>

<execution_context>
@C:/Users/Troy Morgan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Troy Morgan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/functions/cron-sms-reminders/index.ts
@supabase/migrations/0010_pricing_offers.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add session deduction to cron auto-complete section</name>
  <files>supabase/functions/cron-sms-reminders/index.ts</files>
  <action>
    In `supabase/functions/cron-sms-reminders/index.ts`, locate the AUTO-COMPLETE section at lines 29–36:

    ```typescript
    // ========================================
    // 0. AUTO-COMPLETE PAST SESSIONS
    // ========================================
    await supabase
      .from("bookings")
      .update({ status: "completed" })
      .eq("status", "confirmed")
      .lt("end_time", now.toISOString());
    ```

    This bulk update has no `.select()` so no row data is returned. Replace the entire AUTO-COMPLETE section with a version that retrieves the affected rows, then deducts sessions:

    ```typescript
    // ========================================
    // 0. AUTO-COMPLETE PAST SESSIONS
    // ========================================
    // Fetch confirmed past bookings BEFORE marking complete, to capture purchase_ids
    const { data: bookingsToComplete, error: fetchError } = await supabase
      .from("bookings")
      .select("id, purchase_id")
      .eq("status", "confirmed")
      .lt("end_time", now.toISOString());

    if (fetchError) {
      console.error("Error fetching bookings to complete:", fetchError);
    }

    if (bookingsToComplete && bookingsToComplete.length > 0) {
      const bookingIds = bookingsToComplete.map((b: any) => b.id);

      // Mark all as completed in one batch update
      const { error: completeError } = await supabase
        .from("bookings")
        .update({ status: "completed" })
        .in("id", bookingIds);

      if (completeError) {
        console.error("Error marking bookings as completed:", completeError);
      } else {
        // Atomically deduct a session for each booking that has a package
        for (const booking of bookingsToComplete) {
          if (booking.purchase_id) {
            const { error: deductError } = await supabase
              .rpc("use_session", { p_purchase_id: booking.purchase_id });
            if (deductError) {
              console.error("Error deducting session for booking", booking.id, deductError);
            }
            // use_session() returns false if no sessions remain — acceptable, log nothing extra
          }
        }
      }
    }
    ```

    Key design decisions:
    1. SELECT before UPDATE: We need `purchase_id` from the bookings rows. Fetching first (using the same filter criteria) then updating by explicit IDs is safe because `status='confirmed'` rows won't change between the two calls in normal operation, and if they do (another process completed a booking), the `.in("id", bookingIds)` update is idempotent for already-completed rows (the `use_session()` call is the only risk — but that DB function guards against double-deduction by checking `sessions_remaining > 0` before updating).
    2. `use_session()` is `SECURITY DEFINER` (migration 0010, line 122) — it runs with elevated privileges so the service-role client calling it from the Edge Function has the necessary permissions.
    3. Do NOT add a second SELECT to read back sessions_used — `use_session()` handles the entire atomic increment internally.
    4. The outer `if (bookingsToComplete && bookingsToComplete.length > 0)` guard prevents a loop over an empty array when there are no past sessions to complete.

    Do NOT modify any other section of the file — only replace the AUTO-COMPLETE block (lines 29–36).
  </action>
  <verify>
    <automated>cd "C:/Users/Troy Morgan/OneDrive/coach-os" && npx supabase functions serve cron-sms-reminders --no-verify-jwt 2>&1 | head -5 || echo "serve not available in CI — check TypeScript manually" && cat supabase/functions/cron-sms-reminders/index.ts | grep -n "use_session"</automated>
    <manual>
      1. Confirm `grep -n "use_session" supabase/functions/cron-sms-reminders/index.ts` returns at least one result
      2. Confirm the old single-statement bulk update (`.update({ status: "completed" }).eq("status", "confirmed").lt("end_time"`) is gone — replaced by the select-then-update-by-ids pattern
      3. Confirm no syntax errors: `deno check supabase/functions/cron-sms-reminders/index.ts` if Deno is available, otherwise review the diff manually
    </manual>
  </verify>
  <done>
    The cron AUTO-COMPLETE section fetches bookings with `purchase_id`, marks them completed by ID list, then calls `supabase.rpc('use_session', { p_purchase_id: booking.purchase_id })` for each booking that has a package. No TypeScript/Deno syntax errors introduced.
  </done>
</task>

</tasks>

<verification>
After task completes:

1. `grep -n "use_session" supabase/functions/cron-sms-reminders/index.ts` — must return at least one line
2. `grep -n "\.update.*status.*completed.*\.eq.*status.*confirmed.*\.lt" supabase/functions/cron-sms-reminders/index.ts` — the old single-statement bulk update pattern should be gone
3. `grep -n "purchase_id" supabase/functions/cron-sms-reminders/index.ts` — must appear in the AUTO-COMPLETE section
4. Confirm the function still has all other sections intact (SESSION REMINDERS, FEEDBACK REQUESTS) by reviewing file line count — it should be longer than the original, not shorter
</verification>

<success_criteria>
- Cron AUTO-COMPLETE section selects affected bookings (capturing purchase_id), marks them completed, then calls `use_session()` atomically for each packaged booking
- Bookings without a `purchase_id` (no package) are completed without error and no deduction is attempted
- The function file has no syntax errors that would prevent Supabase Edge Function deployment
- All other sections of cron-sms-reminders remain unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/01-session-integrity/01-02-SUMMARY.md`
</output>
