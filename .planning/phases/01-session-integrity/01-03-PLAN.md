---
phase: 01-session-integrity
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/0032_release_session_function.sql
autonomous: true
requirements:
  - DATA-01

must_haves:
  truths:
    - "A release_session() DB function exists that decrements sessions_used by 1 only if sessions_used > 0"
    - "The decrement is a single atomic UPDATE with no intermediate read from application code"
    - "The function returns the updated sessions_used value for local state refresh"
    - "Calling release_session() when sessions_used is already 0 is a no-op that does not error"
  artifacts:
    - path: "supabase/migrations/0032_release_session_function.sql"
      provides: "release_session(p_purchase_id uuid) RETURNS int DB function"
      contains: "CREATE OR REPLACE FUNCTION public.release_session"
  key_links:
    - from: "supabase/migrations/0032_release_session_function.sql"
      to: "public.client_purchases"
      via: "UPDATE ... SET sessions_used = sessions_used - 1 WHERE id = p_purchase_id AND sessions_used > 0 RETURNING sessions_used"
      pattern: "sessions_used = sessions_used - 1"
---

<objective>
Create the `release_session()` DB function that atomically decrements `sessions_used` by 1, mirroring `use_session()` but in reverse.

Purpose: The Reinstate button in the client detail page must be concurrent-write-safe (DATA-01). A direct `.update({ sessions_used: purchase.sessions_used - 1 })` from component state is not safe under concurrent writes. A `release_session()` DB function that performs `UPDATE ... SET sessions_used = sessions_used - 1 WHERE id = p_purchase_id AND sessions_used > 0` is atomic — the WHERE guard and the decrement happen in a single statement with no intervening read from application code.

Output: Migration `0032_release_session_function.sql` deploying `public.release_session(p_purchase_id uuid) RETURNS int`.
</objective>

<execution_context>
@C:/Users/Troy Morgan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Troy Morgan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/migrations/0010_pricing_offers.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create release_session() migration mirroring use_session()</name>
  <files>supabase/migrations/0032_release_session_function.sql</files>
  <action>
    Create `supabase/migrations/0032_release_session_function.sql` with the following content:

    ```sql
    -- Atomically release (reinstate) one session from a pack.
    -- Mirrors use_session() but decrements instead of incrementing.
    -- Returns the updated sessions_used value, or -1 if the row was not updated
    -- (sessions_used was already 0 — prevents underflow).
    CREATE OR REPLACE FUNCTION public.release_session(p_purchase_id uuid)
    RETURNS int
    LANGUAGE plpgsql
    SECURITY DEFINER
    AS $$
    DECLARE
      v_sessions_used int;
    BEGIN
      UPDATE public.client_purchases
      SET sessions_used = sessions_used - 1
      WHERE id = p_purchase_id
        AND sessions_used > 0
      RETURNING sessions_used INTO v_sessions_used;

      -- If no row was updated (sessions_used was 0), return -1 as sentinel
      IF NOT FOUND THEN
        RETURN -1;
      END IF;

      RETURN v_sessions_used;
    END;
    $$;
    ```

    Key design decisions matching `use_session()` in migration 0010:
    - `SECURITY DEFINER` — consistent with `use_session()` so the function runs with elevated privileges. Required for the Supabase Edge Function (service-role context) and browser client (anon/user role context) alike.
    - `RETURNS int` rather than `boolean` — returns the updated `sessions_used` value so the caller can refresh local state from the authoritative DB value (no second SELECT needed). Returns `-1` when no update occurred (sessions_used was already 0).
    - Single `UPDATE ... RETURNING` — the WHERE guard (`sessions_used > 0`) and the decrement happen atomically in one statement. There is no intermediate SELECT from application code, eliminating the race window.
    - Do NOT add `expires_at` checking — reinstatement is intentional and should work regardless of pack expiry.

    After writing the file, deploy it to the Supabase project:
    ```bash
    cd "C:/Users/Troy Morgan/OneDrive/coach-os" && npx supabase db push --project-ref ntqdmgvxirswnjlnwopq
    ```

    If `db push` is unavailable (e.g. not linked), apply via the SQL editor alternative noted in the verify step.
  </action>
  <verify>
    <automated>cd "C:/Users/Troy Morgan/OneDrive/coach-os" && npx supabase db push --project-ref ntqdmgvxirswnjlnwopq 2>&1 | tail -5</automated>
    <manual>
      If db push is not available locally, apply manually:
      1. Open Supabase Dashboard -> SQL Editor for project ntqdmgvxirswnjlnwopq
      2. Paste the contents of supabase/migrations/0032_release_session_function.sql and run
      3. Confirm: SELECT proname FROM pg_proc WHERE proname = 'release_session'; returns one row
    </manual>
    <sampling_rate>run after this task commits, before Plan 01-01 executes</sampling_rate>
  </verify>
  <done>
    `public.release_session(p_purchase_id uuid)` exists in the database and returns `int`. Calling it with a valid purchase_id where sessions_used > 0 decrements sessions_used by 1 and returns the new value. Calling it when sessions_used = 0 returns -1 without modifying the row.
  </done>
</task>

</tasks>

<verification>
After task completes:

1. Migration file exists: `ls supabase/migrations/0032_release_session_function.sql` — must exist
2. Function definition present: `grep -n "release_session" supabase/migrations/0032_release_session_function.sql` — must return multiple lines
3. Atomic guard present: `grep -n "sessions_used > 0" supabase/migrations/0032_release_session_function.sql` — must return a result
4. SECURITY DEFINER present: `grep -n "SECURITY DEFINER" supabase/migrations/0032_release_session_function.sql` — must return a result
5. No read-before-write: the function body must NOT contain a SELECT before the UPDATE — it should only use `UPDATE ... RETURNING`
</verification>

<success_criteria>
- Migration file `0032_release_session_function.sql` created with `public.release_session(uuid) RETURNS int`
- Function uses `UPDATE ... WHERE sessions_used > 0 RETURNING sessions_used` — no intermediate SELECT
- `SECURITY DEFINER` set to match `use_session()` privilege model
- Migration applied to Supabase project ntqdmgvxirswnjlnwopq
</success_criteria>

<output>
After completion, create `.planning/phases/01-session-integrity/01-03-SUMMARY.md`
</output>
