---
milestone: v1.0
audited: 2026-02-26T00:00:00Z
status: gaps_found
scores:
  requirements: 14/15
  phases: 5/5
  integration: 6/7
  flows: 3/4
gaps:
  requirements:
    - id: "INFRA-02"
      status: "partial"
      phase: "05-production-hygiene"
      claimed_by_plans: ["05-02-PLAN.md"]
      completed_by_plans: ["05-02-SUMMARY.md"]
      verification_status: "passed"
      evidence: "Phase 5 rewired calendar, dashboard, cron-sms-reminders to booking_settings.timezone but intentionally excluded sms-worker. sms-worker/index.ts line 52 still reads sms_settings for timezone (used at line 80 for quiet hours). If trainer changes timezone in settings (which writes to booking_settings only), sms-worker quiet hours will silently use stale sms_settings.timezone."
  integration:
    - from: "settings/page.tsx"
      to: "sms-worker/index.ts quiet hours"
      issue: "Settings writes timezone to booking_settings. sms-worker reads from sms_settings. No sync between tables. Quiet hours timezone can drift from all other subsystems."
      requirement: "INFRA-02"
  flows:
    - flow: "Trainer changes org timezone in settings"
      breaks_at: "sms-worker quiet hours enforcement"
      issue: "Calendar confirmation SMS, dashboard, and cron reminders all use updated booking_settings.timezone. sms-worker quiet hours still uses old sms_settings.timezone. Same booking window may suppress/allow SMS differently across subsystems."
      requirement: "INFRA-02, SMS-03"
tech_debt:
  - phase: 01-session-integrity
    items:
      - "use_session() DB function (migration 0010) uses SELECT-then-UPDATE inside function body rather than single-statement atomic UPDATE. The UPDATE itself is row-atomic but the guard check (sessions_remaining <= 0) is not concurrency-safe under READ COMMITTED. Outside Phase 1 scope — Phase 1 moved deduction authority to the DB function; the internal implementation is a pre-existing issue."
  - phase: 04-ui-reliability
    items:
      - "clients/[id]/page.tsx has pre-existing TODO: Create Stripe Payment Link with alert('Payment link feature coming soon') at multiple lines. Unrelated to Phase 4 deliverables. Unbuilt feature placeholder."
  - phase: 02-sms-correctness
    items:
      - "Human verification pending: timezone in live SMS bodies, Y-reply with real Twilio, quiet hours reschedule at correct local time. All require live Twilio delivery — not automatable."
  - phases: "01-04"
    items:
      - "SUMMARY.md files for phases 1-4 missing requirements-completed frontmatter field. Phase 5 SUMMARYs have it. Documentation gap only — VERIFICATION.md files have full requirement evidence."
---

# Milestone v1.0 Audit Report

**Milestone:** v1.0 Stabilisation
**Audited:** 2026-02-26
**Status:** GAPS FOUND
**Requirements Score:** 14/15 satisfied | 1 partial

---

## Phase Verification Summary

| Phase | Status | Score | Critical Gaps |
|-------|--------|-------|---------------|
| 1: Session Integrity | PASSED | 7/7 | None |
| 2: SMS Correctness | PASSED | 9/9 | None (3 human-verify items pending) |
| 3: Background Jobs | PASSED | 7/7 | None |
| 4: UI Reliability | PASSED | 7/7 | None (4 human-verify items pending) |
| 5: Production Hygiene | PASSED | 5/5 | None flagged |

All 5 phases passed their individual verifications.

---

## Requirements Coverage (3-Source Cross-Reference)

| REQ-ID | VERIFICATION.md | SUMMARY Frontmatter | REQUIREMENTS.md | Final Status |
|--------|----------------|---------------------|-----------------|--------------|
| DATA-01 | SATISFIED (P1) | implied (P1 provides use_session) | [x] | **satisfied** |
| DATA-02 | SATISFIED (P1) | implied | [x] | **satisfied** |
| DATA-03 | SATISFIED (P1) | implied | [x] | **satisfied** |
| SMS-01 | SATISFIED (P2) | implied | [x] | **satisfied** |
| SMS-02 | SATISFIED (P2) | implied | [x] | **satisfied** |
| SMS-03 | SATISFIED (P2) | implied | [x] | **partial** — sms-worker quiet hours timezone source is sms_settings (see INFRA-02 gap) |
| SMS-04 | SATISFIED (P2) | implied | [x] | **satisfied** (boolean logic correct; dependent on SMS-03 timezone source) |
| SMS-05 | SATISFIED (P2) | implied | [x] | **satisfied** |
| CRON-01 | SATISFIED (P3) | listed in 03-01 | [x] | **satisfied** |
| CRON-02 | SATISFIED (P3) | listed in 03-01 | [x] | **satisfied** |
| STRIPE-01 | SATISFIED (P3) | implied | [x] | **satisfied** |
| UI-01 | SATISFIED (P4) | implied | [x] | **satisfied** |
| UI-02 | SATISFIED (P4) | implied | [x] | **satisfied** |
| INFRA-01 | SATISFIED (P5) | listed in 05-01 | [x] | **satisfied** |
| INFRA-02 | PASSED (P5) | listed in 05-02 | [x] | **partial** — sms-worker not rewired |

**Note on CRON-02:** Integration checker initially flagged `cron-sms-reminders/index.ts` as missing `automation_runs` writes. This is a false positive — CRON-02 scope is `cron-automations/index.ts`, confirmed by 03-01-SUMMARY.md `requirements-completed: [CRON-01, CRON-02]`. The two cron functions are independent.

---

## Integration Findings

### ✓ Wired Correctly

| Integration | Status | Evidence |
|-------------|--------|---------|
| use_session() → calendar auto-complete | WIRED | calendar/page.tsx line 294 calls `supabase.rpc("use_session", ...)` |
| use_session() → cron auto-complete | WIRED | cron-sms-reminders/index.ts line 59 calls `supabase.rpc("use_session", ...)` |
| release_session() → client detail reinstate | WIRED | clients/[id]/page.tsx line 2270 calls `supabase.rpc("release_session", ...)` |
| booking_settings.timezone → calendar confirmation SMS | WIRED | calendar/page.tsx lines 532-537 |
| booking_settings.timezone → cron pre-session + unconfirmed-24h reminders | WIRED | cron-sms-reminders lines 96-103, 339-346 |
| stripe-webhook idempotency → money_events | WIRED | stripe-webhook lines 237-248 select-before-insert |
| middleware auth → (app) routes | WIRED | middleware.ts redirect + x-user-id header intact |

### ⚠ Gap Found

**sms-worker quiet hours timezone source (INFRA-02, SMS-03)**

`supabase/functions/sms-worker/index.ts` line 52 fetches from `sms_settings` (not `booking_settings`). The `orgTimezone` at line 80 resolves to `settings.timezone || "Australia/Brisbane"` where `settings` came from `sms_settings`.

Phase 5 rewired all other consumers to `booking_settings.timezone`. The settings page writes to `booking_settings.timezone`. If a trainer changes their timezone:
- Calendar SMS, dashboard, cron reminders: use updated `booking_settings.timezone` ✓
- sms-worker quiet hours: still uses `sms_settings.timezone` (stale) ✗

**Note:** The Phase 5 planner intentionally excluded sms-worker, noting: "sms-worker reads sms_settings.timezone for quiet hours enforcement — this is intentionally kept as-is because quiet hours start/end only exist in sms_settings, not booking_settings." However, this means the quiet hours timezone can diverge from all other subsystems — directly violating INFRA-02's "not two divergent tables that can desync" requirement.

**Fix:** Apply the same dual-query pattern already used in cron-sms-reminders Section 1: fetch `sms_settings` for `enabled`, `quiet_hours_start`, `quiet_hours_end`; fetch `booking_settings` for `timezone`; merge before passing to `processSmsMessage`.

---

## Tech Debt (Non-Blocking)

1. **use_session() internal SELECT-then-UPDATE** (Phase 1): Pre-existing concurrency edge case in migration 0010. The DB function guards deductions but is not fully atomic under READ COMMITTED. Outside Phase 1 scope.

2. **Payment link TODO** (Phase 4): `alert("Payment link feature coming soon")` at multiple lines in clients/[id]/page.tsx. Pre-existing unbuilt feature, unrelated to phase deliverables.

3. **Human-verify items pending** (Phases 2, 4): Live Twilio SMS timezone, Y-reply round-trip, quiet hours reschedule, calendar poll range via devtools. All require live production testing.

4. **SUMMARY.md requirements-completed field** (Phases 1-4): Missing from most summaries. Phase 5 summaries have it. Documentation gap only.

---

## Verdict

**GAPS FOUND** — 1 requirement partially satisfied.

**Gap:** `sms-worker/index.ts` quiet hours timezone reads from `sms_settings` instead of `booking_settings`, creating a drift potential that violates INFRA-02.

**Scope of impact:** Quiet hours enforcement only. All other subsystems correctly use `booking_settings.timezone`. The gap only manifests if a trainer changes their timezone after deployment — until then, both tables likely have the same value.

**Recommended path:** Plan a gap closure for `sms-worker` timezone source, or accept as tech debt and proceed with milestone completion.

---

_Audited: 2026-02-26_
_Auditor: Claude (gsd-integration-checker + orchestrator)_
