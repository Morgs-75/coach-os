---
phase: 05-production-hygiene
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/trainer-web/src/app/(app)/calendar/page.tsx
  - apps/trainer-web/src/app/(app)/dashboard/page.tsx
  - supabase/functions/cron-sms-reminders/index.ts
autonomous: true
requirements:
  - INFRA-02

must_haves:
  truths:
    - "Changing timezone in settings is reflected in both booking confirmation SMS and reminder/follow-up SMS"
    - "All three subsystems (calendar confirmation, dashboard display, cron reminders) read timezone from booking_settings"
    - "sms-inbound Y-reply handler continues to read from booking_settings (already correct — no change)"
  artifacts:
    - path: "apps/trainer-web/src/app/(app)/calendar/page.tsx"
      provides: "Booking confirmation SMS using booking_settings.timezone"
      contains: "booking_settings"
    - path: "apps/trainer-web/src/app/(app)/dashboard/page.tsx"
      provides: "Dashboard date display using booking_settings.timezone"
      contains: "booking_settings"
    - path: "supabase/functions/cron-sms-reminders/index.ts"
      provides: "Cron SMS reminders using booking_settings.timezone"
      contains: "booking_settings"
  key_links:
    - from: "apps/trainer-web/src/app/(app)/settings/page.tsx"
      to: "booking_settings.timezone"
      via: "supabase .update({ timezone })"
      pattern: "booking_settings.*update.*timezone"
    - from: "apps/trainer-web/src/app/(app)/calendar/page.tsx"
      to: "booking_settings.timezone"
      via: "supabase .from('booking_settings').select('timezone')"
      pattern: "booking_settings.*select.*timezone"
    - from: "apps/trainer-web/src/app/(app)/dashboard/page.tsx"
      to: "booking_settings.timezone"
      via: "supabase .from('booking_settings').select('timezone')"
      pattern: "booking_settings.*select.*timezone"
    - from: "supabase/functions/cron-sms-reminders/index.ts"
      to: "booking_settings.timezone"
      via: "supabase .from('booking_settings').select('org_id, timezone')"
      pattern: "booking_settings.*timezone"
---

<objective>
Fix timezone divergence: change the three subsystems that incorrectly read org timezone from `sms_settings` to instead read from `booking_settings` — the canonical source where the settings page saves timezone changes.

Purpose: The settings page saves timezone to `booking_settings.timezone`. The calendar confirmation SMS, dashboard, and cron-sms-reminders all read from `sms_settings.timezone`. This means a timezone change in settings is silently ignored by SMS and dashboard. The fix aligns all consumers to the canonical source.
Output: All timezone reads across calendar, dashboard, and cron-sms-reminders point to `booking_settings.timezone`.
</objective>

<execution_context>
@C:/Users/Troy Morgan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Troy Morgan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@apps/trainer-web/src/app/(app)/calendar/page.tsx
@apps/trainer-web/src/app/(app)/dashboard/page.tsx
@supabase/functions/cron-sms-reminders/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix calendar page — read timezone from booking_settings</name>
  <files>apps/trainer-web/src/app/(app)/calendar/page.tsx</files>
  <action>
    In `apps/trainer-web/src/app/(app)/calendar/page.tsx`, find the timezone fetch inside `handleSaveBooking` (the section that builds the booking confirmation SMS). It currently reads:

    ```typescript
    const { data: smsSetting } = await supabase
      .from("sms_settings")
      .select("timezone")
      .eq("org_id", orgId)
      .maybeSingle();
    const orgTimezone = smsSetting?.timezone || "Australia/Brisbane";
    ```

    Change it to read from `booking_settings` instead:

    ```typescript
    const { data: bookingSetting } = await supabase
      .from("booking_settings")
      .select("timezone")
      .eq("org_id", orgId)
      .maybeSingle();
    const orgTimezone = bookingSetting?.timezone || "Australia/Brisbane";
    ```

    The variable name changes from `smsSetting` to `bookingSetting` to reflect the table. The `orgTimezone` variable name and the fallback `"Australia/Brisbane"` are preserved unchanged. No other logic in the file changes.

    Do NOT change the `sms_settings` reads elsewhere in the file (quiet hours logic, which legitimately reads from sms_settings for quiet_hours_start/quiet_hours_end).
  </action>
  <verify>
    <automated>grep -n "sms_settings" "apps/trainer-web/src/app/(app)/calendar/page.tsx" | grep "timezone"</automated>
    <manual>Confirm the grep above returns no output (no sms_settings timezone reads remain). Confirm `grep "booking_settings" apps/trainer-web/src/app/(app)/calendar/page.tsx` shows the new timezone fetch. Confirm `grep "orgTimezone" apps/trainer-web/src/app/(app)/calendar/page.tsx` still shows the timezone being used for dateStr/timeStr formatting.</manual>
  </verify>
  <done>
    `calendar/page.tsx` no longer reads `sms_settings.timezone` for the confirmation SMS. It reads `booking_settings.timezone` instead. The fallback and usage are unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix dashboard and cron-sms-reminders — read timezone from booking_settings</name>
  <files>
    apps/trainer-web/src/app/(app)/dashboard/page.tsx
    supabase/functions/cron-sms-reminders/index.ts
  </files>
  <action>
    **dashboard/page.tsx:**

    Find the timezone fetch in `apps/trainer-web/src/app/(app)/dashboard/page.tsx`:

    ```typescript
    const { data: smsSettings } = await supabase
      .from("sms_settings").select("timezone").eq("org_id", orgId).maybeSingle();
    const tz = smsSettings?.timezone || "Australia/Brisbane";
    ```

    Change to:

    ```typescript
    const { data: bookingSettings } = await supabase
      .from("booking_settings").select("timezone").eq("org_id", orgId).maybeSingle();
    const tz = bookingSettings?.timezone || "Australia/Brisbane";
    ```

    The `tz` variable name and fallback are preserved. No other logic changes.

    ---

    **cron-sms-reminders/index.ts:**

    The cron function fetches `sms_settings` in **three separate places** (one per section: pre-session reminders, post-session feedback, unconfirmed 24h reminders). Each select includes `timezone`. Change each to use `booking_settings` instead.

    **Section 1 — pre-session reminders** (around line 93-96):
    ```typescript
    const { data: settingsRows } = await supabase
      .from("sms_settings")
      .select("org_id, enabled, timezone")
      .in("org_id", orgIds);
    ```
    Change to:
    ```typescript
    const { data: smsRows } = await supabase
      .from("sms_settings")
      .select("org_id, enabled")
      .in("org_id", orgIds);
    const { data: tzRows } = await supabase
      .from("booking_settings")
      .select("org_id, timezone")
      .in("org_id", orgIds);
    const settingsMap = new Map((smsRows || []).map((s: any) => [s.org_id, {
      ...s,
      timezone: (tzRows || []).find((t: any) => t.org_id === s.org_id)?.timezone,
    }]));
    ```
    Remove the old `settingsMap` construction (the line that mapped `settingsRows`). The `settingsMap` variable retains its name so all downstream code referencing `settingsMap.get(booking.org_id)` and `settings.enabled` / `settings.timezone` works unchanged.

    **Section 2 — post-session feedback** (around line 189-193):
    The second `settingsRows` fetch only selects `org_id, enabled` (no `timezone`) — post-session follow-up SMS body does not include formatted times (per Phase 02 audit). So for this section, only change is cosmetic: if the select already omits `timezone`, leave it as-is. Confirm by checking the actual select — if it reads `"org_id, enabled"` without `timezone`, no change is needed here.

    **Section 3 — unconfirmed 24h reminders** (around line 329-332):
    ```typescript
    const { data: unconfirmedSettings } = await supabase
      .from("sms_settings")
      .select("org_id, enabled, timezone")
      .in("org_id", unconfirmedOrgIds);
    const unconfirmedSettingsMap = new Map((unconfirmedSettings || []).map((s: any) => [s.org_id, s]));
    ```
    Change to:
    ```typescript
    const { data: unconfirmedSmsRows } = await supabase
      .from("sms_settings")
      .select("org_id, enabled")
      .in("org_id", unconfirmedOrgIds);
    const { data: unconfirmedTzRows } = await supabase
      .from("booking_settings")
      .select("org_id, timezone")
      .in("org_id", unconfirmedOrgIds);
    const unconfirmedSettingsMap = new Map((unconfirmedSmsRows || []).map((s: any) => [s.org_id, {
      ...s,
      timezone: (unconfirmedTzRows || []).find((t: any) => t.org_id === s.org_id)?.timezone,
    }]));
    ```

    Key points:
    - `sms_settings` selects for `enabled` are kept — this flag lives only in `sms_settings` and must not be moved
    - `booking_settings` is queried separately for `timezone` only
    - The shape of objects returned from `settingsMap.get()` is preserved: `{ org_id, enabled, timezone }` — so all downstream `settings.enabled` and `settings.timezone` references work without change
    - The fallback `settings.timezone || "Australia/Brisbane"` in the body code remains unchanged
  </action>
  <verify>
    <automated>grep -n "sms_settings" "supabase/functions/cron-sms-reminders/index.ts" | grep "timezone"</automated>
    <manual>
      1. The grep above should return no output — no `sms_settings` selects should include `timezone` any more.
      2. `grep -c "booking_settings" supabase/functions/cron-sms-reminders/index.ts` should return 2 (pre-session + unconfirmed sections).
      3. `grep -c "booking_settings" apps/trainer-web/src/app/(app)/dashboard/page.tsx` should return 1.
      4. All `settings.enabled` and `settings.timezone` references downstream of the changed settingsMaps should still compile — verify with `cd apps/trainer-web && npx tsc --noEmit 2>&1 | head -20`.
    </manual>
  </verify>
  <done>
    - `dashboard/page.tsx` reads timezone from `booking_settings.timezone`
    - `cron-sms-reminders/index.ts` reads timezone from `booking_settings.timezone` for both the pre-session reminder section and the unconfirmed 24h section
    - `sms_settings` is still queried for `enabled` (and quiet hours in sms-worker — which is unrelated and unchanged)
    - No sms_settings select anywhere in these files includes `timezone` any more
  </done>
</task>

</tasks>

<verification>
After execution:
1. `grep -rn "sms_settings.*timezone\|timezone.*sms_settings" apps/trainer-web/src/app/\(app\)/calendar/page.tsx apps/trainer-web/src/app/\(app\)/dashboard/page.tsx supabase/functions/cron-sms-reminders/index.ts` — returns no output
2. `grep -rn "booking_settings.*timezone\|timezone.*booking_settings" apps/trainer-web/src/app/\(app\)/calendar/page.tsx apps/trainer-web/src/app/\(app\)/dashboard/page.tsx supabase/functions/cron-sms-reminders/index.ts` — returns at least 3 matches (one per file)
3. TypeScript check: `cd apps/trainer-web && npx tsc --noEmit 2>&1 | head -20` — no new errors
4. `sms-inbound/route.ts` already reads from `booking_settings` — confirm unchanged: `grep "booking_settings" apps/trainer-web/src/app/api/sms-inbound/route.ts`
</verification>

<success_criteria>
- All four timezone consumers (calendar confirmation SMS, dashboard date display, cron pre-session reminders, cron unconfirmed 24h reminders) read timezone from `booking_settings.timezone`
- A trainer changing their timezone in settings will see the new timezone reflected in both booking confirmation SMS (calendar) and reminder/follow-up SMS (cron) — the same time value appears in both
- `sms_settings.enabled` and quiet hours fields are still read from `sms_settings` (they are not in booking_settings)
</success_criteria>

<output>
After completion, create `.planning/phases/05-production-hygiene/05-02-SUMMARY.md`
</output>
