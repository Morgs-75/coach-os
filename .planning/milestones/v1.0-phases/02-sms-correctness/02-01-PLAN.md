---
phase: 02-sms-correctness
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/trainer-web/src/app/(app)/calendar/page.tsx
  - supabase/functions/cron-sms-reminders/index.ts
autonomous: true
requirements:
  - SMS-01
  - SMS-02

must_haves:
  truths:
    - "Booking confirmation SMS shows session time in the org's configured timezone (sms_settings.timezone), not the trainer's browser timezone"
    - "Pre-session reminder SMS from the cron job shows session time in the org's configured timezone consistently"
    - "Both confirmation and reminder SMS use the same timezone source (sms_settings.timezone)"
  artifacts:
    - path: "apps/trainer-web/src/app/(app)/calendar/page.tsx"
      provides: "Booking confirmation SMS with org-timezone-formatted date/time"
      contains: "sms_settings"
    - path: "supabase/functions/cron-sms-reminders/index.ts"
      provides: "Pre-session reminder SMS with org-timezone-formatted date/time"
      contains: "settings.timezone"
  key_links:
    - from: "apps/trainer-web/src/app/(app)/calendar/page.tsx"
      to: "sms_settings table"
      via: "supabase query inside handleSaveBooking"
      pattern: "sms_settings.*timezone"
    - from: "supabase/functions/cron-sms-reminders/index.ts"
      to: "sms_settings.timezone"
      via: "settingsMap lookup in booking loop"
      pattern: "settings\\.timezone"
---

<objective>
Fix booking confirmation SMS to use the org's configured timezone (from sms_settings) instead of the trainer's browser locale, and verify that the cron reminder path already correctly uses the same timezone source.

Purpose: A trainer in a different timezone from their clients currently sends confirmation SMS with times formatted in the wrong zone. Both the confirmation path (calendar page) and the reminder path (cron function) must format session times using the same canonical source: sms_settings.timezone.

Output: calendar/page.tsx fetches sms_settings.timezone and passes it to Intl.DateTimeFormat when building the confirmation message body; cron-sms-reminders/index.ts is verified to already use settings.timezone correctly (no code change needed, or trivial patch if a gap is found).
</objective>

<execution_context>
@C:/Users/Troy Morgan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Troy Morgan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/trainer-web/src/app/(app)/calendar/page.tsx
@supabase/functions/cron-sms-reminders/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fetch org timezone in calendar and use it when building the confirmation SMS body</name>
  <files>apps/trainer-web/src/app/(app)/calendar/page.tsx</files>
  <action>
In `handleSaveBooking` (around line 499), after the booking insert succeeds and before building the SMS message body, fetch the org's timezone from `sms_settings`:

```ts
const { data: smsSetting } = await supabase
  .from("sms_settings")
  .select("timezone")
  .eq("org_id", orgId)
  .maybeSingle();
const orgTimezone = smsSetting?.timezone || "Australia/Brisbane";
```

Then replace the two lines that format `dateStr` and `timeStr` (currently lines ~509-510):

BEFORE:
```ts
const dateStr = startTime.toLocaleDateString("en-AU", { weekday: "long", day: "numeric", month: "long" });
const timeStr = startTime.toLocaleTimeString("en-AU", { hour: "2-digit", minute: "2-digit", hour12: true });
```

AFTER:
```ts
const dateStr = startTime.toLocaleDateString("en-AU", { weekday: "long", day: "numeric", month: "long", timeZone: orgTimezone });
const timeStr = startTime.toLocaleTimeString("en-AU", { hour: "2-digit", minute: "2-digit", hour12: true, timeZone: orgTimezone });
```

The `supabase` client and `orgId` state variable are already in scope at this point in the function. Do NOT restructure the function — add only the minimal fetch before the existing `dateStr`/`timeStr` assignments.

Do NOT change anything else in `handleSaveBooking` or elsewhere in the file.
  </action>
  <verify>
    <automated>cd "C:/Users/Troy Morgan/OneDrive/coach-os/apps/trainer-web" && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>Grep confirms the change: grep -n "sms_settings\|orgTimezone\|timeZone: org" apps/trainer-web/src/app/\(app\)/calendar/page.tsx</manual>
  </verify>
  <done>calendar/page.tsx compiles without new TypeScript errors; the confirmation SMS body construction uses orgTimezone fetched from sms_settings in both toLocaleDateString and toLocaleTimeString calls</done>
</task>

<task type="auto">
  <name>Task 2: Verify cron reminder path uses sms_settings.timezone (SMS-02)</name>
  <files>supabase/functions/cron-sms-reminders/index.ts</files>
  <action>
Read `supabase/functions/cron-sms-reminders/index.ts` carefully and verify that the pre-session reminder loop already uses `settings.timezone` when formatting session times (confirmed at lines 120-127 in the current file).

Confirm the pattern:
- `const tz = settings.timezone || "Australia/Brisbane";`
- `sessionDate.toLocaleDateString("en-AU", { ..., timeZone: tz })`
- `sessionDate.toLocaleTimeString("en-AU", { ..., timeZone: tz })`

These lines are correct and require NO changes.

Similarly verify the post-session (follow-up) loop uses the same `tz` variable from the same `sms_settings` record. If it does, make no changes. If the follow-up loop is missing `timeZone: tz` in its date/time formatting, add it using the same pattern.

Make only minimal targeted changes. Do NOT restructure the file or add new functionality.
  </action>
  <verify>
    <automated>grep -n "timeZone\|settings.timezone\|tz =" "C:/Users/Troy Morgan/OneDrive/coach-os/supabase/functions/cron-sms-reminders/index.ts"</automated>
    <manual>Confirm every toLocaleDateString / toLocaleTimeString call in cron-sms-reminders includes timeZone: tz</manual>
  </verify>
  <done>Every date/time formatting call in cron-sms-reminders passes timeZone from sms_settings.timezone; no call uses implicit browser/server locale</done>
</task>

</tasks>

<verification>
1. TypeScript build passes: `cd apps/trainer-web && npx tsc --noEmit` — zero new errors
2. Both files format dates with explicit timeZone option sourced from sms_settings.timezone
3. The calendar page does not reference toLocaleDateString or toLocaleTimeString without a timeZone option in the SMS body construction path
</verification>

<success_criteria>
- SMS-01: calendar/page.tsx builds confirmation SMS body using orgTimezone from sms_settings, not browser locale
- SMS-02: cron-sms-reminders/index.ts formats all session times with timeZone: tz where tz comes from sms_settings.timezone
- Zero TypeScript errors introduced
- No structural changes to either file beyond the targeted lines
</success_criteria>

<output>
After completion, create `.planning/phases/02-sms-correctness/02-01-SUMMARY.md`
</output>
