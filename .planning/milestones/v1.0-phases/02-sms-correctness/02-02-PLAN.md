---
phase: 02-sms-correctness
plan: "02"
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/sms-worker/index.ts
autonomous: true
requirements:
  - SMS-03
  - SMS-04

must_haves:
  truths:
    - "Messages are not sent during the org's configured quiet hours window, evaluated in org local time (not UTC)"
    - "A non-wraparound quiet hours window (e.g. 9 AM–9 PM: start < end) suppresses messages only during that window, not outside it"
    - "A wraparound quiet hours window (e.g. 9 PM–8 AM: start > end) suppresses messages correctly across midnight"
    - "When a message is suppressed, it is rescheduled to quiet_hours_end using an org-local date string construction (not setUTCHours), so the reschedule time is correct in the org's timezone"
  artifacts:
    - path: "supabase/functions/sms-worker/index.ts"
      provides: "Quiet hours enforcement in org local timezone with correct boolean logic and org-local reschedule"
      contains: "Intl.DateTimeFormat"
  key_links:
    - from: "supabase/functions/sms-worker/index.ts"
      to: "sms_settings.timezone"
      via: "settingsMap lookup per message org_id"
      pattern: "settings\\.timezone"
    - from: "supabase/functions/sms-worker/index.ts"
      to: "quiet_hours_start / quiet_hours_end comparison"
      via: "converted org-local hour"
      pattern: "hour >= settings\\.quiet_hours_start && hour < settings\\.quiet_hours_end"
---

<objective>
Fix two bugs in the sms-worker quiet hours enforcement: (1) convert current time to org local timezone before extracting the hour, and (2) fix the boolean logic so non-wraparound ranges are suppressed correctly. Also fix the reschedule time to be computed in org local time, not UTC.

Purpose: The sms-worker currently evaluates quiet hours against UTC time, and the logic for non-wraparound ranges is inverted (uses || instead of &&), meaning quiet hours are never enforced correctly for Australian orgs using a standard 9 PM–8 AM window. Messages are being sent at 3 AM local time. Additionally, the reschedule uses setUTCHours which sets the wakeup time in UTC, causing a 10-11 hour error for Australian orgs.

Output: sms-worker/index.ts quiet hours block uses Intl.DateTimeFormat to extract the org-local hour, the condition correctly handles both non-wraparound (start < end, use &&) and wraparound (start > end, use ||) ranges, and the reschedule time is built from the org-local date string so it lands at the correct local time.
</objective>

<execution_context>
@C:/Users/Troy Morgan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Troy Morgan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/functions/sms-worker/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix quiet hours timezone conversion, boolean logic, and reschedule calculation in sms-worker</name>
  <files>supabase/functions/sms-worker/index.ts</files>
  <action>
In `processSmsMessage`, replace the broken quiet hours block (lines 82–104 in the current file) with a corrected version.

CURRENT (broken):
```ts
const now = new Date();
const hour = now.getHours(); // TODO: Convert to org timezone

if (
  settings.quiet_hours_start < settings.quiet_hours_end &&
  (hour >= settings.quiet_hours_start || hour < settings.quiet_hours_end)
) {
  // Reschedule to quiet_hours_end
  const nextSend = new Date(now);
  nextSend.setHours(settings.quiet_hours_end, 0, 0, 0);
  if (nextSend <= now) nextSend.setDate(nextSend.getDate() + 1);
  ...
}
```

REPLACEMENT:
```ts
const now = new Date();

// Fix SMS-03: Convert to org timezone before extracting hour
const orgTimezone = settings.timezone || "Australia/Brisbane";
const localHourStr = new Intl.DateTimeFormat("en-AU", {
  timeZone: orgTimezone,
  hour: "numeric",
  hour12: false,
}).format(now);
const hour = parseInt(localHourStr, 10);

// Fix SMS-04: Correct boolean logic
// Non-wraparound (start < end, e.g. 9 AM–5 PM): suppress when hour is inside the window
// Wraparound (start > end, e.g. 9 PM–8 AM): suppress when hour >= start OR hour < end
const isQuietHour =
  settings.quiet_hours_start < settings.quiet_hours_end
    ? hour >= settings.quiet_hours_start && hour < settings.quiet_hours_end
    : hour >= settings.quiet_hours_start || hour < settings.quiet_hours_end;

if (isQuietHour) {
  // Reschedule to quiet_hours_end in org local time.
  // Use en-CA locale (returns YYYY-MM-DD) to get today's date in the org timezone,
  // then construct an ISO-like string at quiet_hours_end hour.
  // NOTE: new Date("YYYY-MM-DDTHH:00:00") is parsed as LOCAL time in most JS engines,
  // but Deno edge functions run in UTC. To correctly anchor the time to org local midnight,
  // we compute the UTC offset and apply it explicitly.
  const todayInOrg = new Intl.DateTimeFormat("en-CA", {
    timeZone: orgTimezone,
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
  }).format(now); // Returns "YYYY-MM-DD" in org local date

  // Build the target time as org-local and convert to UTC by using the offset between
  // org-local midnight and UTC midnight. The safest portable approach is to compare
  // the org-local date components to a UTC-constructed date.
  //
  // Concrete approach: construct the ISO string with a Z suffix by computing the offset.
  // Get org-local date components for "now" using Intl.DateTimeFormat parts:
  const parts = new Intl.DateTimeFormat("en-AU", {
    timeZone: orgTimezone,
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    hour12: false,
  }).formatToParts(now);
  const get = (type: string) => parseInt(parts.find(p => p.type === type)?.value ?? "0", 10);
  // UTC epoch for org-local "now" (treating components as if UTC):
  const orgLocalAsUtcMs = Date.UTC(get("year"), get("month") - 1, get("day"), get("hour"), get("minute"), get("second"));
  // Offset in ms: positive means org is ahead of UTC (e.g. Australia/Brisbane is +10h = +36000000ms)
  const offsetMs = orgLocalAsUtcMs - now.getTime();

  // Build org-local wakeup time as a "fake UTC" date, then subtract offset to get real UTC
  const wakeupOrgLocalMs = Date.UTC(
    parseInt(todayInOrg.slice(0, 4), 10),
    parseInt(todayInOrg.slice(5, 7), 10) - 1,
    parseInt(todayInOrg.slice(8, 10), 10),
    settings.quiet_hours_end,
    0,
    0,
    0
  );
  const nextSend = new Date(wakeupOrgLocalMs - offsetMs);

  // If the wakeup time is in the past (already past quiet_hours_end today), advance one day
  if (nextSend.getTime() <= now.getTime()) {
    nextSend.setUTCDate(nextSend.getUTCDate() + 1);
  }

  await supabase
    .from("sms_messages")
    .update({
      status: "queued",
      scheduled_for: nextSend.toISOString(),
      locked_until: null
    })
    .eq("id", message.id);

  return;
}
```

Use the REPLACEMENT above verbatim. Do NOT change anything else in the file. The `settings` variable is already in scope (set before the quiet hours block in the current file). The `orgTimezone`, `localHourStr`, `hour`, `isQuietHour`, `todayInOrg`, `parts`, `get`, `orgLocalAsUtcMs`, `offsetMs`, `wakeupOrgLocalMs`, and `nextSend` variables are all new and scoped to this block.
  </action>
  <verify>
    <automated>grep -n "Intl.DateTimeFormat\|isQuietHour\|hour12: false\|quiet_hours_start && hour\|wakeupOrgLocalMs\|offsetMs" "C:/Users/Troy Morgan/OneDrive/coach-os/supabase/functions/sms-worker/index.ts"</automated>
    <manual>Confirm the old "TODO: Convert to org timezone" comment is gone, the old || logic is gone, and the old setUTCHours reschedule is gone</manual>
  </verify>
  <done>sms-worker/index.ts uses Intl.DateTimeFormat with org timezone to extract local hour; quiet hours condition uses && for non-wraparound and || for wraparound; reschedule time is computed using org-local date components and UTC offset arithmetic so the wakeup time is correct in the org's timezone; the old TODO comment is removed</done>
</task>

</tasks>

<verification>
1. File no longer contains: `now.getHours() // TODO`
2. File no longer contains: `setUTCHours(settings.quiet_hours_end`
3. File contains: `Intl.DateTimeFormat` with org timezone (for both hour extraction and date string)
4. File contains: `isQuietHour` with branched `&&` / `||` logic
5. File contains: `wakeupOrgLocalMs` and `offsetMs` (org-local reschedule computation)
6. Deno typecheck (if available): `deno check supabase/functions/sms-worker/index.ts`
</verification>

<success_criteria>
- SMS-03: Quiet hours enforcement uses org local hour (via Intl.DateTimeFormat with sms_settings.timezone), not UTC getHours()
- SMS-04: Non-wraparound window (start < end) uses && to suppress only inside the window; wraparound window (start > end) uses || correctly
- Reschedule: next_send time is computed using org-local date components and UTC offset subtraction, so the wakeup lands at quiet_hours_end in the org's local timezone (not UTC)
- No other changes to sms-worker/index.ts
</success_criteria>

<output>
After completion, create `.planning/phases/02-sms-correctness/02-02-SUMMARY.md`
</output>
